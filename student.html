<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>í•™ìƒ í˜ì´ì§€</title>
  
  <!-- PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f59e0b">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{font-family:-apple-system,'Malgun Gothic',sans-serif;box-sizing:border-box}
  </style>
</head>
<body class="bg-gray-50">
<div id="app"></div>
<script>
const SUPABASE_URL = 'https://sniabexwdgeepakkxxek.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuaWFiZXh3ZGdlZXBha2t4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MDMxNzIsImV4cCI6MjA4NTA3OTE3Mn0.RsDQDyawjFk5voFLVouXDlTIXvhPrsziCD37ne-1jMU';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const urlParams = new URLSearchParams(window.location.search);
const academyId = urlParams.get('academy');

let page = 'login';
let academy = null;
let student = null;
let tab = 'home';
let homework = [];
let attendance = [];
let notices = [];
let ranking = [];
let loading = false;

// ì¿ íŒ¡ ê´‘ê³  ë¡œì§
function getCoupangRate() {
  const today = new Date();
  const seed = today.getFullYear() * 10000 + (today.getMonth()+1) * 100 + today.getDate();
  const x = Math.sin(seed) * 10000;
  const rand = x - Math.floor(x);
  return 3 + rand * 7;
}

function tryCoupangCookie() {
  const rate = getCoupangRate();
  if (Math.random() * 100 < rate) {
    window.open('https://link.coupang.com/a/example', '_blank');
  }
}

async function init() {
  if (!academyId) {
    document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center text-gray-500">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</div>';
    return;
  }
  
  const { data } = await db.from('academies').select('*').eq('id', academyId).single();
  if (!data) {
    document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center text-gray-500">í•™ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  academy = data;
  render();
}

async function login() {
  const phone = document.getElementById('phone').value.trim();
  if (phone.length !== 4) {
    alert('ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  loading = true;
  render();
  
  const { data, error } = await db.from('students')
    .select('*')
    .eq('academy_id', academyId)
    .like('phone', `%${phone}`)
    .single();
  
  if (error || !data) {
    alert('ë“±ë¡ëœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    loading = false;
    render();
    return;
  }
  
  student = data;
  tryCoupangCookie();
  
  await loadData();
  loading = false;
  page = 'main';
  render();
}

async function loadData() {
  const { data: hw } = await db.from('homework').select('*').eq('student_id', student.id).order('created_at', { ascending: false });
  homework = hw || [];
  
  const { data: a } = await db.from('attendance').select('*').eq('student_id', student.id).order('date', { ascending: false }).limit(30);
  attendance = a || [];
  
  const { data: n } = await db.from('notices').select('*').eq('academy_id', academyId).order('created_at', { ascending: false }).limit(5);
  notices = n || [];
  
  // ë­í‚¹ (ì „ì²´ í•™ìƒ)
  const { data: all } = await db.from('students').select('id,name,points').eq('academy_id', academyId).order('points', { ascending: false }).limit(10);
  ranking = all || [];
}

function render() {
  const app = document.getElementById('app');
  
  if (page === 'login') {
    app.innerHTML = renderLogin();
  } else {
    app.innerHTML = renderMain();
  }
}

function renderLogin() {
  return `
    <div class="min-h-screen flex flex-col">
      <!-- ê´‘ê³  -->
      <div class="bg-amber-50 p-3 text-center text-sm">
        <a href="https://link.coupang.com/a/example" target="_blank" class="text-amber-800">
          ğŸ® ê²Œì„/ì·¨ë¯¸ìš©í’ˆ ì¿ íŒ¡ì—ì„œ í™•ì¸!
        </a>
      </div>
      
      <div class="flex-1 flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
          <div class="text-center mb-8">
            <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span class="text-4xl">ğŸ‘¦</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">${academy?.name || 'í•™ì›'}</h1>
            <p class="text-gray-500 mt-1">í•™ìƒ í˜ì´ì§€</p>
          </div>
          
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <label class="text-sm text-gray-600 block mb-2">ë‚´ ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬</label>
            <input type="tel" id="phone" maxlength="4" placeholder="0000" 
              class="w-full text-center text-3xl tracking-widest py-4 border-2 rounded-xl focus:border-amber-500 focus:outline-none"
              onkeypress="if(event.key==='Enter')login()">
            <button onclick="login()" 
              class="w-full mt-4 py-4 bg-amber-500 text-white font-bold rounded-xl hover:bg-amber-600 transition-colors"
              ${loading ? 'disabled' : ''}>
              ${loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸'}
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderMain() {
  const tabs = [
    { id: 'home', icon: 'ğŸ ', label: 'í™ˆ' },
    { id: 'homework', icon: 'ğŸ“', label: 'ìˆ™ì œ' },
    { id: 'attendance', icon: 'ğŸ“…', label: 'ì¶œê²°' },
    { id: 'ranking', icon: 'ğŸ†', label: 'ë­í‚¹' }
  ];
  
  let h = `
    <div class="min-h-screen pb-20">
      <!-- í—¤ë” -->
      <div class="bg-gradient-to-r from-amber-400 to-orange-400 text-white p-4">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-sm opacity-80">${academy.name}</div>
            <div class="text-xl font-bold">${student.name} ğŸ‘‹</div>
          </div>
          <div class="text-right">
            <div class="text-sm opacity-80">ë‚´ í¬ì¸íŠ¸</div>
            <div class="text-2xl font-bold">${student.points || 0}ì </div>
          </div>
        </div>
      </div>
  `;
  
  // í™ˆ
  if (tab === 'home') {
    const todayAtt = attendance[0];
    const pendingHw = homework.filter(h => !h.done).length;
    const myRank = ranking.findIndex(r => r.id === student.id) + 1;
    
    h += `
      <div class="p-4 space-y-4">
        <!-- ì˜¤ëŠ˜ ìƒíƒœ -->
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-white rounded-2xl p-4 shadow-sm text-center">
            <div class="text-3xl mb-2">${todayAtt ? 'âœ…' : 'â°'}</div>
            <div class="text-sm text-gray-500">ì˜¤ëŠ˜ ì¶œê²°</div>
            <div class="font-bold">${todayAtt ? todayAtt.status : 'ë¯¸ì¶œì„'}</div>
          </div>
          <div class="bg-white rounded-2xl p-4 shadow-sm text-center">
            <div class="text-3xl mb-2">ğŸ“</div>
            <div class="text-sm text-gray-500">ë‚¨ì€ ìˆ™ì œ</div>
            <div class="font-bold">${pendingHw}ê°œ</div>
          </div>
        </div>
        
        <!-- ë‚´ ë­í‚¹ -->
        <div class="bg-gradient-to-r from-yellow-400 to-amber-400 rounded-2xl p-5 text-white">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm opacity-90">ì¶œì„ í¬ì¸íŠ¸ ë­í‚¹</div>
              <div class="text-4xl font-bold mt-1">${myRank > 0 ? myRank + 'ìœ„' : '-'}</div>
            </div>
            <div class="text-6xl">${myRank === 1 ? 'ğŸ¥‡' : myRank === 2 ? 'ğŸ¥ˆ' : myRank === 3 ? 'ğŸ¥‰' : 'ğŸ†'}</div>
          </div>
        </div>
        
        <!-- ê³µì§€ì‚¬í•­ -->
        <div class="bg-white rounded-2xl p-4 shadow-sm">
          <h3 class="font-bold mb-3">ğŸ“¢ ê³µì§€ì‚¬í•­</h3>
          ${notices.length 
            ? notices.slice(0, 2).map(n => `
                <div class="py-2 border-b last:border-0">
                  <div class="font-medium text-sm">${n.title}</div>
                  <div class="text-xs text-gray-400">${new Date(n.created_at).toLocaleDateString('ko-KR')}</div>
                </div>
              `).join('')
            : '<p class="text-gray-400 text-sm">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>'
          }
        </div>
      </div>
    `;
  }
  
  // ìˆ™ì œ
  else if (tab === 'homework') {
    h += `
      <div class="p-4">
        <h2 class="font-bold text-lg mb-4">ğŸ“ ìˆ™ì œ</h2>
        <div class="space-y-3">
          ${homework.length
            ? homework.map(hw => `
                <div class="bg-white rounded-2xl p-4 shadow-sm flex items-center gap-4">
                  <button onclick="toggleHomework('${hw.id}')" class="w-8 h-8 rounded-full border-2 flex items-center justify-center ${hw.done ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300'}">
                    ${hw.done ? 'âœ“' : ''}
                  </button>
                  <div class="flex-1 ${hw.done ? 'line-through text-gray-400' : ''}">
                    <div class="font-medium">${hw.title}</div>
                    <div class="text-xs text-gray-400">${hw.due_date || ''}</div>
                  </div>
                </div>
              `).join('')
            : '<p class="text-gray-400 text-center py-8">ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ‰</p>'
          }
        </div>
      </div>
    `;
  }
  
  // ì¶œê²°
  else if (tab === 'attendance') {
    const totalDays = attendance.length;
    const presentDays = attendance.filter(a => a.status === 'ì¶œì„').length;
    const rate = totalDays > 0 ? Math.round(presentDays / totalDays * 100) : 0;
    
    h += `
      <div class="p-4">
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <div class="text-center">
            <div class="text-5xl font-bold text-amber-500">${rate}%</div>
            <div class="text-gray-500 mt-1">ì¶œì„ë¥  (${presentDays}/${totalDays}ì¼)</div>
          </div>
        </div>
        
        <h2 class="font-bold text-lg mb-3">ì¶œê²° ê¸°ë¡</h2>
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
          ${attendance.length
            ? attendance.slice(0, 10).map(a => `
                <div class="flex items-center justify-between p-3 border-b">
                  <div class="text-sm">${a.date}</div>
                  <span class="px-2 py-1 rounded text-xs ${a.status === 'ì¶œì„' ? 'bg-emerald-100 text-emerald-700' : a.status === 'ì§€ê°' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">
                    ${a.status}
                  </span>
                </div>
              `).join('')
            : '<p class="p-4 text-gray-400 text-center">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>'
          }
        </div>
      </div>
    `;
  }
  
  // ë­í‚¹
  else if (tab === 'ranking') {
    h += `
      <div class="p-4">
        <h2 class="font-bold text-lg mb-4">ğŸ† ì¶œì„ í¬ì¸íŠ¸ ë­í‚¹</h2>
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
          ${ranking.map((r, i) => {
            const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}`;
            const isMe = r.id === student.id;
            return `
              <div class="flex items-center gap-4 p-4 border-b ${isMe ? 'bg-amber-50' : ''} ${i < 3 ? 'bg-yellow-50' : ''}">
                <div class="w-8 text-center font-bold ${i < 3 ? 'text-2xl' : ''}">${medal}</div>
                <div class="flex-1">
                  <span class="font-medium">${r.name}</span>
                  ${isMe ? '<span class="ml-2 text-xs bg-amber-500 text-white px-2 py-0.5 rounded">ë‚˜</span>' : ''}
                </div>
                <div class="font-bold text-amber-600">${r.points || 0}ì </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }
  
  // í•˜ë‹¨ íƒ­
  h += `
      <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex">
        ${tabs.map(t => `
          <button onclick="tab='${t.id}';render()" class="flex-1 py-3 text-center ${tab === t.id ? 'text-amber-500' : 'text-gray-400'}">
            <div class="text-xl">${t.icon}</div>
            <div class="text-xs">${t.label}</div>
          </button>
        `).join('')}
      </nav>
    </div>
  `;
  
  return h;
}

async function toggleHomework(id) {
  const hw = homework.find(h => h.id === id);
  if (!hw) return;
  
  await db.from('homework').update({ done: !hw.done }).eq('id', id);
  await loadData();
  render();
}

function logout() {
  student = null;
  page = 'login';
  tab = 'home';
  render();
}

init();
</script>
</body>
</html>
