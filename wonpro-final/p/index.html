<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>í•™ë¶€ëª¨ í˜ì´ì§€</title>
  
  <!-- PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#10b981">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{font-family:-apple-system,'Malgun Gothic',sans-serif;box-sizing:border-box}
    .tab-active{color:#10b981;border-bottom:2px solid #10b981}
  </style>
</head>
<body class="bg-gray-50">
<div id="app"></div>
<script>
const SUPABASE_URL = 'https://sniabexwdgeepakkxxek.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuaWFiZXh3ZGdlZXBha2t4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MDMxNzIsImV4cCI6MjA4NTA3OTE3Mn0.RsDQDyawjFk5voFLVouXDlTIXvhPrsziCD37ne-1jMU';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// URLì—ì„œ í•™ì› ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (wonpro.pages.dev/p/ABC123)
const pathParts = window.location.pathname.split('/');
const academyCode = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

let page = 'login';
let academy = null;
let student = null;
let tab = 'home';
let notices = [];
let attendance = [];
let photos = [];
let reports = [];
let makeups = [];
let consults = [];
let loading = false;

// ì¿ íŒ¡ ê´‘ê³  ë¡œì§ (3~10% ëœë¤)
function getCoupangRate() {
  const today = new Date();
  const seed = today.getFullYear() * 10000 + (today.getMonth()+1) * 100 + today.getDate();
  const x = Math.sin(seed) * 10000;
  const rand = x - Math.floor(x);
  return 3 + rand * 7; // 3.xx ~ 9.xx%
}

function tryCoupangCookie(categories) {
  const rate = getCoupangRate();
  if (Math.random() * 100 < rate) {
    // ì¹´í…Œê³ ë¦¬ë³„ ì¿ íŒ¡ ë§í¬ (ì¶”í›„ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°)
    const defaultUrl = 'https://link.coupang.com/a/example';
    window.open(defaultUrl, '_blank');
  }
}

// ì´ˆê¸°í™”
async function init() {
  if (!academyCode || academyCode === 'p') {
    document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center text-gray-500">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</div>';
    return;
  }
  
  const { data } = await db.from('academies').select('*').eq('code', academyCode).single();
  if (!data) {
    document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center text-gray-500">í•™ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  academy = data;
  render();
}

// ë¡œê·¸ì¸
async function login() {
  const phone = document.getElementById('phone').value.trim();
  if (phone.length !== 4) {
    alert('ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  loading = true;
  render();
  
  const { data, error } = await db.from('students')
    .select('*')
    .eq('academy_id', academy.id)
    .like('pPhone', `%${phone}`)
    .single();
  
  if (error || !data) {
    alert('ë“±ë¡ëœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    loading = false;
    render();
    return;
  }
  
  student = data;
  
  // ì¿ íŒ¡ ì¿ í‚¤ ì‹¬ê¸° ì‹œë„
  tryCoupangCookie(academy.categories);
  
  await loadData();
  loading = false;
  page = 'main';
  render();
}

// ë°ì´í„° ë¡œë“œ
async function loadData() {
  const { data: n } = await db.from('notices').select('*').eq('academy_id', academy.id).order('created_at', { ascending: false }).limit(10);
  notices = n || [];
  
  const { data: a } = await db.from('attendance').select('*').eq('student_id', student.id).order('date', { ascending: false }).limit(30);
  attendance = a || [];
  
  const { data: p } = await db.from('photos').select('*').eq('student_id', student.id).order('created_at', { ascending: false });
  photos = p || [];
  
  const { data: r } = await db.from('reports').select('*').eq('student_id', student.id).order('created_at', { ascending: false });
  reports = r || [];
  
  const { data: m } = await db.from('makeups').select('*').eq('student_id', student.id).order('created_at', { ascending: false });
  makeups = m || [];
  
  const { data: c } = await db.from('consults').select('*').eq('student_id', student.id).order('created_at', { ascending: false });
  consults = c || [];
}

// ë Œë”
function render() {
  const app = document.getElementById('app');
  
  if (page === 'login') {
    app.innerHTML = renderLogin();
  } else {
    app.innerHTML = renderMain();
  }
}

// ë¡œê·¸ì¸ í˜ì´ì§€
function renderLogin() {
  return `
    <div class="min-h-screen flex flex-col">
      <!-- ê´‘ê³  ì˜ì—­ -->
      <div class="bg-amber-50 p-3 text-center text-sm">
        <a href="https://link.coupang.com/a/example" target="_blank" class="text-amber-800">
          ğŸ“š í•™ìŠµì— í•„ìš”í•œ êµì¬ë¥¼ ì¿ íŒ¡ì—ì„œ í™•ì¸í•˜ì„¸ìš”!
        </a>
      </div>
      
      <div class="flex-1 flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
          <div class="text-center mb-8">
            <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span class="text-4xl">ğŸ‘©â€ğŸ‘§</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">${academy?.name || 'í•™ì›'}</h1>
            <p class="text-gray-500 mt-1">í•™ë¶€ëª¨ í˜ì´ì§€</p>
          </div>
          
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <label class="text-sm text-gray-600 block mb-2">ë³´í˜¸ì ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬</label>
            <input type="tel" id="phone" maxlength="4" placeholder="0000" 
              class="w-full text-center text-3xl tracking-widest py-4 border-2 rounded-xl focus:border-emerald-500 focus:outline-none"
              onkeypress="if(event.key==='Enter')login()">
            <button onclick="login()" 
              class="w-full mt-4 py-4 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 transition-colors"
              ${loading ? 'disabled' : ''}>
              ${loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸'}
            </button>
          </div>
          
          <p class="text-center text-gray-400 text-sm mt-6">
            ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          </p>
        </div>
      </div>
    </div>
  `;
}

// ë©”ì¸ í˜ì´ì§€
function renderMain() {
  const tabs = [
    { id: 'home', icon: 'ğŸ ', label: 'í™ˆ' },
    { id: 'attendance', icon: 'ğŸ“…', label: 'ì¶œê²°' },
    { id: 'notices', icon: 'ğŸ“¢', label: 'ê³µì§€' },
    { id: 'photos', icon: 'ğŸ“¸', label: 'ì‚¬ì§„' },
    { id: 'consult', icon: 'ğŸ’¬', label: 'ìƒë‹´' }
  ];
  
  let h = `
    <div class="min-h-screen pb-20">
      <!-- í—¤ë” -->
      <div class="bg-emerald-500 text-white p-4">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-sm opacity-80">${academy.name}</div>
            <div class="text-xl font-bold">${student.name} í•™ë¶€ëª¨ë‹˜</div>
          </div>
          <button onclick="logout()" class="px-3 py-1 bg-white/20 rounded-lg text-sm">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
  `;
  
  // í™ˆ
  if (tab === 'home') {
    const todayAtt = attendance[0];
    const unpaid = !student.paid;
    const scheduleStr = student.schedule ? Object.entries(student.schedule).map(([d,t])=>`${d} ${t}`).join(', ') : '-';
    
    h += `
      <div class="p-4 space-y-4">
        <!-- ì¶œê²° ìƒíƒœ -->
        <div class="bg-white rounded-2xl p-5 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">ğŸ“… ì˜¤ëŠ˜ ì¶œê²°</h3>
            <span class="px-3 py-1 rounded-full text-sm ${todayAtt ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500'}">
              ${todayAtt ? 'âœ“ ì¶œì„ì™„ë£Œ' : 'ë¯¸ì¶œì„'}
            </span>
          </div>
          <div class="text-sm text-gray-500">ìˆ˜ì—… ì¼ì •: ${scheduleStr}</div>
        </div>
        
        <!-- ìˆ˜ê°•ë£Œ -->
        <div class="bg-white rounded-2xl p-5 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold">ğŸ’° ìˆ˜ê°•ë£Œ</h3>
              <div class="text-2xl font-bold mt-1">${(student.fee || 0).toLocaleString()}ì›</div>
            </div>
            <div class="text-right">
              ${unpaid 
                ? `<span class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-sm">ë¯¸ë‚©</span>
                   <button onclick="requestPayment()" class="mt-2 block px-4 py-2 bg-emerald-500 text-white rounded-xl text-sm">ë‚©ë¶€í•˜ê¸°</button>`
                : `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-sm">ë‚©ë¶€ì™„ë£Œ</span>`
              }
            </div>
          </div>
        </div>
        
        <!-- ìµœê·¼ ê³µì§€ -->
        <div class="bg-white rounded-2xl p-5 shadow-sm">
          <h3 class="font-bold mb-3">ğŸ“¢ ìµœê·¼ ê³µì§€</h3>
          ${notices.length 
            ? notices.slice(0, 2).map(n => `
                <div class="py-2 border-b last:border-0">
                  <div class="font-medium text-sm">${n.title}</div>
                  <div class="text-xs text-gray-400">${new Date(n.created_at).toLocaleDateString('ko-KR')}</div>
                </div>
              `).join('')
            : '<p class="text-gray-400 text-sm">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>'
          }
        </div>
        
        <!-- ì¶œì„ í¬ì¸íŠ¸ -->
        <div class="bg-gradient-to-r from-amber-400 to-orange-400 rounded-2xl p-5 text-white">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold">ğŸ† ì¶œì„ í¬ì¸íŠ¸</h3>
              <div class="text-3xl font-bold mt-1">${student.points || 0}ì </div>
            </div>
            <div class="text-5xl">ğŸ¯</div>
          </div>
        </div>
      </div>
    `;
  }
  
  // ì¶œê²°
  else if (tab === 'attendance') {
    h += `
      <div class="p-4">
        <h2 class="font-bold text-lg mb-4">ğŸ“… ì¶œê²° ê¸°ë¡</h2>
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
          ${attendance.length
            ? attendance.map(a => `
                <div class="flex items-center justify-between p-4 border-b">
                  <div>${a.date}</div>
                  <span class="px-3 py-1 rounded-full text-sm ${a.status === 'ì¶œì„' ? 'bg-emerald-100 text-emerald-700' : a.status === 'ì§€ê°' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">
                    ${a.status}
                  </span>
                </div>
              `).join('')
            : '<p class="p-4 text-gray-400 text-center">ì¶œê²° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>'
          }
        </div>
      </div>
    `;
  }
  
  // ê³µì§€
  else if (tab === 'notices') {
    h += `
      <div class="p-4">
        <h2 class="font-bold text-lg mb-4">ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
        <div class="space-y-3">
          ${notices.length
            ? notices.map(n => `
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                  <div class="font-bold">${n.title}</div>
                  <div class="text-sm text-gray-600 mt-2">${n.content || ''}</div>
                  <div class="text-xs text-gray-400 mt-2">${new Date(n.created_at).toLocaleDateString('ko-KR')}</div>
                </div>
              `).join('')
            : '<p class="text-gray-400 text-center py-8">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>'
          }
        </div>
      </div>
    `;
  }
  
  // ì‚¬ì§„
  else if (tab === 'photos') {
    h += `
      <div class="p-4">
        <h2 class="font-bold text-lg mb-4">ğŸ“¸ ìˆ˜ì—… ì‚¬ì§„</h2>
        ${photos.length
          ? `<div class="grid grid-cols-2 gap-3">
              ${photos.map(p => `
                <div class="bg-white rounded-xl overflow-hidden shadow-sm">
                  <img src="${p.url}" class="w-full h-32 object-cover">
                  <div class="p-2">
                    <div class="text-xs text-gray-400">${new Date(p.created_at).toLocaleDateString('ko-KR')}</div>
                    ${p.caption ? `<div class="text-sm mt-1">${p.caption}</div>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>`
          : '<p class="text-gray-400 text-center py-8">ìˆ˜ì—… ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p>'
        }
      </div>
    `;
  }
  
  // ìƒë‹´
  else if (tab === 'consult') {
    h += `
      <div class="p-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="font-bold text-lg">ğŸ’¬ ìƒë‹´ ë¬¸ì˜</h2>
          <button onclick="openConsultModal()" class="px-4 py-2 bg-emerald-500 text-white rounded-xl text-sm">ë¬¸ì˜í•˜ê¸°</button>
        </div>
        <div class="space-y-3">
          ${consults.length
            ? consults.map(c => `
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                  <div class="flex justify-between items-start mb-2">
                    <div class="font-medium">${c.title || 'ë¬¸ì˜'}</div>
                    <span class="px-2 py-1 rounded text-xs ${c.status === 'ì™„ë£Œ' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${c.status}</span>
                  </div>
                  <div class="text-sm text-gray-600">${c.content}</div>
                  ${c.reply ? `<div class="mt-2 p-2 bg-gray-50 rounded text-sm"><strong>ë‹µë³€:</strong> ${c.reply}</div>` : ''}
                  <div class="text-xs text-gray-400 mt-2">${new Date(c.created_at).toLocaleDateString('ko-KR')}</div>
                </div>
              `).join('')
            : '<p class="text-gray-400 text-center py-8">ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>'
          }
        </div>
      </div>
    `;
  }
  
  // í•˜ë‹¨ íƒ­
  h += `
      <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex">
        ${tabs.map(t => `
          <button onclick="tab='${t.id}';render()" class="flex-1 py-3 text-center ${tab === t.id ? 'text-emerald-500' : 'text-gray-400'}">
            <div class="text-xl">${t.icon}</div>
            <div class="text-xs">${t.label}</div>
          </button>
        `).join('')}
      </nav>
    </div>
  `;
  
  return h;
}

function logout() {
  student = null;
  page = 'login';
  tab = 'home';
  render();
}

function requestPayment() {
  alert('ê²°ì œ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\ní•™ì›ì— ì§ì ‘ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
}

function openConsultModal() {
  const title = prompt('ë¬¸ì˜ ì œëª©:');
  if (!title) return;
  const content = prompt('ë¬¸ì˜ ë‚´ìš©:');
  if (!content) return;
  
  submitConsult(title, content);
}

async function submitConsult(title, content) {
  await db.from('consults').insert({
    student_id: student.id,
    title,
    content,
    status: 'ëŒ€ê¸°'
  });
  
  await loadData();
  render();
  alert('ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

init();
</script>
</body>
</html>
