<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì›ìƒê´€ë¦¬ Pro</title>
  
  <!-- PWA ì„¤ì • -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ì›ìƒê´€ë¦¬Pro">
  <meta name="theme-color" content="#4f46e5">
  
  <!-- ì•± ì•„ì´ì½˜ -->
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234f46e5' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' font-size='50'>ğŸ“š</text></svg>">
  <link rel="manifest" href="manifest.json">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{font-family:-apple-system,'Malgun Gothic',sans-serif;box-sizing:border-box}
    .sidebar-item.active{background:rgba(99,102,241,.15);color:#4f46e5;border-right:3px solid #4f46e5}
    [contenteditable]:focus{outline:2px solid #6366f1;outline-offset:2px}
    @media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%}}
    /* ì›¹ì•± ëª¨ë“œì—ì„œ ìŠ¤í”Œë˜ì‹œ */
    @media(display-mode:standalone){body{padding-top:env(safe-area-inset-top)}}
  </style>
</head>
<body class="bg-gray-100">
<div id="app"></div>
<script>
const SUPABASE_URL = 'https://sniabexwdgeepakkxxek.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuaWFiZXh3ZGdlZXBha2t4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MDMxNzIsImV4cCI6MjA4NTA3OTE3Mn0.RsDQDyawjFk5voFLVouXDlTIXvhPrsziCD37ne-1jMU';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ë°ëª¨ ëª¨ë“œ ì²´í¬
const isDemo = window.location.search.includes('demo=1') || window.location.pathname.includes('/demo');
const demoAds = {coupang:'https://link.coupang.com/a/example',text:'ğŸ“š ì˜ì–´êµì¬ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ìµœëŒ€ 50% í• ì¸!'};

let page = 'login';
let academy = null;
let admin = null;
let students = [];
let notices = [];
let consults = [];
let todos = [];
let homework = [];
let photos = [];
let reports = [];
let makeups = [];
let chats = [];
let attendance = {};
let tab = 'dashboard';
let modal = '';
let editingId = null;
let selectedStudents = {};
let attTab = 'today';
let viewStudentId = null;
let loading = false;
let docStudentId = '';
let currentDoc = null;
let photoStudentId = '';
let chatStudentId = '';
let reportStudentId = '';
let paymentView = 'unpaid';
let paymentMonth = '';

// ì»¤ë®¤ë‹ˆí‹° ë³€ìˆ˜
let posts = [];
let polls = [];
let events = [];
let materials = [];
let suggestions = [];
let viewPostId = null;
let editingPostId = null;

// Business ë³€ìˆ˜
let staff = [];
let staffAttendance = [];
let salaries = [];
let branches = [];
let editingStaffId = null;
let staffFormData = {name:'',email:'',password:'',role:'staff',permissions:{}};

let formData = {name:'',phone:'',pPhone:'',course:'',level:'',fee:200000,paid:false,schedule:{},memo:''};

const dayList = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
const today = dayList[new Date().getDay()];
const yesterday = dayList[(new Date().getDay()+6)%7];
const tomorrow = dayList[(new Date().getDay()+1)%7];
const todayStr = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
const todayISO = new Date().toISOString().split('T')[0];

// ë°ëª¨ ë°ì´í„°
function loadDemoData() {
  academy = {id:'demo',name:'EDUì˜ì–´í•™ì›',address:'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',phone:'02-555-1234',owner:'ê¹€ì˜ì–´',bizNo:'123-45-67890',code:'DEMO01',categories:['ì˜ì–´']};
  admin = {id:'demo-admin',email:'demo@test.com'};
  students = [
    {id:'s1',name:'ê¹€ë¯¼ì¤€',phone:'010-1234-5678',pPhone:'010-9999-0001',course:'ì´ˆë“±ì˜ì–´',level:'Level3',fee:180000,paid:true,schedule:{ì›”:'15:00',ìˆ˜:'15:00',ê¸ˆ:'15:00'},memo:'ì§‘ì¤‘ë ¥ ì¢‹ìŒ',points:150},
    {id:'s2',name:'ì´ì„œìœ¤',phone:'010-2345-6789',pPhone:'010-9999-0002',course:'ì¤‘ë“±ì˜ì–´',level:'Level5',fee:220000,paid:true,schedule:{í™”:'17:00',ëª©:'17:00'},memo:'',points:120},
    {id:'s3',name:'ë°•ì§€í˜¸',phone:'010-3456-7890',pPhone:'010-9999-0003',course:'í† ìµ',level:'700+',fee:280000,paid:false,schedule:{ì›”:'19:00',ìˆ˜:'19:00',ê¸ˆ:'19:00'},memo:'í† ìµ ëª©í‘œ 800ì ',points:80},
    {id:'s4',name:'ìµœìˆ˜ì•„',phone:'010-4567-8901',pPhone:'010-9999-0004',course:'ì˜ì–´íšŒí™”',level:'ì¤‘ê¸‰',fee:250000,paid:true,schedule:{í™”:'10:00',ëª©:'10:00',í† :'10:00'},memo:'',points:200},
    {id:'s5',name:'ì •ì˜ˆì¤€',phone:'010-5678-9012',pPhone:'010-9999-0005',course:'ì´ˆë“±ì˜ì–´',level:'Level2',fee:180000,paid:false,schedule:{ì›”:'16:00',ìˆ˜:'16:00'},memo:'ë¶€ëª¨ë‹˜ ìƒë‹´ í•„ìš”',points:60},
    {id:'s6',name:'ê°•í•˜ì€',phone:'010-6789-0123',pPhone:'010-9999-0006',course:'í† í”Œ',level:'80+',fee:320000,paid:true,schedule:{ì›”:'14:00',í™”:'14:00',ìˆ˜:'14:00',ëª©:'14:00',ê¸ˆ:'14:00'},memo:'ìœ í•™ ì¤€ë¹„ì¤‘',points:180},
    {id:'s7',name:'ìœ¤ë„ìœ¤',phone:'010-7890-1234',pPhone:'010-9999-0007',course:'ì¤‘ë“±ì˜ì–´',level:'Level4',fee:220000,paid:true,schedule:{í™”:'18:00',ëª©:'18:00'},memo:'',points:100},
    {id:'s8',name:'ì„ì‹œìš°',phone:'010-8901-2345',pPhone:'010-9999-0008',course:'ì„±ì¸íšŒí™”',level:'Advanced',fee:280000,paid:true,schedule:{ìˆ˜:'20:00',ê¸ˆ:'20:00'},memo:'ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì–´ ê´€ì‹¬',points:90}
  ];
  todos = [
    {id:'t1',text:'ê¹€ë¯¼ì¤€ ì¶œì„ì²´í¬',done:true},
    {id:'t2',text:'ë°•ì§€í˜¸ ìˆ˜ê°•ë£Œ ì•ˆë‚´',done:false,urgent:true},
    {id:'t3',text:'ìƒë‹´ ë¬¸ì˜ íšŒì‹ ',done:false}
  ];
  notices = [
    {id:'n1',title:'ì„¤ ì—°íœ´ íœ´ì› ì•ˆë‚´',content:'2/8~2/12 íœ´ì›ì…ë‹ˆë‹¤. ë³´ê°• ì¼ì •ì€ ê°œë³„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',created_at:'2025-01-25'},
    {id:'n2',title:'2ì›” í† ìµíŠ¹ê°• ê°œì„¤',content:'ë§¤ì£¼ í† ìš”ì¼ 14ì‹œ, ì •ì› 10ëª…',created_at:'2025-01-20'}
  ];
  consults = [
    {id:'c1',student_id:'s1',title:'ë³´ê°• ë¬¸ì˜',message:'ì´ë²ˆì£¼ ê¸ˆìš”ì¼ ë³´ê°• ê°€ëŠ¥í• ê¹Œìš”?',reply:'ë„¤, ê°™ì€ ì‹œê°„ì— ì˜¤ì„¸ìš”.',status:'ì™„ë£Œ',created_at:'2025-01-26'},
    {id:'c2',student_id:'s3',title:'ìƒë‹´ ìš”ì²­',message:'ë ˆë²¨í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤',reply:'',status:'ëŒ€ê¸°',created_at:'2025-01-27'},
    {id:'c3',student_id:'s5',title:'ìˆ™ì œ ì–‘ ì¡°ì ˆ',message:'ìˆ™ì œê°€ ë„ˆë¬´ ë§ì€ ê²ƒ ê°™ìŠµë‹ˆë‹¤',reply:'',status:'ëŒ€ê¸°',created_at:'2025-01-27'}
  ];
  homework = [
    {id:'h1',student_id:'s1',title:'Phonics Unit5 ë³µìŠµ',done:false,due_date:'2025-01-30',created_at:'2025-01-25'},
    {id:'h2',student_id:'s2',title:'ë¬¸ë²• ì›Œí¬ë¶ p.30-35',done:true,due_date:'2025-01-28',created_at:'2025-01-24'},
    {id:'h3',student_id:'s3',title:'í† ìµ RC ëª¨ì˜ê³ ì‚¬',done:false,due_date:'2025-01-29',created_at:'2025-01-26'}
  ];
  photos = [
    {id:'p1',student_id:'s1',url:'https://via.placeholder.com/400x300/6366f1/white?text=ìˆ˜ì—…ì‚¬ì§„1',caption:'ì—´ì‹¬íˆ ê³µë¶€ì¤‘!',created_at:'2025-01-25'},
    {id:'p2',student_id:'s4',url:'https://via.placeholder.com/400x300/10b981/white?text=ìˆ˜ì—…ì‚¬ì§„2',caption:'íšŒí™” ìˆ˜ì—…',created_at:'2025-01-24'}
  ];
  reports = [
    {id:'r1',student_id:'s1',month:'2025-01',content:'ì´ë²ˆ ë‹¬ ì¶œì„ë¥  ìš°ìˆ˜í•©ë‹ˆë‹¤. íŒŒë‹‰ìŠ¤ ì‹¤ë ¥ì´ ë§ì´ ëŠ˜ì—ˆì–´ìš”!',attendance_rate:95,homework_rate:90,memo:'ë‹¤ìŒ ë‹¬ Level4 ì§„ê¸‰ ì˜ˆì •',created_at:'2025-01-27'}
  ];
  makeups = [
    {id:'m1',student_id:'s2',original_date:'2025-01-28',request_date:'2025-01-30',reason:'ë³‘ì› ì˜ˆì•½',status:'ëŒ€ê¸°',created_at:'2025-01-26'}
  ];
  chats = [
    {id:'ch1',student_id:'s1',sender:'parent',message:'ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ ìˆ˜ì—… ì˜ ë°›ì•˜ë‚˜ìš”?',created_at:'2025-01-27T10:00:00'},
    {id:'ch2',student_id:'s1',sender:'admin',message:'ë„¤, ì˜¤ëŠ˜ ì—´ì‹¬íˆ í–ˆì–´ìš”! íŒŒë‹‰ìŠ¤ ì§„ë„ ì˜ ë‚˜ê°€ê³  ìˆìŠµë‹ˆë‹¤.',created_at:'2025-01-27T10:05:00'},
    {id:'ch3',student_id:'s1',sender:'parent',message:'ê°ì‚¬í•©ë‹ˆë‹¤! ì§‘ì—ì„œë„ ë³µìŠµ ì‹œí‚¬ê²Œìš”.',created_at:'2025-01-27T10:10:00'}
  ];
  staff = [
    {id:'st1',name:'ë°•ì„ ìƒ',email:'park@edu.com',role:'manager',permissions:{students:true,attendance:true,payments:true,notices:true}},
    {id:'st2',name:'ì´ì„ ìƒ',email:'lee@edu.com',role:'staff',permissions:{students:true,attendance:true,payments:false,notices:false}}
  ];
  salaries = [
    {id:'sal1',staff_id:'st1',month:'2025-01',base_amount:2500000,bonus:200000,deduction:150000,paid:true},
    {id:'sal2',staff_id:'st2',month:'2025-01',base_amount:2200000,bonus:100000,deduction:130000,paid:false}
  ];
  staffAttendance = [];
  branches = [];
  // ì»¤ë®¤ë‹ˆí‹° ë°ëª¨ ë°ì´í„°
  posts = [
    {id:'post1',academy_id:'demo',author_type:'admin',author_name:'ê¹€ì˜ì–´ ì›ì¥',content:'ìš°ë¦¬ í•™ì› ì»¤ë®¤ë‹ˆí‹°ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰\n\ní•™ë¶€ëª¨ë‹˜ë“¤ê³¼ í•™ìƒë“¤ ëª¨ë‘ ììœ ë¡­ê²Œ ì†Œí†µí•´ì£¼ì„¸ìš”.',images:[],pinned:true,created_at:'2025-01-20T09:00:00',likes:5,comments:3},
    {id:'post2',academy_id:'demo',author_type:'parent',author_name:'ê¹€ë¯¼ì¤€ í•™ë¶€ëª¨',content:'ì˜¤ëŠ˜ ì•„ì´ê°€ í•™ì› ë‹¤ë…€ì™€ì„œ ì˜ì–´ë¡œ ì¸ì‚¬í•˜ë„¤ìš” ã…ã… ê°ì‚¬í•©ë‹ˆë‹¤!',images:[],pinned:false,created_at:'2025-01-27T18:30:00',likes:8,comments:2},
    {id:'post3',academy_id:'demo',author_type:'admin',author_name:'ê¹€ì˜ì–´ ì›ì¥',content:'ğŸ“¸ ì´ë²ˆ ì£¼ ìˆ˜ì—… ì‚¬ì§„ì…ë‹ˆë‹¤!\nì—´ì‹¬íˆ ê³µë¶€í•˜ëŠ” ìš°ë¦¬ ì•„ì´ë“¤ ëª¨ìŠµ ë³´ì„¸ìš”~',images:['https://via.placeholder.com/400x300/6366f1/white?text=Class+Photo'],pinned:false,created_at:'2025-01-26T15:00:00',likes:12,comments:5}
  ];
  polls = [
    {id:'poll1',academy_id:'demo',title:'ğŸ—³ï¸ 2ì›” ë³´ê°• í¬ë§ ìš”ì¼',options:['ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'],multiple:false,end_date:'2025-02-05',created_at:'2025-01-27T10:00:00',votes:{0:3,1:5,2:2,3:4,4:1,5:8}},
    {id:'poll2',academy_id:'demo',title:'ğŸ“š ë‹¤ìŒ ë‹¬ í¬ë§ íŠ¹ê°• (ë³µìˆ˜ ì„ íƒ)',options:['í† ìµ ì§‘ì¤‘ë°˜','ì˜ì–´íšŒí™”','ë¬¸ë²• ë§ˆìŠ¤í„°','ë°œìŒ êµì •'],multiple:true,end_date:'2025-02-10',created_at:'2025-01-25T14:00:00',votes:{0:7,1:12,2:5,3:9}}
  ];
  events = [
    {id:'ev1',academy_id:'demo',title:'ì„¤ ì—°íœ´ íœ´ì›',description:'2/8~2/12 íœ´ì›ì…ë‹ˆë‹¤',event_date:'2025-02-08',event_time:'',location:'',created_at:'2025-01-20',rsvp:{yes:0,no:0,maybe:0}},
    {id:'ev2',academy_id:'demo',title:'2ì›” í† ìµ íŠ¹ê°•',description:'ë§¤ì£¼ í† ìš”ì¼ 14ì‹œ, 4ì£¼ ê³¼ì •',event_date:'2025-02-01',event_time:'14:00',location:'í•™ì› 3ì¸µ ëŒ€ê°•ì˜ì‹¤',created_at:'2025-01-25',rsvp:{yes:8,no:2,maybe:3}},
    {id:'ev3',academy_id:'demo',title:'í•™ë¶€ëª¨ ìƒë‹´ ì£¼ê°„',description:'ê°œë³„ ìƒë‹´ ì‹ ì²­ ë°›ìŠµë‹ˆë‹¤',event_date:'2025-02-15',event_time:'10:00-18:00',location:'í•™ì› ìƒë‹´ì‹¤',created_at:'2025-01-27',rsvp:{yes:5,no:1,maybe:4}}
  ];
  materials = [
    {id:'mat1',academy_id:'demo',title:'ì´ˆë“±ì˜ì–´ Level3 ì›Œí¬ë¶',category:'ì´ˆë“±ì˜ì–´',file_url:'#',file_type:'pdf',downloads:23,created_at:'2025-01-15'},
    {id:'mat2',academy_id:'demo',title:'í† ìµ ë¹ˆì¶œ ë‹¨ì–´ 500',category:'í† ìµ',file_url:'#',file_type:'pdf',downloads:45,created_at:'2025-01-10'},
    {id:'mat3',academy_id:'demo',title:'ì˜ì–´íšŒí™” í‘œí˜„ ëª¨ìŒ',category:'ì˜ì–´íšŒí™”',file_url:'#',file_type:'pdf',downloads:31,created_at:'2025-01-05'}
  ];
  suggestions = [
    {id:'sug1',academy_id:'demo',content:'ì£¼ì°¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ê°œì„  ë¶€íƒë“œë ¤ìš”.',reply:'ì•ˆë…•í•˜ì„¸ìš”. ê±´ì˜ ê°ì‚¬í•©ë‹ˆë‹¤. ì¸ê·¼ ì£¼ì°¨ì¥ê³¼ í˜‘ì˜ ì¤‘ì…ë‹ˆë‹¤.',created_at:'2025-01-20'},
    {id:'sug2',academy_id:'demo',content:'ì—¬ë¦„ì— ì—ì–´ì»¨ ì˜¨ë„ê°€ ë„ˆë¬´ ë‚®ì•„ìš”',reply:'',created_at:'2025-01-26'}
  ];
}

const docs = [
  {id:1,cat:'ì¦ëª…ì„œ',name:'ì¬ì›ì¦ëª…ì„œ',icon:'ğŸ“œ'},{id:2,cat:'ì¦ëª…ì„œ',name:'ìˆ˜ë£Œì¦',icon:'ğŸ“'},{id:3,cat:'ì¦ëª…ì„œ',name:'ì¶œì„í™•ì¸ì„œ',icon:'âœ…'},
  {id:4,cat:'ì¦ëª…ì„œ',name:'ì„±ì ì¦ëª…ì„œ',icon:'ğŸ“Š'},{id:5,cat:'ì¦ëª…ì„œ',name:'ë ˆë²¨í™•ì¸ì„œ',icon:'ğŸ“ˆ'},
  {id:6,cat:'ì•ˆë‚´ë¬¸',name:'ìˆ˜ê°•ë£Œì•ˆë‚´',icon:'ğŸ’°'},{id:7,cat:'ì•ˆë‚´ë¬¸',name:'íœ´ì›ì•ˆë‚´',icon:'ğŸ–ï¸'},{id:8,cat:'ì•ˆë‚´ë¬¸',name:'ìˆ˜ì—…ë³€ê²½',icon:'ğŸ“…'},
  {id:9,cat:'ì•ˆë‚´ë¬¸',name:'íŠ¹ê°•ì•ˆë‚´',icon:'â­'},{id:10,cat:'ì•ˆë‚´ë¬¸',name:'í•™ì›ì†Œê°œ',icon:'ğŸ«'},
  {id:11,cat:'ê³„ì•½ì„œ',name:'ìˆ˜ê°•ê³„ì•½ì„œ',icon:'ğŸ“'},{id:12,cat:'ê³„ì•½ì„œ',name:'í™˜ë¶ˆë™ì˜ì„œ',icon:'ğŸ’¸'},{id:13,cat:'ê³„ì•½ì„œ',name:'ê°œì¸ì •ë³´ë™ì˜ì„œ',icon:'ğŸ”’'},
  {id:14,cat:'ê³„ì•½ì„œ',name:'ì´ˆìƒê¶Œë™ì˜ì„œ',icon:'ğŸ“·'},{id:15,cat:'ê³„ì•½ì„œ',name:'í•™ì›ê·œì¹™ë™ì˜ì„œ',icon:'ğŸ“‹'},
  {id:16,cat:'ì˜ìˆ˜ì¦',name:'ìˆ˜ê°•ë£Œì˜ìˆ˜ì¦',icon:'ğŸ§¾'},{id:17,cat:'ì˜ìˆ˜ì¦',name:'êµì¬ë¹„ì˜ìˆ˜ì¦',icon:'ğŸ“š'},{id:18,cat:'ì˜ìˆ˜ì¦',name:'í™˜ë¶ˆì˜ìˆ˜ì¦',icon:'ğŸ’³'},
  {id:19,cat:'í•™ìŠµê´€ë¦¬',name:'í•™ìŠµí”Œëœ',icon:'ğŸ¯'},{id:20,cat:'í•™ìŠµê´€ë¦¬',name:'ìƒë‹´ì¼ì§€',icon:'ğŸ“'},{id:21,cat:'í•™ìŠµê´€ë¦¬',name:'ë ˆë²¨í…ŒìŠ¤íŠ¸',icon:'âœï¸'},
  {id:22,cat:'í•™ìŠµê´€ë¦¬',name:'ì„±ì í‘œ',icon:'ğŸ“‹'},{id:23,cat:'í•™ìŠµê´€ë¦¬',name:'ì¶œê²°í‘œ',icon:'ğŸ“†'}
];

function fmt(n){return n>=10000?(n/10000).toFixed(0)+'ë§Œ':n.toLocaleString();}
function getStudentsByDay(day){
  return students.filter(s=>{
    if(s.schedule && typeof s.schedule === 'object') return s.schedule[day];
    return s.days && s.days.includes(day);
  }).sort((a,b)=>{
    const tA = a.schedule?.[day] || a.time || '';
    const tB = b.schedule?.[day] || b.time || '';
    return tA.localeCompare(tB);
  });
}
function getStudentTime(s,day){
  if(s.schedule && typeof s.schedule === 'object') return s.schedule[day] || '';
  return s.time || '';
}

function render(){
  const app = document.getElementById('app');
  if(loading){app.innerHTML='<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-4xl mb-4">â³</div><p>ë¡œë”©ì¤‘...</p></div></div>';return;}
  if(page==='login') app.innerHTML = renderLogin();
  else if(page==='register') app.innerHTML = renderRegister();
  else if(page==='main') app.innerHTML = renderMain();
}

function renderLogin(){
  let h = '<div class="min-h-screen flex flex-col">';
  
  // ë°ëª¨ ëª¨ë“œë©´ ì¿ íŒ¡ ê´‘ê³  í‘œì‹œ
  if(isDemo){
    h += `<a href="${demoAds.coupang}" target="_blank" class="block bg-gradient-to-r from-red-500 to-rose-600 text-white py-3 px-4 text-center">
      <div class="font-bold">${demoAds.text}</div>
      <div class="text-xs opacity-70">ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ í™œë™ì˜ ì¼í™˜ìœ¼ë¡œ ìˆ˜ìˆ˜ë£Œë¥¼ ì œê³µë°›ìŠµë‹ˆë‹¤</div>
    </a>`;
  }
  
  h += `<div class="flex-1 bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-800 flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-4xl">ğŸ“š</div>
        <h1 class="text-3xl font-bold text-white">ì›ìƒê´€ë¦¬ Pro</h1>
        <p class="text-indigo-200 mt-2">í•™ì› ê´€ë¦¬ì˜ ìƒˆë¡œìš´ ì‹œì‘</p>
      </div>`;
  
  // ë°ëª¨ ëª¨ë“œ
  if(isDemo){
    h += `<div class="bg-amber-400 text-amber-900 rounded-2xl p-4 mb-6 text-center">
        <div class="font-bold text-lg">ğŸ® ë°ëª¨ ë²„ì „</div>
        <div class="text-sm">ì‹¤ì œ ë°ì´í„°ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
      </div>
      <button onclick="enterDemo()" class="w-full bg-white rounded-2xl p-4 flex items-center gap-4 hover:bg-gray-50 mb-4">
        <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¨â€ğŸ’¼</div>
        <div class="text-left flex-1"><div class="font-bold">í•™ì› ê´€ë¦¬ìë¡œ ì²´í—˜</div><div class="text-sm text-gray-500">ëª¨ë“  ê¸°ëŠ¥ ë‘˜ëŸ¬ë³´ê¸°</div></div>
        <span class="text-gray-400">â†’</span>
      </button>
      <div class="text-center"><a href="../" class="text-indigo-300 text-sm">â† í™ˆìœ¼ë¡œ</a></div>`;
  } else {
    h += `<div class="bg-white rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-bold mb-4">ë¡œê·¸ì¸</h2>
        <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 border rounded-xl mb-4">
        <button onclick="doLogin()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">ë¡œê·¸ì¸</button>
        <p class="text-center mt-4 text-gray-500">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button onclick="page='register';render()" class="text-indigo-600 font-medium">íšŒì›ê°€ì…</button></p>
      </div>`;
  }
  
  h += '</div></div></div>';
  return h;
}

// ë°ëª¨ ì§„ì…
function enterDemo(){
  loadDemoData();
  page = 'main';
  render();
}

function renderRegister(){
  const categories = {
    'ì–´í•™': ['ì˜ì–´', 'ì¤‘êµ­ì–´', 'ì¼ë³¸ì–´', 'ê¸°íƒ€ì™¸êµ­ì–´'],
    'ìŒì•…': ['í”¼ì•„ë…¸', 'ë°”ì´ì˜¬ë¦°/ì²¼ë¡œ', 'ê¸°íƒ€/ìš°ì¿¨ë ë ˆ', 'ë“œëŸ¼/íƒ€ì•…ê¸°', 'ë³´ì»¬/ì„±ì•…', 'ì‘ê³¡/ë¯¸ë””'],
    'ë¯¸ìˆ ': ['ë¯¸ìˆ (íšŒí™”)', 'ë§Œí™”/ì›¹íˆ°', 'ê³µì˜ˆ/ë„ì˜ˆ', 'ì„œì˜ˆ/ìº˜ë¦¬'],
    'ì²´ìœ¡/ë¬´ìˆ ': ['íƒœê¶Œë„', 'í•©ê¸°ë„/ìœ ë„/ê²€ë„', 'ìˆ˜ì˜', 'ë°œë ˆ/ë¬´ìš©', 'ì²´ì¡°/ì¤„ë„˜ê¸°', 'ì¶•êµ¬/ë†êµ¬', 'í—¬ìŠ¤/PT', 'í•„ë¼í…ŒìŠ¤/ìš”ê°€', 'ê³¨í”„', 'í´ë¼ì´ë°'],
    'ì…ì‹œ/í•™ìŠµ': ['êµ­ì–´/ë…¼ìˆ ', 'ìˆ˜í•™', 'ì˜ì–´(ì…ì‹œ)', 'ê³¼í•™', 'ì‚¬íšŒ/ì—­ì‚¬', 'ì¢…í•©ì…ì‹œ', 'ë³´ìŠµ/ê³µë¶€ë°©'],
    'ì½”ë”©/ì»´í“¨í„°': ['ì½”ë”©', 'ì»´í“¨í„°í™œìš©', 'ìê²©ì¦'],
    'ê¸°íƒ€': ['ìš”ë¦¬/ë² ì´í‚¹', 'ë°”ë‘‘/ì²´ìŠ¤', 'ë…ì„œ/í† ë¡ ', 'ê¸°íƒ€']
  };
  
  let catHtml = '';
  Object.entries(categories).forEach(([group, items]) => {
    catHtml += `<div class="mb-3">
      <div class="text-sm font-medium text-gray-700 mb-2">${group}</div>
      <div class="flex flex-wrap gap-2">
        ${items.map(item => `
          <label class="flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full text-sm cursor-pointer hover:bg-indigo-100">
            <input type="checkbox" name="category" value="${item}" class="w-4 h-4"> ${item}
          </label>
        `).join('')}
      </div>
    </div>`;
  });
  
  return `
  <div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-800 flex items-center justify-center p-4">
    <div class="w-full max-w-lg">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-4xl">ğŸ“š</div>
        <h1 class="text-3xl font-bold text-white">ì›ìƒê´€ë¦¬ Pro</h1>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-xl max-h-[80vh] overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">íšŒì›ê°€ì…</h2>
        <input type="text" id="regAcademy" placeholder="í•™ì›ëª… *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="text" id="regOwner" placeholder="ì›ì¥ë‹˜ ì„±í•¨ *" class="w-full px-4 py-3 border rounded-xl mb-3">
        
        <div class="mb-3">
          <input type="text" id="regCode" placeholder="í•™ì› ì½”ë“œ * (ì˜ˆ: EDUENG)" class="w-full px-4 py-3 border rounded-xl uppercase" maxlength="10" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
          <p class="text-xs text-gray-500 mt-1">3~10ì, ì˜ë¬¸ ëŒ€ë¬¸ì+ìˆ«ìë§Œ (í•™ë¶€ëª¨/í•™ìƒ ì ‘ì†ìš©)</p>
        </div>
        
        <input type="tel" id="regPhone" placeholder="ì—°ë½ì²˜" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="text" id="regAddress" placeholder="ì£¼ì†Œ" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="email" id="regEmail" placeholder="ì´ë©”ì¼ (ë¡œê·¸ì¸ìš©) *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="password" id="regPw" placeholder="ë¹„ë°€ë²ˆí˜¸ *" class="w-full px-4 py-3 border rounded-xl mb-4">
        
        <div class="border-t pt-4 mb-4">
          <h3 class="font-bold mb-3">ğŸ“š í•™ì› ì¢…ë¥˜ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥) *</h3>
          ${catHtml}
        </div>
        
        <button onclick="doRegister()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">ê°€ì…í•˜ê¸°</button>
        <p class="text-center mt-4 text-gray-500">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="page='login';render()" class="text-indigo-600 font-medium">ë¡œê·¸ì¸</button></p>
      </div>
    </div>
  </div>`;
}

async function doRegister(){
  const name = document.getElementById('regAcademy').value;
  const owner = document.getElementById('regOwner').value;
  const code = document.getElementById('regCode').value.toUpperCase();
  const phone = document.getElementById('regPhone').value;
  const address = document.getElementById('regAddress').value;
  const email = document.getElementById('regEmail').value;
  const pw = document.getElementById('regPw').value;
  
  // ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘
  const checked = document.querySelectorAll('input[name="category"]:checked');
  const categories = Array.from(checked).map(c => c.value);
  
  if(!name||!owner||!email||!pw){alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  if(!code || code.length < 3 || code.length > 10){alert('í•™ì› ì½”ë“œëŠ” 3~10ìë¡œ ì…ë ¥í•˜ì„¸ìš”');return;}
  if(!/^[A-Z0-9]+$/.test(code)){alert('í•™ì› ì½”ë“œëŠ” ì˜ë¬¸ ëŒ€ë¬¸ìì™€ ìˆ«ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');return;}
  if(categories.length === 0){alert('í•™ì› ì¢…ë¥˜ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”');return;}
  
  loading=true;render();
  
  // ì½”ë“œ ì¤‘ë³µ ì²´í¬
  const {data:existing} = await db.from('academies').select('id').eq('code',code).single();
  if(existing){
    alert('ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ í•™ì› ì½”ë“œì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    loading=false;render();
    return;
  }
  
  const {data:academyData,error:err1} = await db.from('academies').insert({name,owner,phone,address,categories,code}).select().single();
  if(err1){alert('í•™ì› ë“±ë¡ ì‹¤íŒ¨: '+err1.message);loading=false;render();return;}
  const {error:err2} = await db.from('admins').insert({academy_id:academyData.id,email,password:pw});
  if(err2){alert('ê´€ë¦¬ì ë“±ë¡ ì‹¤íŒ¨: '+err2.message);loading=false;render();return;}
  alert(`ê°€ì… ì™„ë£Œ!\n\ní•™ì› ì½”ë“œ: ${code}\n\nğŸ“± í•™ë¶€ëª¨ ì ‘ì†:\nwonpro.pages.dev/p/${code}\n\nğŸ‘¦ í•™ìƒ ì ‘ì†:\nwonpro.pages.dev/s/${code}\n\nğŸ‘¤ ì„±ì¸íšŒì› ì ‘ì†:\nwonpro.pages.dev/m/${code}\n\në¡œê·¸ì¸í•˜ì„¸ìš”.`);
  loading=false;page='login';render();
}

async function doLogin(){
  const email = document.getElementById('loginEmail').value;
  const pw = document.getElementById('loginPw').value;
  if(!email||!pw){alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  loading=true;render();
  const {data,error} = await db.from('admins').select('*,academies(*)').eq('email',email).eq('password',pw).single();
  if(error||!data){alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');loading=false;render();return;}
  admin = data;
  academy = data.academies;
  await loadData();
  loading=false;page='main';render();
}

async function loadData(){
  const {data:s} = await db.from('students').select('*').eq('academy_id',academy.id);
  students = s || [];
  const {data:n} = await db.from('notices').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  notices = n || [];
  const {data:t} = await db.from('todos').select('*').eq('academy_id',academy.id);
  todos = t || [];
  const {data:c} = await db.from('consults').select('*').order('created_at',{ascending:false});
  consults = (c || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:hw} = await db.from('homework').select('*').order('created_at',{ascending:false});
  homework = (hw || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:p} = await db.from('photos').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  photos = p || [];
  const {data:r} = await db.from('reports').select('*').order('created_at',{ascending:false});
  reports = (r || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:m} = await db.from('makeups').select('*').order('created_at',{ascending:false});
  makeups = (m || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:ch} = await db.from('chats').select('*').eq('academy_id',academy.id).order('created_at',{ascending:true});
  chats = ch || [];
  // ì»¤ë®¤ë‹ˆí‹° ë°ì´í„°
  const {data:po} = await db.from('posts').select('*').eq('academy_id',academy.id).order('pinned',{ascending:false}).order('created_at',{ascending:false});
  posts = po || [];
  const {data:pl} = await db.from('polls').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  polls = pl || [];
  const {data:ev} = await db.from('events').select('*').eq('academy_id',academy.id).order('event_date',{ascending:true});
  events = ev || [];
  const {data:mt} = await db.from('materials').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  materials = mt || [];
  const {data:sg} = await db.from('suggestions').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  suggestions = sg || [];
  // Business ë°ì´í„°
  const {data:st} = await db.from('staff').select('*').eq('academy_id',academy.id);
  staff = st || [];
  const {data:sa} = await db.from('staff_attendance').select('*').eq('date',todayISO);
  staffAttendance = (sa || []).filter(x => staff.some(stf => stf.id === x.staff_id));
  const currentMonth = new Date().toISOString().slice(0,7);
  const {data:sal} = await db.from('salaries').select('*').eq('month',currentMonth);
  salaries = (sal || []).filter(x => staff.some(stf => stf.id === x.staff_id));
  const {data:br} = await db.from('academies').select('*').eq('parent_id',academy.id);
  branches = br || [];
  const {data:a} = await db.from('attendance').select('*').eq('date',todayISO);
  attendance = {};
  (a||[]).forEach(att=>{attendance[att.student_id]=att.status;});
}

function logout(){
  admin=null;academy=null;students=[];notices=[];todos=[];consults=[];homework=[];attendance={};
  page='login';render();
}

function renderMain(){
  const todayS = getStudentsByDay(today);
  const tomorrowS = getStudentsByDay(tomorrow);
  const unpaid = students.filter(s=>!s.paid);
  const revenue = students.filter(s=>s.paid).reduce((a,s)=>a+(s.fee||0),0);
  const pendingConsults = consults.filter(c=>c.status==='ëŒ€ê¸°');
  const pendingMakeups = makeups.filter(m=>m.status==='ëŒ€ê¸°');

  const menus = [
    {id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},
    {id:'students',icon:'ğŸ‘¥',label:'ì›ìƒê´€ë¦¬'},
    {id:'attendance',icon:'ğŸ“…',label:'ì¶œê²°ê´€ë¦¬'},
    {id:'payments',icon:'ğŸ’°',label:'ìˆ˜ê°•ë£Œ'},
    {id:'community',icon:'ğŸ“‹',label:'ì»¤ë®¤ë‹ˆí‹°'},
    {id:'polls',icon:'ğŸ—³ï¸',label:'íˆ¬í‘œ'},
    {id:'events',icon:'ğŸ“…',label:'ì¼ì •'},
    {id:'birthday',icon:'ğŸ‰',label:'ìƒì¼'},
    {id:'materials',icon:'ğŸ“š',label:'ìë£Œì‹¤'},
    {id:'suggestions',icon:'ğŸ’¡',label:'ê±´ì˜í•¨'},
    {id:'photos',icon:'ğŸ“¸',label:'ìˆ˜ì—…ì‚¬ì§„',pro:true},
    {id:'reports',icon:'ğŸ“ˆ',label:'í•™ìŠµë¦¬í¬íŠ¸',pro:true},
    {id:'makeups',icon:'ğŸ”„',label:'ë³´ê°•ì‹ ì²­',pro:true,badge:pendingMakeups.length},
    {id:'chat',icon:'ğŸ’¬',label:'ì±„íŒ…',pro:true},
    {id:'points',icon:'ğŸ†',label:'ì¶œì„í¬ì¸íŠ¸',pro:true},
    {id:'notices',icon:'ğŸ“¢',label:'ê³µì§€ì‚¬í•­'},
    {id:'consult',icon:'ğŸ—£ï¸',label:'ìƒë‹´',badge:pendingConsults.length},
    {id:'homework',icon:'ğŸ“',label:'ê³¼ì œê´€ë¦¬'},
    {id:'documents',icon:'ğŸ“„',label:'ë¬¸ì„œí…œí”Œë¦¿'},
    {id:'staff',icon:'ğŸ‘”',label:'ì§ì›ê´€ë¦¬',biz:true},
    {id:'staffAtt',icon:'â°',label:'ì§ì›ê·¼íƒœ',biz:true},
    {id:'salary',icon:'ğŸ’µ',label:'ê¸‰ì—¬ê´€ë¦¬',biz:true},
    {id:'branches',icon:'ğŸ¢',label:'ë‹¤ì§€ì ',biz:true},
    {id:'settings',icon:'âš™ï¸',label:'ì„¤ì •'}
  ];

  let h = '<div class="flex min-h-screen">';
  
  // ì‚¬ì´ë“œë°”
  h += `<aside class="hidden lg:flex w-64 bg-white border-r flex-col fixed h-full">
    <div class="p-4 border-b"><div class="flex items-center gap-3"><span class="text-2xl">ğŸ“š</span><div><div class="font-bold">${academy.name}</div><div class="text-xs text-gray-400">${academy.owner}${isDemo?' Â· <span class="text-amber-500">ğŸ® ë°ëª¨</span>':''}</div></div></div></div>
    <nav class="flex-1 py-2 overflow-y-auto">`;
  menus.forEach(m=>{
    const cls = tab===m.id ? 'active bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50';
    const badge = m.badge ? `<span class="ml-auto bg-red-500 text-white text-xs px-2 rounded-full">${m.badge}</span>` : '';
    const proTag = m.pro ? '<span class="ml-1 px-1 py-0.5 bg-indigo-100 text-indigo-600 text-xs rounded">Pro</span>' : '';
    const bizTag = m.biz ? '<span class="ml-1 px-1 py-0.5 bg-purple-100 text-purple-600 text-xs rounded">Biz</span>' : '';
    h += `<button onclick="tab='${m.id}';viewStudentId=null;render()" class="sidebar-item w-full px-4 py-3 flex items-center gap-3 text-left ${cls}">${m.icon} ${m.label}${proTag}${bizTag}${badge}</button>`;
  });
  h += `</nav><div class="p-4 border-t"><button onclick="logout()" class="text-gray-500 text-sm">${isDemo?'â† ë°ëª¨ ë‚˜ê°€ê¸°':'ë¡œê·¸ì•„ì›ƒ'}</button></div></aside>`;

  h += '<main class="flex-1 lg:ml-64">';
  
  // í—¤ë”
  h += `<header class="bg-white border-b sticky top-0 z-10">
    <div class="px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-2 lg:hidden"><span>ğŸ“š</span><span class="font-bold">${academy.name}</span>${isDemo?'<span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded">ë°ëª¨</span>':''}</div>
      <div class="hidden lg:block font-bold">${viewStudentId ? 'ì›ìƒ ìƒì„¸' : menus.find(m=>m.id===tab)?.label||''}</div>
      <div class="flex gap-2">
        <button onclick="openAddStudent()" class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg">+ì›ìƒ</button>
        <button onclick="logout()" class="lg:hidden text-gray-500 text-sm">${isDemo?'ë‚˜ê°€ê¸°':'ë¡œê·¸ì•„ì›ƒ'}</button>
      </div>
    </div>
    <div class="lg:hidden flex border-t overflow-x-auto">`;
  menus.slice(0,6).forEach(m=>{
    h += `<button onclick="tab='${m.id}';render()" class="px-4 py-2 text-sm whitespace-nowrap border-b-2 ${tab===m.id?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500'}">${m.icon}</button>`;
  });
  h += '</div></header>';

  h += '<div class="p-4 lg:p-6">';

  // ì›ìƒ ìƒì„¸
  if(viewStudentId){
    h += renderStudentDetail();
  }
  // ëŒ€ì‹œë³´ë“œ
  else if(tab==='dashboard'){
    h += `<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white mb-6">
      <p class="text-indigo-100">${todayStr} ${today}ìš”ì¼</p>
      <h2 class="text-2xl font-bold mt-1">ì•ˆë…•í•˜ì„¸ìš”, ${academy.owner} ì›ì¥ë‹˜!</h2>
    </div>`;

    h += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì „ì²´ì›ìƒ</p><p class="text-3xl font-bold">${students.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì´ë²ˆë‹¬ ë§¤ì¶œ</p><p class="text-3xl font-bold text-emerald-600">${fmt(revenue)}</p></div>
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì˜¤ëŠ˜ìˆ˜ì—…</p><p class="text-3xl font-bold text-blue-600">${todayS.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
      <div class="bg-white rounded-2xl p-5 border cursor-pointer" onclick="tab='payments';render()"><p class="text-gray-500 text-sm">ë¯¸ë‚©</p><p class="text-3xl font-bold text-red-600">${unpaid.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
    </div>`;

    h += '<div class="grid lg:grid-cols-3 gap-6">';
    h += '<div class="lg:col-span-2 space-y-4">';
    
    // ì˜¤ëŠ˜ ìˆ˜ì—…
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-4"><h3 class="font-bold">ğŸ“… ì˜¤ëŠ˜ ìˆ˜ì—… (${today})</h3><span class="text-indigo-600 font-bold">${todayS.length}ëª…</span></div>`;
    if(todayS.length){
      h += '<div class="space-y-2">';
      todayS.forEach(s=>{
        const time = getStudentTime(s, today);
        const checked = attendance[s.id];
        h += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3"><span class="text-lg font-bold text-indigo-600">${time||'-'}</span><div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div></div>
          <span class="text-sm ${checked?'text-emerald-600':'text-gray-400'}">${checked?'âœ“ì¶œì„':'ëŒ€ê¸°'}</span>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-gray-400 text-center py-4">ì˜¤ëŠ˜ ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += `<button onclick="tab='attendance';render()" class="w-full mt-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg text-sm">ì¶œì„ì²´í¬ â†’</button></div>`;

    // ë‚´ì¼
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-4"><h3 class="font-bold">ğŸ“† ë‚´ì¼ ìˆ˜ì—… (${tomorrow})</h3><span class="text-purple-600 font-bold">${tomorrowS.length}ëª…</span></div>`;
    if(tomorrowS.length){
      h += '<div class="space-y-2">';
      tomorrowS.slice(0,4).forEach(s=>{
        const time = getStudentTime(s, tomorrow);
        h += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3"><span class="text-lg font-bold text-purple-600">${time||'-'}</span><div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div></div>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-gray-400 text-center py-4">ë‚´ì¼ ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += '</div></div>';

    // ì‚¬ì´ë“œ
    h += '<div class="space-y-4">';
    // í• ì¼
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ“‹ ì˜¤ëŠ˜ í•  ì¼</h3><button onclick="addTodo()" class="text-indigo-600 text-sm">+ì¶”ê°€</button></div>
      <div class="space-y-2 text-sm">`;
    todos.forEach(t=>{
      h += `<div class="flex items-center gap-2 p-2 rounded-lg ${t.urgent&&!t.done?'bg-red-50':'bg-gray-50'}">
        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo('${t.id}')" class="w-4 h-4">
        <span class="flex-1 ${t.done?'line-through text-gray-400':''}">${t.text}</span>
        <button onclick="deleteTodo('${t.id}')" class="text-gray-400 hover:text-red-500">âœ•</button>
      </div>`;
    });
    if(!todos.length) h += '<p class="text-gray-400 text-center py-2">í•  ì¼ ì—†ìŒ</p>';
    h += '</div></div>';

    // ìƒë‹´ëŒ€ê¸°
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ’¬ ìƒë‹´ ëŒ€ê¸°</h3>${pendingConsults.length?`<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">${pendingConsults.length}</span>`:''}</div>`;
    if(pendingConsults.length){
      pendingConsults.slice(0,2).forEach(c=>{
        const stu = students.find(s=>s.id===c.student_id);
        h += `<div class="p-3 bg-red-50 rounded-xl mb-2"><div class="font-medium text-sm">${stu?.name||''}</div><p class="text-xs text-gray-600 truncate">${c.message||''}</p></div>`;
      });
      h += `<button onclick="tab='consult';render()" class="w-full py-2 text-indigo-600 text-sm">ë‹µë³€í•˜ê¸° â†’</button>`;
    } else {
      h += '<p class="text-gray-400 text-center py-4 text-sm">ëŒ€ê¸°ì¤‘ ìƒë‹´ ì—†ìŒ âœ¨</p>';
    }
    h += '</div>';

    // ë¯¸ë‚©
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ’¸ ë¯¸ë‚©</h3><span class="text-red-600 font-medium">${fmt(unpaid.reduce((a,s)=>a+(s.fee||0),0))}</span></div>`;
    unpaid.slice(0,3).forEach(s=>{
      h += `<div class="flex justify-between py-2 border-b last:border-0"><span>${s.name}</span><span class="text-red-600">${fmt(s.fee||0)}</span></div>`;
    });
    if(!unpaid.length) h += '<p class="text-gray-400 text-center py-2">ë¯¸ë‚© ì—†ìŒ ğŸ‰</p>';
    h += '</div></div></div>';
  }

  // ì›ìƒê´€ë¦¬
  else if(tab==='students'){
    h += `<div class="flex justify-between items-center mb-4">
      <input type="text" placeholder="ê²€ìƒ‰..." class="px-4 py-2 border rounded-xl w-64">
      <button onclick="downloadExcel()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl text-sm">ğŸ“¥ ì—‘ì…€</button>
    </div>`;
    h += '<div class="bg-white rounded-2xl border overflow-hidden">';
    h += `<table class="w-full"><thead><tr class="bg-gray-50 border-b">
      <th class="text-left px-4 py-3 text-sm">ì›ìƒ</th>
      <th class="text-left px-4 py-3 text-sm">ê³¼ëª©</th>
      <th class="text-left px-4 py-3 text-sm hidden md:table-cell">ìˆ˜ì—…ì¼ì •</th>
      <th class="text-right px-4 py-3 text-sm">ìˆ˜ê°•ë£Œ</th>
    </tr></thead><tbody>`;
    students.forEach(s=>{
      const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d} ${t}`).join(', ') : (s.days||[]).join(' ')+' '+(s.time||'');
      h += `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="viewStudentId='${s.id}';render()">
        <td class="px-4 py-3"><div class="flex items-center gap-3">
          <div class="w-9 h-9 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
          <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.phone||''}</div></div>
        </div></td>
        <td class="px-4 py-3"><span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">${s.course||'-'}</span></td>
        <td class="px-4 py-3 text-sm hidden md:table-cell">${scheduleStr}</td>
        <td class="px-4 py-3 text-right"><div class="font-medium">${fmt(s.fee||0)}</div><div class="text-xs ${s.paid?'text-emerald-600':'text-red-500'}">${s.paid?'ì™„ë£Œ':'ë¯¸ë‚©'}</div></td>
      </tr>`;
    });
    if(!students.length) h += '<tr><td colspan="4" class="text-center py-8 text-gray-400">ì›ìƒì„ ë“±ë¡í•˜ì„¸ìš”</td></tr>';
    h += '</tbody></table></div>';
  }

  // ì¶œê²°ê´€ë¦¬
  else if(tab==='attendance'){
    const selCount = Object.keys(selectedStudents).filter(k=>selectedStudents[k]).length;
    const thisMonth = new Date().toISOString().slice(0,7);
    const lastMonth = new Date(new Date().setMonth(new Date().getMonth()-1)).toISOString().slice(0,7);

    h += `<div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center"><div><h3 class="text-xl font-bold">ğŸ“± ì¶œê²° ê´€ë¦¬</h3></div>
      <div class="text-right"><div class="text-3xl font-bold">${Object.keys(attendance).filter(k=>attendance[k]).length}/${getStudentsByDay(today).length}</div><div class="text-emerald-100">ì˜¤ëŠ˜ ì¶œì„</div></div></div></div>`;

    // íƒ­: ì–´ì œ/ì˜¤ëŠ˜/ë‚´ì¼ | ì „ë‹¬/ì´ë‹¬/ì „ì²´
    h += `<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
      <div class="flex flex-wrap gap-2">
        <button onclick="attTab='yesterday';render()" class="px-4 py-2 rounded-xl text-sm ${attTab==='yesterday'?'bg-indigo-600 text-white':'bg-white border'}">ì–´ì œ(${yesterday})</button>
        <button onclick="attTab='today';render()" class="px-4 py-2 rounded-xl text-sm ${attTab==='today'?'bg-indigo-600 text-white':'bg-white border'}">ì˜¤ëŠ˜(${today})</button>
        <button onclick="attTab='tomorrow';render()" class="px-4 py-2 rounded-xl text-sm ${attTab==='tomorrow'?'bg-indigo-600 text-white':'bg-white border'}">ë‚´ì¼(${tomorrow})</button>
        <span class="text-gray-300">|</span>
        <button onclick="attTab='lastMonth';render()" class="px-4 py-2 rounded-xl text-sm ${attTab==='lastMonth'?'bg-purple-600 text-white':'bg-white border'}">ì „ë‹¬</button>
        <button onclick="attTab='thisMonth';render()" class="px-4 py-2 rounded-xl text-sm ${attTab==='thisMonth'?'bg-purple-600 text-white':'bg-white border'}">ì´ë‹¬</button>
        <button onclick="attTab='all';render()" class="px-4 py-2 rounded-xl text-sm ${attTab==='all'?'bg-purple-600 text-white':'bg-white border'}">ì „ì²´</button>
      </div>
      <div class="flex gap-2">
        <button onclick="openMsgModal()" class="px-3 py-2 bg-indigo-600 text-white rounded-xl text-sm ${selCount===0?'opacity-50':''}">ğŸ’¬ ë©”ì‹œì§€ (${selCount})</button>
        <button onclick="openSmsModal()" class="px-3 py-2 bg-blue-600 text-white rounded-xl text-sm ${selCount===0?'opacity-50':''}">ğŸ“± ë¬¸ì (${selCount})</button>
      </div>
    </div>`;

    // ìš”ì¼ë³„ ì¶œê²° (ì–´ì œ/ì˜¤ëŠ˜/ë‚´ì¼)
    if(['yesterday','today','tomorrow'].includes(attTab)){
      const dayLabel = attTab==='yesterday'?yesterday:attTab==='tomorrow'?tomorrow:today;
      const list = getStudentsByDay(dayLabel);
      
      h += '<div class="bg-white rounded-2xl border p-4">';
      if(list.length){
        h += '<div class="space-y-2">';
        list.forEach(s=>{
          const time = getStudentTime(s, dayLabel);
          const checked = attTab==='today' && attendance[s.id];
          const selected = selectedStudents[s.id];
          h += `<div class="flex items-center gap-3 p-4 rounded-xl border-2 ${checked?'border-emerald-500 bg-emerald-50':'border-gray-200'}">
            <input type="checkbox" ${selected?'checked':''} onchange="toggleSelect('${s.id}')" class="w-5 h-5">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold ${checked?'bg-emerald-500 text-white':'bg-gray-100'}">${s.name?.[0]||'?'}</div>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="font-medium">${s.name}</span>
                ${attTab==='today' ? `<button onclick="toggleAtt('${s.id}')" class="px-3 py-1 text-xs rounded-lg ${checked?'bg-emerald-100 text-emerald-700':'bg-gray-200 text-gray-600'}">${checked?'âœ“ ì¶œì„':'ì¶œì„'}</button>` : ''}
              </div>
              <div class="text-sm text-gray-500">${s.course||''} Â· ${time}</div>
            </div>
          </div>`;
        });
        h += '</div>';
      } else {
        h += '<p class="text-center text-gray-400 py-8">ìˆ˜ì—… ì—†ìŒ</p>';
      }
      h += '</div>';
    }
    // ì›”ë³„/ì „ì²´ ê¸°ë¡
    else {
      const filterMonth = attTab==='lastMonth' ? lastMonth : attTab==='thisMonth' ? thisMonth : null;
      
      h += '<div class="bg-white rounded-2xl border overflow-hidden">';
      h += `<div class="px-4 py-3 border-b bg-gray-50 font-bold">${attTab==='lastMonth'?'ì „ë‹¬':attTab==='thisMonth'?'ì´ë‹¬':'ì „ì²´'} ì¶œê²° ê¸°ë¡</div>`;
      
      // ì›ìƒë³„ ì¶œê²° ìš”ì•½
      h += '<div class="divide-y">';
      students.forEach(s => {
        // ì‹¤ì œë¡œëŠ” DBì—ì„œ ê°€ì ¸ì™€ì•¼ í•˜ì§€ë§Œ ë°ëª¨ìš©
        const attCount = Math.floor(Math.random()*20)+5;
        const totalCount = attCount + Math.floor(Math.random()*3);
        const rate = Math.round(attCount/totalCount*100);
        const selected = selectedStudents[s.id];
        
        h += `<div class="flex items-center gap-3 p-4">
          <input type="checkbox" ${selected?'checked':''} onchange="toggleSelect('${s.id}')" class="w-5 h-5">
          <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
          <div class="flex-1">
            <div class="font-medium">${s.name}</div>
            <div class="text-sm text-gray-500">${s.course||''}</div>
          </div>
          <div class="text-right">
            <div class="font-bold ${rate>=90?'text-emerald-600':rate>=70?'text-amber-600':'text-red-600'}">${rate}%</div>
            <div class="text-xs text-gray-500">${attCount}/${totalCount}íšŒ</div>
          </div>
        </div>`;
      });
      if(!students.length) h += '<p class="text-center text-gray-400 py-8">ì›ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>';
      h += '</div></div>';
    }
  }

  // ìˆ˜ê°•ë£Œ
  else if(tab==='payments'){
    const thisMonth = new Date().toISOString().slice(0,7);
    const months = [];
    for(let i=5; i>=0; i--){
      const d = new Date();
      d.setMonth(d.getMonth()-i);
      months.push(d.toISOString().slice(0,7));
    }
    
    const total = students.reduce((a,s)=>a+(s.fee||0),0);
    const paidAmt = students.filter(s=>s.paid).reduce((a,s)=>a+(s.fee||0),0);
    const paidList = students.filter(s=>s.paid);
    const unpaidList = students.filter(s=>!s.paid);

    h += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ì˜ˆìƒë§¤ì¶œ</div><div class="text-2xl font-bold">${fmt(total)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ìˆ˜ë‚©ì™„ë£Œ</div><div class="text-2xl font-bold text-emerald-600">${fmt(paidAmt)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ë¯¸ìˆ˜ê¸ˆ</div><div class="text-2xl font-bold text-red-600">${fmt(total-paidAmt)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ìˆ˜ë‚©ë¥ </div><div class="text-2xl font-bold text-indigo-600">${total?Math.round(paidAmt/total*100):0}%</div></div>
    </div>`;

    // ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸
    h += `<div class="bg-white rounded-2xl border p-5 mb-6">
      <h3 class="font-bold mb-4">ğŸ“Š ì›”ë³„ ë§¤ì¶œ</h3>
      <div class="flex items-end gap-2 h-40">
        ${months.map((m,i) => {
          const isThisMonth = m === thisMonth;
          const revenue = total * (0.7 + Math.random()*0.3); // ë°ëª¨ìš© ëœë¤
          const height = Math.round((revenue / total) * 100);
          return `<div class="flex-1 flex flex-col items-center">
            <div class="w-full bg-indigo-${isThisMonth?'600':'200'} rounded-t cursor-pointer hover:bg-indigo-400" style="height:${height}px" onclick="paymentMonth='${m}';render()" title="${fmt(revenue)}"></div>
            <div class="text-xs text-gray-500 mt-2">${m.slice(5)}ì›”</div>
          </div>`;
        }).join('')}
      </div>
    </div>`;

    // ë‚©ë¶€ì/ë¯¸ë‚©ì íƒ­
    h += `<div class="flex gap-2 mb-4">
      <button onclick="paymentView='unpaid';render()" class="px-4 py-2 rounded-xl ${(!window.paymentView||paymentView==='unpaid')?'bg-red-600 text-white':'bg-white border'}">ë¯¸ë‚© (${unpaidList.length})</button>
      <button onclick="paymentView='paid';render()" class="px-4 py-2 rounded-xl ${paymentView==='paid'?'bg-emerald-600 text-white':'bg-white border'}">ë‚©ë¶€ì™„ë£Œ (${paidList.length})</button>
    </div>`;

    h += '<div class="bg-white rounded-2xl border">';
    
    if(!window.paymentView || paymentView==='unpaid'){
      h += `<div class="px-4 py-3 border-b flex justify-between bg-red-50"><span class="font-bold text-red-700">âš ï¸ ë¯¸ë‚© ì›ìƒ</span><span class="text-red-600 font-bold">${fmt(total-paidAmt)}</span></div>`;
      unpaidList.forEach(s=>{
        const unpaidDays = s.paid_date ? Math.floor((new Date() - new Date(s.paid_date))/(1000*60*60*24)) : 30;
        h += `<div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-red-100 text-red-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
            <div>
              <div class="font-medium">${s.name}</div>
              <div class="text-xs text-red-500">â° ${unpaidDays}ì¼ ë¯¸ë‚©</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold text-red-600">${fmt(s.fee||0)}</span>
            <button onclick="markPaid('${s.id}')" class="px-3 py-1 bg-emerald-600 text-white text-sm rounded-lg">ìˆ˜ë‚©</button>
          </div>
        </div>`;
      });
      if(!unpaidList.length) h += '<p class="text-center text-gray-400 py-8">ğŸ‰ ë¯¸ë‚© ì—†ìŒ</p>';
    } else {
      h += `<div class="px-4 py-3 border-b flex justify-between bg-emerald-50"><span class="font-bold text-emerald-700">âœ… ë‚©ë¶€ ì™„ë£Œ</span><span class="text-emerald-600 font-bold">${fmt(paidAmt)}</span></div>`;
      paidList.forEach(s=>{
        h += `<div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
            <div>
              <div class="font-medium">${s.name}</div>
              <div class="text-xs text-gray-500">${s.course||''}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-emerald-600">${fmt(s.fee||0)}</div>
            <div class="text-xs text-gray-400">${s.paid_date||'ë‚©ë¶€ì™„ë£Œ'}</div>
          </div>
        </div>`;
      });
      if(!paidList.length) h += '<p class="text-center text-gray-400 py-8">ë‚©ë¶€ì ì—†ìŒ</p>';
    }
    h += '</div>';
  }

  // ì»¤ë®¤ë‹ˆí‹° (ê²Œì‹œíŒ)
  else if(tab==='community'){
    h += `<div class="bg-gradient-to-r from-pink-500 to-rose-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ“‹ ì»¤ë®¤ë‹ˆí‹°</h3>
      <p class="text-pink-100">í•™ë¶€ëª¨, í•™ìƒê³¼ í•¨ê»˜í•˜ëŠ” ì†Œí†µ ê³µê°„</p>
    </div>`;
    
    h += `<div class="flex justify-end mb-4">
      <button onclick="openPostModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">âœï¸ ê¸€ì“°ê¸°</button>
    </div>`;
    
    h += '<div class="space-y-4">';
    posts.forEach(p => {
      const isPinned = p.pinned;
      const timeAgo = getTimeAgo(p.created_at);
      const visLabel = {all:'ğŸŒ ì „ì²´',parent:'ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨ë§Œ',student:'ğŸ‘¦ í•™ìƒë§Œ',member:'ğŸ‘¤ ì„±ì¸ë§Œ'}[p.visibility||'all'];
      h += `<div class="bg-white rounded-2xl border p-5 ${isPinned?'border-indigo-300 bg-indigo-50/30':''}">
        ${isPinned?'<div class="text-xs text-indigo-600 font-bold mb-2">ğŸ“Œ ê³ ì •ë¨</div>':''}
        <div class="flex items-center gap-3 mb-3">
          <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${p.author_name?.[0]||'?'}</div>
          <div class="flex-1">
            <div class="font-medium">${p.author_name||'ìµëª…'}</div>
            <div class="text-xs text-gray-400">${p.author_type==='admin'?'ğŸ‘¨â€ğŸ’¼ ì›ì¥':p.author_type==='parent'?'ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨':'ğŸ‘¦ í•™ìƒ'} Â· ${timeAgo} Â· <span class="text-indigo-500">${visLabel}</span></div>
          </div>
          ${p.author_type==='admin'?`<button onclick="togglePin('${p.id}')" class="text-gray-400 hover:text-indigo-600">${isPinned?'ğŸ“Œ':'ğŸ“'}</button><button onclick="deletePost('${p.id}')" class="text-gray-400 hover:text-red-500 ml-2">ğŸ—‘ï¸</button>`:''}
        </div>
        <p class="whitespace-pre-wrap mb-3">${p.content}</p>
        ${p.images?.length?`<div class="flex gap-2 mb-3">${p.images.map(img=>`<img src="${img}" class="w-32 h-24 object-cover rounded-lg">`).join('')}</div>`:''}
        <div class="flex items-center gap-4 pt-3 border-t text-sm">
          <button onclick="toggleLike('${p.id}')" class="flex items-center gap-1 text-gray-500 hover:text-red-500">â¤ï¸ ${p.likes||0}</button>
          <button onclick="viewPost('${p.id}')" class="flex items-center gap-1 text-gray-500 hover:text-indigo-500">ğŸ’¬ ${p.comments||0}</button>
        </div>
      </div>`;
    });
    if(!posts.length) h += '<p class="text-gray-400 text-center py-8">ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>';
    h += '</div>';
  }

  // íˆ¬í‘œ
  else if(tab==='polls'){
    h += `<div class="bg-gradient-to-r from-violet-500 to-purple-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ—³ï¸ íˆ¬í‘œ</h3>
      <p class="text-violet-100">ì˜ê²¬ì„ ëª¨ì•„ë³´ì„¸ìš”</p>
    </div>`;
    
    h += `<div class="flex justify-end mb-4">
      <button onclick="openPollModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">+ íˆ¬í‘œ ë§Œë“¤ê¸°</button>
    </div>`;
    
    h += '<div class="space-y-4">';
    polls.forEach(p => {
      const totalVotes = p.votes ? Object.values(p.votes).reduce((a,b)=>a+b,0) : 0;
      const isEnded = new Date(p.end_date) < new Date();
      h += `<div class="bg-white rounded-2xl border p-5">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h4 class="font-bold">${p.title}</h4>
            <div class="text-xs text-gray-400">${isEnded?'ë§ˆê°ë¨':'~'+p.end_date+' ê¹Œì§€'} Â· ${totalVotes}ëª… ì°¸ì—¬</div>
          </div>
          <button onclick="deletePoll('${p.id}')" class="text-gray-400 hover:text-red-500">ğŸ—‘ï¸</button>
        </div>
        <div class="space-y-2">
          ${p.options.map((opt,i) => {
            const votes = p.votes?.[i] || 0;
            const pct = totalVotes > 0 ? Math.round(votes/totalVotes*100) : 0;
            return `<div class="relative">
              <div class="absolute inset-0 bg-indigo-100 rounded-lg" style="width:${pct}%"></div>
              <div class="relative flex justify-between items-center p-3">
                <span>${opt}</span>
                <span class="text-sm text-indigo-600 font-medium">${votes}í‘œ (${pct}%)</span>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    });
    if(!polls.length) h += '<p class="text-gray-400 text-center py-8">íˆ¬í‘œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>';
    h += '</div>';
  }

  // ì¼ì •
  else if(tab==='events'){
    h += `<div class="bg-gradient-to-r from-cyan-500 to-blue-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ“… ì¼ì •</h3>
      <p class="text-cyan-100">í•™ì› í–‰ì‚¬ì™€ ì¼ì •ì„ ê³µìœ í•˜ì„¸ìš”</p>
    </div>`;
    
    h += `<div class="flex justify-end mb-4">
      <button onclick="openEventModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">+ ì¼ì • ì¶”ê°€</button>
    </div>`;
    
    h += '<div class="space-y-4">';
    events.forEach(e => {
      const isPast = new Date(e.event_date) < new Date();
      const rsvp = e.rsvp || {yes:0,no:0,maybe:0};
      h += `<div class="bg-white rounded-2xl border p-5 ${isPast?'opacity-60':''}">
        <div class="flex gap-4">
          <div class="text-center">
            <div class="w-14 h-14 bg-indigo-100 rounded-xl flex flex-col items-center justify-center">
              <div class="text-xs text-indigo-600">${new Date(e.event_date).toLocaleDateString('ko-KR',{month:'short'})}</div>
              <div class="text-xl font-bold text-indigo-700">${new Date(e.event_date).getDate()}</div>
            </div>
          </div>
          <div class="flex-1">
            <div class="flex justify-between">
              <h4 class="font-bold">${e.title}</h4>
              <button onclick="deleteEvent('${e.id}')" class="text-gray-400 hover:text-red-500">ğŸ—‘ï¸</button>
            </div>
            <p class="text-sm text-gray-500 mt-1">${e.description||''}</p>
            ${e.event_time?`<p class="text-sm text-gray-400 mt-1">ğŸ• ${e.event_time}</p>`:''}
            ${e.location?`<p class="text-sm text-gray-400">ğŸ“ ${e.location}</p>`:''}
            <div class="flex gap-4 mt-3 text-sm">
              <span class="text-emerald-600">âœ“ ì°¸ì„ ${rsvp.yes}</span>
              <span class="text-red-500">âœ— ë¶ˆì°¸ ${rsvp.no}</span>
              <span class="text-gray-500">? ë¯¸ì • ${rsvp.maybe}</span>
            </div>
          </div>
        </div>
      </div>`;
    });
    if(!events.length) h += '<p class="text-gray-400 text-center py-8">ì¼ì •ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
    h += '</div>';
  }

  // ìƒì¼
  else if(tab==='birthday'){
    const thisMonth = new Date().getMonth() + 1;
    const birthdays = students.filter(s => {
      if(!s.birthday) return false;
      const bMonth = new Date(s.birthday).getMonth() + 1;
      return bMonth === thisMonth;
    });
    
    h += `<div class="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ‰ ì´ë‹¬ì˜ ìƒì¼</h3>
      <p class="text-yellow-100">${thisMonth}ì›” ìƒì¼ ì¶•í•˜í•´ìš”!</p>
    </div>`;
    
    h += '<div class="grid md:grid-cols-2 gap-4">';
    if(birthdays.length){
      birthdays.forEach(s => {
        const bDay = new Date(s.birthday).getDate();
        h += `<div class="bg-white rounded-2xl border p-5 flex items-center gap-4">
          <div class="text-4xl">ğŸ‚</div>
          <div class="flex-1">
            <div class="font-bold">${s.name}</div>
            <div class="text-sm text-gray-500">${thisMonth}ì›” ${bDay}ì¼</div>
          </div>
          <button onclick="sendBirthdayMsg('${s.id}')" class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-sm">ğŸ ì¶•í•˜ ë©”ì‹œì§€</button>
        </div>`;
      });
    } else {
      h += '<p class="text-gray-400 text-center py-8 col-span-2">ì´ë²ˆ ë‹¬ ìƒì¼ì¸ ì›ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }
    h += '</div>';
    
    // ìƒì¼ ë“±ë¡ ì•ˆë‚´
    const noBirthday = students.filter(s => !s.birthday);
    if(noBirthday.length){
      h += `<div class="mt-6 bg-gray-50 rounded-xl p-4">
        <p class="text-sm text-gray-600">ğŸ’¡ ${noBirthday.length}ëª…ì˜ ì›ìƒ ìƒì¼ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì›ìƒ ìƒì„¸ì—ì„œ ìƒì¼ì„ ë“±ë¡í•´ì£¼ì„¸ìš”!</p>
      </div>`;
    }
  }

  // ìë£Œì‹¤
  else if(tab==='materials'){
    h += `<div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ“š ìë£Œì‹¤</h3>
      <p class="text-emerald-100">í•™ìŠµ ìë£Œë¥¼ ê³µìœ í•˜ì„¸ìš”</p>
    </div>`;
    
    h += `<div class="flex justify-end mb-4">
      <button onclick="openMaterialModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">+ ìë£Œ ì—…ë¡œë“œ</button>
    </div>`;
    
    h += '<div class="bg-white rounded-2xl border overflow-hidden">';
    if(materials.length){
      materials.forEach(m => {
        const icon = m.file_type==='pdf'?'ğŸ“„':m.file_type==='image'?'ğŸ–¼ï¸':'ğŸ“';
        h += `<div class="flex items-center gap-4 p-4 border-b hover:bg-gray-50">
          <div class="text-3xl">${icon}</div>
          <div class="flex-1">
            <div class="font-medium">${m.title}</div>
            <div class="text-sm text-gray-400">${m.category||'ê¸°íƒ€'} Â· ë‹¤ìš´ë¡œë“œ ${m.downloads}íšŒ</div>
          </div>
          <button onclick="downloadMaterial('${m.id}')" class="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-lg text-sm">ë‹¤ìš´ë¡œë“œ</button>
          <button onclick="deleteMaterial('${m.id}')" class="text-gray-400 hover:text-red-500">ğŸ—‘ï¸</button>
        </div>`;
      });
    } else {
      h += '<p class="text-gray-400 text-center py-8">ìë£Œë¥¼ ì—…ë¡œë“œí•´ë³´ì„¸ìš”!</p>';
    }
    h += '</div>';
  }

  // ê±´ì˜í•¨
  else if(tab==='suggestions'){
    const pending = suggestions.filter(s => !s.reply);
    h += `<div class="bg-gradient-to-r from-slate-500 to-gray-600 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="text-xl font-bold">ğŸ’¡ ìµëª… ê±´ì˜í•¨</h3>
          <p class="text-slate-200">í•™ë¶€ëª¨ë‹˜ì˜ ì†”ì§í•œ ì˜ê²¬</p>
        </div>
        ${pending.length?`<div class="bg-red-500 text-white px-3 py-1 rounded-full text-sm">${pending.length}ê°œ ëŒ€ê¸°</div>`:''}
      </div>
    </div>`;
    
    h += '<div class="space-y-4">';
    suggestions.forEach(s => {
      h += `<div class="bg-white rounded-2xl border p-5 ${!s.reply?'border-l-4 border-l-amber-400':''}">
        <div class="flex justify-between mb-2">
          <span class="text-xs text-gray-400">${new Date(s.created_at).toLocaleDateString('ko-KR')}</span>
          <span class="text-xs ${s.reply?'text-emerald-600':'text-amber-600'}">${s.reply?'âœ“ ë‹µë³€ì™„ë£Œ':'ëŒ€ê¸°ì¤‘'}</span>
        </div>
        <p class="mb-3">${s.content}</p>
        ${s.reply
          ?`<div class="p-3 bg-indigo-50 rounded-xl"><div class="text-xs text-indigo-600 mb-1">ì›ì¥ë‹˜ ë‹µë³€</div><p class="text-sm">${s.reply}</p></div>`
          :`<div><textarea id="sugReply${s.id}" class="w-full p-3 border rounded-xl text-sm mb-2" placeholder="ë‹µë³€ ì…ë ¥..."></textarea><button onclick="replySuggestion('${s.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">ë‹µë³€í•˜ê¸°</button></div>`
        }
      </div>`;
    });
    if(!suggestions.length) h += '<p class="text-gray-400 text-center py-8">ê±´ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    h += '</div>';
  }

  // ê³µì§€ì‚¬í•­
  else if(tab==='notices'){
    h += `<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">ğŸ“¢ ê³µì§€ì‚¬í•­</h2><button onclick="addNotice()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">+ ìƒˆ ê³µì§€</button></div>`;
    notices.forEach(n=>{
      h += `<div class="bg-white rounded-2xl border p-5 mb-3">
        <div class="flex justify-between"><h3 class="font-bold">${n.title}</h3><button onclick="deleteNotice('${n.id}')" class="text-gray-400">âœ•</button></div>
        <p class="text-sm text-gray-500 mt-1">${new Date(n.created_at).toLocaleDateString('ko-KR')}</p>
        <p class="mt-2">${n.content||''}</p>
      </div>`;
    });
    if(!notices.length) h += '<p class="text-gray-400 text-center py-8">ê³µì§€ì‚¬í•­ ì—†ìŒ</p>';
  }

  // ìƒë‹´
  else if(tab==='consult'){
    h += '<h2 class="text-xl font-bold mb-4">ğŸ’¬ ìƒë‹´ ê´€ë¦¬</h2>';
    if(consults.length){
      consults.forEach(c=>{
        const stu = students.find(s=>s.id===c.student_id);
        h += `<div class="bg-white rounded-2xl border p-5 mb-3 ${c.status==='ëŒ€ê¸°'?'border-l-4 border-l-red-500':''}">
          <div class="flex justify-between mb-2"><span class="font-medium">${stu?.name||'ì•Œìˆ˜ì—†ìŒ'}</span><span class="text-xs px-2 py-1 rounded-full ${c.status==='ëŒ€ê¸°'?'bg-red-100 text-red-600':'bg-emerald-100 text-emerald-600'}">${c.status}</span></div>
          <div class="p-3 bg-gray-50 rounded-xl mb-3">${c.message||''}</div>
          ${c.reply?`<div class="p-3 bg-indigo-50 rounded-xl"><span class="text-xs text-indigo-600">ë‹µë³€</span><p class="mt-1">${c.reply}</p></div>`:`<textarea id="reply${c.id}" class="w-full p-3 border rounded-xl mb-2" placeholder="ë‹µë³€ ì…ë ¥"></textarea><button onclick="sendReply('${c.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">ë‹µë³€</button>`}
        </div>`;
      });
    } else {
      h += '<p class="text-gray-400 text-center py-8">ìƒë‹´ ë‚´ì—­ ì—†ìŒ</p>';
    }
  }

  // ê³¼ì œê´€ë¦¬
  else if(tab==='homework'){
    h += '<h2 class="text-xl font-bold mb-4">ğŸ“ ê³¼ì œ ê´€ë¦¬</h2>';
    h += '<div class="grid md:grid-cols-2 gap-4">';
    students.forEach(s=>{
      const sHw = homework.filter(hw=>hw.student_id===s.id);
      h += `<div class="bg-white rounded-2xl border p-5">
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
            <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div>
          </div>
          <button onclick="addHomework('${s.id}')" class="text-indigo-600 text-sm">+ê³¼ì œ</button>
        </div>`;
      if(sHw.length){
        sHw.forEach(hw=>{
          h += `<div class="p-2 bg-gray-50 rounded-lg text-sm flex items-center gap-2 mb-1">
            <input type="checkbox" ${hw.done?'checked':''} onchange="toggleHomework('${hw.id}')" class="w-4 h-4">
            <span class="${hw.done?'line-through text-gray-400':''}">${hw.title}</span>
            <button onclick="deleteHomework('${hw.id}')" class="ml-auto text-gray-400 hover:text-red-500">âœ•</button>
          </div>`;
        });
      } else {
        h += '<p class="text-gray-400 text-sm text-center py-2">ê³¼ì œ ì—†ìŒ</p>';
      }
      h += '</div>';
    });
    h += '</div>';
  }

  // ë¬¸ì„œí…œí”Œë¦¿
  else if(tab==='documents'){
    const cats = [...new Set(docs.map(d=>d.cat))];
    h += `<div class="bg-gradient-to-r from-violet-500 to-purple-600 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ“„ ë¬¸ì„œ í…œí”Œë¦¿ (23ì¢…)</h3>
      <p class="text-violet-100">ì›ìƒ ì •ë³´ ìë™ ì…ë ¥ + ì§ì ‘ í¸ì§‘ ê°€ëŠ¥</p>
    </div>`;
    h += '<div class="bg-white rounded-2xl border p-5">';
    h += `<div class="mb-4"><label class="text-sm font-medium">ì›ìƒ ì„ íƒ</label>
      <select id="docStudent" onchange="docStudentId=this.value" class="ml-2 px-3 py-2 border rounded-xl">
        <option value="">ì„ íƒì•ˆí•¨</option>`;
    students.forEach(s=>{h+=`<option value="${s.id}">${s.name}</option>`;});
    h += '</select></div>';
    cats.forEach(cat=>{
      h += `<div class="mb-4"><h4 class="text-sm font-bold text-gray-500 mb-2">${cat}</h4><div class="grid grid-cols-3 sm:grid-cols-5 gap-2">`;
      docs.filter(d=>d.cat===cat).forEach(d=>{
        h += `<button onclick="openDoc(${d.id})" class="p-3 bg-gray-50 rounded-xl hover:bg-indigo-50 text-center"><span class="text-2xl">${d.icon}</span><div class="text-xs mt-1">${d.name}</div></button>`;
      });
      h += '</div></div>';
    });
    h += '</div>';
  }

  // ìˆ˜ì—…ì‚¬ì§„ (Pro)
  else if(tab==='photos'){
    const thisMonth = photos.filter(p => {
      const d = new Date(p.created_at);
      const now = new Date();
      return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    
    h += `<div class="bg-gradient-to-r from-pink-500 to-rose-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">ğŸ“¸ ìˆ˜ì—… ì‚¬ì§„</h3><p class="text-pink-100">í•™ë¶€ëª¨ì—ê²Œ ìˆ˜ì—… ëª¨ìŠµì„ ê³µìœ í•˜ì„¸ìš”</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${thisMonth.length}/50</div><div class="text-pink-100">ì´ë²ˆë‹¬ ì—…ë¡œë“œ</div></div>
      </div>
    </div>`;
    
    h += `<div class="bg-white rounded-2xl border p-5 mb-4">
      <div class="flex flex-wrap gap-3 items-center mb-4">
        <select id="photoStudent" onchange="photoStudentId=this.value" class="px-4 py-2 border rounded-xl">
          <option value="">ì›ìƒ ì„ íƒ</option>`;
    students.forEach(s => { h += `<option value="${s.id}">${s.name}</option>`; });
    h += `</select>
        <label class="flex-1 min-w-[200px]">
          <div class="px-4 py-3 bg-indigo-600 text-white rounded-xl text-center cursor-pointer hover:bg-indigo-700">
            ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ
          </div>
          <input type="file" accept="image/*" onchange="uploadPhoto(this)" class="hidden">
        </label>
      </div>
      <p class="text-sm text-gray-500">ğŸ’¡ ì‚¬ì§„ì€ ìë™ìœ¼ë¡œ 1200pxë¡œ ë¦¬ì‚¬ì´ì¦ˆë˜ë©°, ì›” 50ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    </div>`;
    
    // ì‚¬ì§„ ê°¤ëŸ¬ë¦¬
    if(photos.length){
      h += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">';
      photos.forEach(p => {
        const stu = students.find(s => s.id === p.student_id);
        const date = new Date(p.created_at).toLocaleDateString('ko-KR');
        h += `<div class="bg-white rounded-xl border overflow-hidden group relative">
          <img src="${p.url}" class="w-full h-40 object-cover">
          <div class="p-3">
            <div class="font-medium text-sm">${stu?.name || 'ì „ì²´'}</div>
            <div class="text-xs text-gray-500">${date}</div>
            ${p.caption ? `<div class="text-xs text-gray-600 mt-1">${p.caption}</div>` : ''}
          </div>
          <button onclick="deletePhoto('${p.id}')" class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">âœ•</button>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<div class="text-center py-12 text-gray-400"><div class="text-4xl mb-3">ğŸ“·</div><p>ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  }

  // í•™ìŠµ ë¦¬í¬íŠ¸ (Pro)
  else if(tab==='reports'){
    const currentMonth = new Date().toISOString().slice(0,7);
    
    h += `<div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ“ˆ í•™ìŠµ ë¦¬í¬íŠ¸</h3>
      <p class="text-blue-100">ì›”ë³„ í•™ìŠµ í˜„í™©ì„ í•™ë¶€ëª¨ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”</p>
    </div>`;
    
    h += '<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">';
    students.forEach(s => {
      const sReports = reports.filter(r => r.student_id === s.id);
      const hasThisMonth = sReports.some(r => r.month === currentMonth);
      const attCount = Object.keys(attendance).filter(k => attendance[k] && k === s.id).length;
      
      h += `<div class="bg-white rounded-2xl border p-5">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl font-bold">${s.name?.[0]||'?'}</div>
          <div><div class="font-bold">${s.name}</div><div class="text-sm text-gray-500">${s.course||''}</div></div>
        </div>
        <div class="flex items-center justify-between text-sm mb-3">
          <span>ì¶œì„ í¬ì¸íŠ¸</span><span class="font-bold text-blue-600">${s.points||0}ì </span>
        </div>
        <div class="flex gap-2">
          ${hasThisMonth 
            ? `<span class="flex-1 py-2 bg-emerald-100 text-emerald-700 rounded-xl text-center text-sm">âœ“ ì´ë²ˆë‹¬ ì‘ì„±ì™„ë£Œ</span>`
            : `<button onclick="openReportModal('${s.id}')" class="flex-1 py-2 bg-blue-600 text-white rounded-xl text-sm">ë¦¬í¬íŠ¸ ì‘ì„±</button>`
          }
        </div>
      </div>`;
    });
    h += '</div>';
  }

  // ë³´ê°• ì‹ ì²­ (Pro)
  else if(tab==='makeups'){
    h += `<div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">ğŸ”„ ë³´ê°• ì‹ ì²­</h3><p class="text-amber-100">í•™ë¶€ëª¨ê°€ ì‹ ì²­í•œ ë³´ê°•ì„ ê´€ë¦¬í•˜ì„¸ìš”</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${pendingMakeups.length}</div><div class="text-amber-100">ëŒ€ê¸°ì¤‘</div></div>
      </div>
    </div>`;
    
    if(makeups.length){
      h += '<div class="space-y-3">';
      makeups.forEach(m => {
        const stu = students.find(s => s.id === m.student_id);
        const statusColor = m.status === 'ëŒ€ê¸°' ? 'bg-amber-100 text-amber-700' : m.status === 'ìŠ¹ì¸' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700';
        h += `<div class="bg-white rounded-2xl border p-5 ${m.status==='ëŒ€ê¸°'?'border-l-4 border-l-amber-500':''}">
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="font-bold">${stu?.name||'ì•Œìˆ˜ì—†ìŒ'}</div>
              <div class="text-sm text-gray-500">${m.original_date} ìˆ˜ì—… â†’ ${m.request_date||'ë¯¸ì •'}</div>
            </div>
            <span class="px-3 py-1 rounded-full text-sm ${statusColor}">${m.status}</span>
          </div>
          ${m.reason ? `<p class="text-sm text-gray-600 mb-3">ì‚¬ìœ : ${m.reason}</p>` : ''}
          ${m.status === 'ëŒ€ê¸°' ? `
            <div class="flex gap-2">
              <button onclick="handleMakeup('${m.id}','ìŠ¹ì¸')" class="flex-1 py-2 bg-emerald-600 text-white rounded-xl text-sm">ìŠ¹ì¸</button>
              <button onclick="handleMakeup('${m.id}','ê±°ì ˆ')" class="flex-1 py-2 bg-red-500 text-white rounded-xl text-sm">ê±°ì ˆ</button>
            </div>
          ` : ''}
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<div class="text-center py-12 text-gray-400"><div class="text-4xl mb-3">ğŸ”„</div><p>ë³´ê°• ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  }

  // ì±„íŒ… (Pro)
  else if(tab==='chat'){
    h += `<div class="bg-gradient-to-r from-violet-500 to-purple-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h3>
      <p class="text-violet-100">í•™ë¶€ëª¨ì™€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì†Œí†µí•˜ì„¸ìš”</p>
    </div>`;
    
    h += `<div class="flex gap-4" style="height: calc(100vh - 350px);">
      <div class="w-64 bg-white rounded-2xl border overflow-hidden flex flex-col">
        <div class="p-3 border-b font-bold text-sm">ì›ìƒ ì„ íƒ</div>
        <div class="flex-1 overflow-y-auto">`;
    students.forEach(s => {
      const unread = chats.filter(c => c.student_id === s.id && c.sender === 'parent').length;
      h += `<button onclick="chatStudentId='${s.id}';render()" class="w-full p-3 text-left hover:bg-gray-50 border-b flex items-center gap-2 ${chatStudentId===s.id?'bg-indigo-50':''}">
        <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">${s.name?.[0]||'?'}</div>
        <div class="flex-1"><div class="font-medium text-sm">${s.name}</div></div>
        ${unread ? `<span class="w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">${unread}</span>` : ''}
      </button>`;
    });
    h += `</div></div>
      <div class="flex-1 bg-white rounded-2xl border flex flex-col overflow-hidden">`;
    
    if(chatStudentId){
      const stu = students.find(s => s.id === chatStudentId);
      const studentChats = chats.filter(c => c.student_id === chatStudentId);
      h += `<div class="p-4 border-b font-bold">${stu?.name||''} ì±„íŒ…</div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="chatMessages">`;
      studentChats.forEach(c => {
        const isMe = c.sender === 'admin';
        h += `<div class="flex ${isMe?'justify-end':'justify-start'}">
          <div class="max-w-[70%] p-3 rounded-2xl ${isMe?'bg-indigo-600 text-white':'bg-gray-100'}">${c.message}</div>
        </div>`;
      });
      h += `</div>
        <div class="p-4 border-t flex gap-2">
          <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." class="flex-1 px-4 py-2 border rounded-xl" onkeypress="if(event.key==='Enter')sendChat()">
          <button onclick="sendChat()" class="px-6 py-2 bg-indigo-600 text-white rounded-xl">ì „ì†¡</button>
        </div>`;
    } else {
      h += '<div class="flex-1 flex items-center justify-center text-gray-400">ì›ìƒì„ ì„ íƒí•˜ì„¸ìš”</div>';
    }
    h += '</div></div>';
  }

  // ì¶œì„ í¬ì¸íŠ¸ (Pro)
  else if(tab==='points'){
    const sortedStudents = [...students].sort((a,b) => (b.points||0) - (a.points||0));
    
    h += `<div class="bg-gradient-to-r from-yellow-500 to-amber-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ† ì¶œì„ í¬ì¸íŠ¸ & ë­í‚¹</h3>
      <p class="text-yellow-100">ì¶œì„í•  ë•Œë§ˆë‹¤ í¬ì¸íŠ¸ ì ë¦½! í•™ìƒë“¤ì˜ ë™ê¸° ë¶€ì—¬</p>
    </div>`;
    
    h += `<div class="bg-white rounded-2xl border p-5 mb-4">
      <h4 class="font-bold mb-3">í¬ì¸íŠ¸ ì„¤ì •</h4>
      <div class="flex gap-4 text-sm">
        <div class="flex items-center gap-2"><span>ì¶œì„:</span><span class="font-bold text-indigo-600">+10ì </span></div>
        <div class="flex items-center gap-2"><span>ì§€ê°:</span><span class="font-bold text-amber-600">+5ì </span></div>
        <div class="flex items-center gap-2"><span>ê²°ì„:</span><span class="font-bold text-red-600">0ì </span></div>
      </div>
    </div>`;
    
    h += '<div class="bg-white rounded-2xl border overflow-hidden">';
    h += '<div class="p-4 border-b font-bold">ğŸ† ë­í‚¹</div>';
    sortedStudents.forEach((s, i) => {
      const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}`;
      const bgColor = i < 3 ? 'bg-amber-50' : '';
      h += `<div class="flex items-center gap-4 p-4 border-b ${bgColor}">
        <div class="w-8 text-center font-bold ${i<3?'text-2xl':''}">${medal}</div>
        <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
        <div class="flex-1"><div class="font-medium">${s.name}</div><div class="text-sm text-gray-500">${s.course||''}</div></div>
        <div class="text-right">
          <div class="text-xl font-bold text-indigo-600">${s.points||0}</div>
          <div class="text-xs text-gray-500">í¬ì¸íŠ¸</div>
        </div>
        <button onclick="adjustPoints('${s.id}')" class="px-3 py-1 border rounded-lg text-sm">ì¡°ì •</button>
      </div>`;
    });
    h += '</div>';
  }

  // ì§ì› ê´€ë¦¬ (Business)
  else if(tab==='staff'){
    h += `<div class="bg-gradient-to-r from-slate-600 to-slate-800 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">ğŸ‘” ì§ì› ê´€ë¦¬</h3><p class="text-slate-300">ìµœëŒ€ 5ëª…ê¹Œì§€ ë“±ë¡ ê°€ëŠ¥</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${staff.length}/5</div><div class="text-slate-300">ë“±ë¡ë¨</div></div>
      </div>
    </div>`;
    
    h += `<div class="flex justify-end mb-4">
      <button onclick="openStaffModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl ${staff.length>=5?'opacity-50 cursor-not-allowed':''}" ${staff.length>=5?'disabled':''}>+ ì§ì› ì¶”ê°€</button>
    </div>`;
    
    if(staff.length){
      h += '<div class="bg-white rounded-2xl border overflow-hidden">';
      staff.forEach(s => {
        const roleLabel = s.role === 'manager' ? 'ë§¤ë‹ˆì €' : 'ì§ì›';
        const roleColor = s.role === 'manager' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700';
        h += `<div class="flex items-center gap-4 p-4 border-b">
          <div class="w-12 h-12 bg-slate-100 text-slate-600 rounded-xl flex items-center justify-center text-xl font-bold">${s.name?.[0]||'?'}</div>
          <div class="flex-1">
            <div class="font-bold">${s.name}</div>
            <div class="text-sm text-gray-500">${s.email}</div>
          </div>
          <span class="px-3 py-1 rounded-full text-xs ${roleColor}">${roleLabel}</span>
          <button onclick="editStaff('${s.id}')" class="px-3 py-1 border rounded-lg text-sm">ìˆ˜ì •</button>
          <button onclick="deleteStaff('${s.id}')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">ì‚­ì œ</button>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<div class="text-center py-12 text-gray-400"><div class="text-4xl mb-3">ğŸ‘”</div><p>ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
    
    h += `<div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mt-4">
      <h4 class="font-bold text-amber-800 mb-2">ğŸ’¡ ê¶Œí•œ ì„¤ì •</h4>
      <p class="text-sm text-amber-700">ì§ì›ë³„ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ ë©”ë‰´ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¶Œí•œì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
    </div>`;
  }

  // ì§ì› ê·¼íƒœ (Business)
  else if(tab==='staffAtt'){
    h += `<div class="bg-gradient-to-r from-teal-500 to-cyan-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">â° ì§ì› ê·¼íƒœ ê´€ë¦¬</h3><p class="text-teal-100">${todayStr}</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${staffAttendance.filter(a=>a.check_in).length}/${staff.length}</div><div class="text-teal-100">ì¶œê·¼</div></div>
      </div>
    </div>`;
    
    if(staff.length){
      h += '<div class="bg-white rounded-2xl border overflow-hidden">';
      staff.forEach(s => {
        const att = staffAttendance.find(a => a.staff_id === s.id);
        const checkIn = att?.check_in || '-';
        const checkOut = att?.check_out || '-';
        const status = att?.check_in ? (att?.check_out ? 'í‡´ê·¼' : 'ê·¼ë¬´ì¤‘') : 'ë¯¸ì¶œê·¼';
        const statusColor = status === 'ê·¼ë¬´ì¤‘' ? 'text-green-600' : status === 'í‡´ê·¼' ? 'text-gray-500' : 'text-red-500';
        h += `<div class="flex items-center gap-4 p-4 border-b">
          <div class="w-10 h-10 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
          <div class="flex-1 font-medium">${s.name}</div>
          <div class="text-center"><div class="text-xs text-gray-500">ì¶œê·¼</div><div class="font-mono">${checkIn}</div></div>
          <div class="text-center"><div class="text-xs text-gray-500">í‡´ê·¼</div><div class="font-mono">${checkOut}</div></div>
          <div class="w-16 text-center font-medium ${statusColor}">${status}</div>
          <div class="flex gap-1">
            ${!att?.check_in ? `<button onclick="staffCheckIn('${s.id}')" class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm">ì¶œê·¼</button>` : ''}
            ${att?.check_in && !att?.check_out ? `<button onclick="staffCheckOut('${s.id}')" class="px-3 py-1 bg-gray-600 text-white rounded-lg text-sm">í‡´ê·¼</button>` : ''}
          </div>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<div class="text-center py-12 text-gray-400"><div class="text-4xl mb-3">â°</div><p>ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  }

  // ê¸‰ì—¬ ê´€ë¦¬ (Business)
  else if(tab==='salary'){
    const currentMonth = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long'});
    const totalSalary = salaries.reduce((a,s)=>a+(s.base_amount||0)+(s.bonus||0)-(s.deduction||0),0);
    
    h += `<div class="bg-gradient-to-r from-emerald-500 to-green-600 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">ğŸ’µ ê¸‰ì—¬ ê´€ë¦¬</h3><p class="text-emerald-100">${currentMonth}</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${(totalSalary/10000).toFixed(0)}ë§Œì›</div><div class="text-emerald-100">ì´ ê¸‰ì—¬</div></div>
      </div>
    </div>`;
    
    if(staff.length){
      h += '<div class="bg-white rounded-2xl border overflow-hidden">';
      h += '<div class="grid grid-cols-7 gap-2 p-4 bg-gray-50 border-b text-sm font-medium text-gray-600"><div>ì§ì›</div><div class="text-right">ê¸°ë³¸ê¸‰</div><div class="text-right">ìˆ˜ë‹¹</div><div class="text-right">ê³µì œ</div><div class="text-right">ì‹¤ì§€ê¸‰ì•¡</div><div class="text-center">ìƒíƒœ</div><div></div></div>';
      staff.forEach(s => {
        const sal = salaries.find(x => x.staff_id === s.id) || {base_amount:0,bonus:0,deduction:0,paid:false};
        const total = (sal.base_amount||0) + (sal.bonus||0) - (sal.deduction||0);
        h += `<div class="grid grid-cols-7 gap-2 p-4 border-b items-center text-sm">
          <div class="font-medium">${s.name}</div>
          <div class="text-right">${(sal.base_amount||0).toLocaleString()}</div>
          <div class="text-right text-green-600">+${(sal.bonus||0).toLocaleString()}</div>
          <div class="text-right text-red-600">-${(sal.deduction||0).toLocaleString()}</div>
          <div class="text-right font-bold">${total.toLocaleString()}</div>
          <div class="text-center"><span class="px-2 py-1 rounded text-xs ${sal.paid?'bg-green-100 text-green-700':'bg-amber-100 text-amber-700'}">${sal.paid?'ì§€ê¸‰ì™„ë£Œ':'ë¯¸ì§€ê¸‰'}</span></div>
          <div><button onclick="editSalary('${s.id}')" class="px-3 py-1 border rounded text-xs">ìˆ˜ì •</button></div>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<div class="text-center py-12 text-gray-400"><div class="text-4xl mb-3">ğŸ’µ</div><p>ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  }

  // ë‹¤ì§€ì  ê´€ë¦¬ (Business)
  else if(tab==='branches'){
    h += `<div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">ğŸ¢ ë‹¤ì§€ì  ê´€ë¦¬</h3><p class="text-indigo-200">ë³¸ì : ${academy.name}</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${branches.length}</div><div class="text-indigo-200">ì§€ì </div></div>
      </div>
    </div>`;
    
    h += `<div class="flex justify-end mb-4">
      <button onclick="openBranchModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">+ ì§€ì  ì¶”ê°€</button>
    </div>`;
    
    h += '<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">';
    // ë³¸ì 
    h += `<div class="bg-white rounded-2xl border-2 border-indigo-500 p-5">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center text-xl">ğŸ </div>
        <div><div class="font-bold">${academy.name}</div><div class="text-xs text-indigo-600">ë³¸ì </div></div>
      </div>
      <div class="text-sm text-gray-500">${academy.address||'ì£¼ì†Œ ë¯¸ë“±ë¡'}</div>
      <div class="mt-3 pt-3 border-t flex justify-between text-sm">
        <span>ì›ìƒ ${students.length}ëª…</span>
        <span>ì§ì› ${staff.length}ëª…</span>
      </div>
    </div>`;
    // ì§€ì ë“¤
    branches.forEach(b => {
      h += `<div class="bg-white rounded-2xl border p-5">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-12 h-12 bg-gray-100 text-gray-600 rounded-xl flex items-center justify-center text-xl">ğŸ¢</div>
          <div><div class="font-bold">${b.branch_name||b.name}</div><div class="text-xs text-gray-500">ì§€ì </div></div>
        </div>
        <div class="text-sm text-gray-500">${b.address||'ì£¼ì†Œ ë¯¸ë“±ë¡'}</div>
        <div class="mt-3 pt-3 border-t flex justify-between">
          <button onclick="switchBranch('${b.id}')" class="text-sm text-indigo-600">ì „í™˜</button>
          <button onclick="deleteBranch('${b.id}')" class="text-sm text-red-500">ì‚­ì œ</button>
        </div>
      </div>`;
    });
    h += '</div>';
  }

  // ì„¤ì •
  else if(tab==='settings'){
    const blockedStudents = students.filter(s => s.blocked);
    
    h += `<div class="space-y-6">
      <!-- í•™ì› ì •ë³´ -->
      <div class="bg-white rounded-2xl border p-6">
        <h2 class="font-bold mb-4">ğŸ« í•™ì› ì •ë³´</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div><label class="text-sm text-gray-600">í•™ì›ëª…</label><input type="text" id="setName" value="${academy.name||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
          <div><label class="text-sm text-gray-600">ì›ì¥ëª…</label><input type="text" id="setOwner" value="${academy.owner||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
          <div class="md:col-span-2"><label class="text-sm text-gray-600">ì£¼ì†Œ</label><input type="text" id="setAddress" value="${academy.address||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
          <div><label class="text-sm text-gray-600">ì—°ë½ì²˜</label><input type="text" id="setPhone" value="${academy.phone||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        </div>
        <button onclick="saveSettings()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-xl">ì €ì¥</button>
      </div>
      
      <!-- ì ‘ì† URL -->
      <div class="bg-white rounded-2xl border p-6">
        <h2 class="font-bold mb-4">ğŸ”— ì ‘ì† URL</h2>
        <div class="mb-4 p-4 bg-indigo-50 rounded-xl">
          <div class="text-sm text-gray-600 mb-1">í•™ì› ì½”ë“œ</div>
          <div class="text-2xl font-bold text-indigo-600">${academy.code || 'ë¯¸ì„¤ì •'}</div>
        </div>
        <div class="space-y-3">
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <span class="text-2xl">ğŸ‘©â€ğŸ‘§</span>
            <div class="flex-1">
              <div class="text-sm text-gray-500">í•™ë¶€ëª¨ ì ‘ì†</div>
              <div class="font-mono text-sm">wonpro.pages.dev/p/${academy.code||''}</div>
            </div>
            <button onclick="copyUrl('p')" class="px-3 py-1 bg-indigo-600 text-white rounded-lg text-sm">ë³µì‚¬</button>
          </div>
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <span class="text-2xl">ğŸ‘¦</span>
            <div class="flex-1">
              <div class="text-sm text-gray-500">í•™ìƒ ì ‘ì†</div>
              <div class="font-mono text-sm">wonpro.pages.dev/s/${academy.code||''}</div>
            </div>
            <button onclick="copyUrl('s')" class="px-3 py-1 bg-indigo-600 text-white rounded-lg text-sm">ë³µì‚¬</button>
          </div>
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
            <span class="text-2xl">ğŸ‘¤</span>
            <div class="flex-1">
              <div class="text-sm text-gray-500">ì„±ì¸íšŒì› ì ‘ì†</div>
              <div class="font-mono text-sm">wonpro.pages.dev/m/${academy.code||''}</div>
            </div>
            <button onclick="copyUrl('m')" class="px-3 py-1 bg-indigo-600 text-white rounded-lg text-sm">ë³µì‚¬</button>
          </div>
        </div>
      </div>
      
      <!-- ì ‘ì† í—ˆìš© ì„¤ì • -->
      <div class="bg-white rounded-2xl border p-6">
        <h2 class="font-bold mb-4">ğŸ” ì ‘ì† í—ˆìš© ì„¤ì •</h2>
        <div class="space-y-3">
          <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-2xl">ğŸ‘©â€ğŸ‘§</span>
              <div><div class="font-medium">í•™ë¶€ëª¨ ì ‘ì†</div><div class="text-sm text-gray-500">í•™ë¶€ëª¨ í˜ì´ì§€ ì ‘ì† í—ˆìš©</div></div>
            </div>
            <input type="checkbox" id="allowParent" ${academy.allow_parent!==false?'checked':''} onchange="toggleAccess('parent')" class="w-5 h-5">
          </label>
          <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-2xl">ğŸ‘¦</span>
              <div><div class="font-medium">í•™ìƒ ì ‘ì†</div><div class="text-sm text-gray-500">í•™ìƒ í˜ì´ì§€ ì ‘ì† í—ˆìš©</div></div>
            </div>
            <input type="checkbox" id="allowStudent" ${academy.allow_student!==false?'checked':''} onchange="toggleAccess('student')" class="w-5 h-5">
          </label>
          <label class="flex items-center justify-between p-3 bg-gray-50 rounded-xl cursor-pointer">
            <div class="flex items-center gap-3">
              <span class="text-2xl">ğŸ‘¤</span>
              <div><div class="font-medium">ì„±ì¸íšŒì› ì ‘ì†</div><div class="text-sm text-gray-500">ì„±ì¸íšŒì› í˜ì´ì§€ ì ‘ì† í—ˆìš©</div></div>
            </div>
            <input type="checkbox" id="allowMember" ${academy.allow_member!==false?'checked':''} onchange="toggleAccess('member')" class="w-5 h-5">
          </label>
        </div>
      </div>
      
      <!-- ì›ìƒë³„ ì°¨ë‹¨ ê´€ë¦¬ -->
      <div class="bg-white rounded-2xl border p-6">
        <h2 class="font-bold mb-4">ğŸš« ì›ìƒ ì ‘ì† ê´€ë¦¬</h2>
        <p class="text-sm text-gray-500 mb-4">ê°œë³„ ì›ìƒì˜ ì ‘ì†ì„ ì°¨ë‹¨í•˜ê±°ë‚˜ í•´ì œí•©ë‹ˆë‹¤.</p>
        
        ${blockedStudents.length ? `
        <div class="mb-4">
          <div class="text-sm font-medium text-red-600 mb-2">ì°¨ë‹¨ëœ ì›ìƒ (${blockedStudents.length}ëª…)</div>
          <div class="space-y-2">
            ${blockedStudents.map(s => `
              <div class="flex items-center justify-between p-3 bg-red-50 rounded-xl">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-red-200 text-red-700 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
                  <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div>
                </div>
                <button onclick="toggleBlock('${s.id}', false)" class="px-3 py-1 bg-emerald-600 text-white rounded-lg text-sm">ì°¨ë‹¨ í•´ì œ</button>
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}
        
        <div>
          <div class="text-sm font-medium text-gray-600 mb-2">ì „ì²´ ì›ìƒ</div>
          <div class="max-h-60 overflow-y-auto space-y-2">
            ${students.filter(s => !s.blocked).map(s => `
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
                  <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div>
                </div>
                <button onclick="toggleBlock('${s.id}', true)" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">ì°¨ë‹¨</button>
              </div>
            `).join('')}
            ${students.filter(s => !s.blocked).length === 0 ? '<p class="text-gray-400 text-center py-4">ì›ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>' : ''}
          </div>
        </div>
      </div>
    </div>`;
  }

  h += '</div></main></div>';

  // ëª¨ë‹¬
  if(modal==='addStudent') h += renderStudentModal();
  if(modal==='sms') h += renderSmsModal();
  if(modal==='msg') h += renderMsgModal();
  if(modal==='docPreview' && currentDoc) h += renderDocModal();
  if(modal==='report') h += renderReportModal();
  if(modal==='staff') h += renderStaffModal();
  if(modal==='salary') h += renderSalaryModal();
  if(modal==='post') h += renderPostModal();
  if(modal==='viewPost') h += renderViewPostModal();
  if(modal==='poll') h += renderPollModal();
  if(modal==='event') h += renderEventModal();
  if(modal==='material') h += renderMaterialModal();

  return h;
}

// ë©”ì‹œì§€ ëª¨ë‹¬ (ì›¹ ì•Œë¦¼)
function renderMsgModal(){
  const sel = Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  const names = sel.map(id=>students.find(s=>s.id===id)?.name).filter(Boolean);
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between items-center">
        <span class="font-bold">ğŸ’¬ ë©”ì‹œì§€ ë³´ë‚´ê¸°</span>
        <button onclick="modal='';render()" class="text-gray-400 hover:text-gray-600">âœ•</button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <div class="text-sm text-gray-500 mb-2">ë°›ëŠ” ì‚¬ëŒ (${names.length}ëª…)</div>
          <div class="flex flex-wrap gap-1">
            ${names.map(n=>`<span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">${n}</span>`).join('')}
          </div>
        </div>
        <div class="mb-4">
          <div class="text-sm text-gray-500 mb-2">ë©”ì‹œì§€ ë‚´ìš©</div>
          <textarea id="msgContent" rows="4" class="w-full px-4 py-3 border rounded-xl" placeholder="í•™ë¶€ëª¨/í•™ìƒ ì•±ìœ¼ë¡œ ì „ë‹¬ë  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        <div class="bg-blue-50 rounded-xl p-3 mb-4 text-sm text-blue-700">
          ğŸ’¡ ì´ ë©”ì‹œì§€ëŠ” í•™ë¶€ëª¨/í•™ìƒ ì•±ì— ì•Œë¦¼ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤. (ë¬¸ì ë¹„ìš© ì—†ìŒ)
        </div>
        <button onclick="sendMsg()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
      </div>
    </div>
  </div>`;
}

// ê²Œì‹œê¸€ ì‘ì„± ëª¨ë‹¬
function renderPostModal(){
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-lg">
      <div class="p-4 border-b flex justify-between items-center">
        <span class="font-bold">âœï¸ ê¸€ì“°ê¸°</span>
        <button onclick="modal='';render()" class="text-gray-400">âœ•</button>
      </div>
      <div class="p-4">
        <textarea id="postContent" rows="5" class="w-full px-4 py-3 border rounded-xl resize-none" placeholder="í•™ë¶€ëª¨/í•™ìƒë“¤ê³¼ ê³µìœ í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        
        <!-- ê³µê°œ ë²”ìœ„ ì„ íƒ -->
        <div class="mt-4 p-3 bg-gray-50 rounded-xl">
          <div class="text-sm font-medium text-gray-700 mb-2">ğŸ‘ï¸ ê³µê°œ ë²”ìœ„</div>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 p-2 bg-white rounded-lg cursor-pointer border hover:border-indigo-300">
              <input type="radio" name="visibility" value="all" checked class="w-4 h-4 text-indigo-600">
              <span class="text-sm">ğŸŒ ì „ì²´ ê³µê°œ</span>
            </label>
            <label class="flex items-center gap-2 p-2 bg-white rounded-lg cursor-pointer border hover:border-indigo-300">
              <input type="radio" name="visibility" value="parent" class="w-4 h-4 text-indigo-600">
              <span class="text-sm">ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨ë§Œ</span>
            </label>
            <label class="flex items-center gap-2 p-2 bg-white rounded-lg cursor-pointer border hover:border-indigo-300">
              <input type="radio" name="visibility" value="student" class="w-4 h-4 text-indigo-600">
              <span class="text-sm">ğŸ‘¦ í•™ìƒë§Œ</span>
            </label>
            <label class="flex items-center gap-2 p-2 bg-white rounded-lg cursor-pointer border hover:border-indigo-300">
              <input type="radio" name="visibility" value="member" class="w-4 h-4 text-indigo-600">
              <span class="text-sm">ğŸ‘¤ ì„±ì¸íšŒì›ë§Œ</span>
            </label>
          </div>
        </div>
        
        <div class="flex justify-between items-center mt-4">
          <button class="px-3 py-2 border rounded-xl text-sm">ğŸ“· ì‚¬ì§„ ì¶”ê°€</button>
          <button onclick="savePost()" class="px-6 py-2 bg-indigo-600 text-white rounded-xl">ê²Œì‹œ</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ê²Œì‹œê¸€ ìƒì„¸ ëª¨ë‹¬
function renderViewPostModal(){
  const p = posts.find(x=>x.id===viewPostId);
  if(!p) return '';
  const timeAgo = getTimeAgo(p.created_at);
  
  // ë°ëª¨ìš© ëŒ“ê¸€
  const demoComments = [
    {author:'ê¹€ë¯¼ì¤€ í•™ë¶€ëª¨',content:'ì¢‹ì€ ê¸€ ê°ì‚¬í•©ë‹ˆë‹¤!',time:'2ì‹œê°„ ì „'},
    {author:'ì´ì„œìœ¤ í•™ë¶€ëª¨',content:'ì•„ì´ê°€ í•™ì›ì„ ì •ë§ ì¢‹ì•„í•´ìš” ^^',time:'1ì‹œê°„ ì „'}
  ];
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';viewPostId=null;render();}">
    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
        <span class="font-bold">ê²Œì‹œê¸€</span>
        <button onclick="modal='';viewPostId=null;render()" class="text-gray-400">âœ•</button>
      </div>
      <div class="p-4">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-lg">${p.author_name?.[0]||'?'}</div>
          <div>
            <div class="font-medium">${p.author_name||'ìµëª…'}</div>
            <div class="text-sm text-gray-400">${timeAgo}</div>
          </div>
        </div>
        <p class="whitespace-pre-wrap mb-4">${p.content}</p>
        ${p.images?.length?`<div class="flex gap-2 mb-4">${p.images.map(img=>`<img src="${img}" class="w-full rounded-xl">`).join('')}</div>`:''}
        <div class="flex items-center gap-4 py-3 border-t border-b text-sm">
          <button class="flex items-center gap-1 text-gray-500">â¤ï¸ ${p.likes||0}</button>
          <span class="text-gray-500">ğŸ’¬ ${p.comments||demoComments.length}ê°œ ëŒ“ê¸€</span>
        </div>
        
        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div class="mt-4 space-y-3">
          ${demoComments.map(c=>`
            <div class="flex gap-3">
              <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-sm">${c.author[0]}</div>
              <div class="flex-1 bg-gray-50 rounded-xl p-3">
                <div class="flex justify-between">
                  <span class="font-medium text-sm">${c.author}</span>
                  <span class="text-xs text-gray-400">${c.time}</span>
                </div>
                <p class="text-sm mt-1">${c.content}</p>
              </div>
            </div>
          `).join('')}
        </div>
        
        <!-- ëŒ“ê¸€ ì…ë ¥ -->
        <div class="mt-4 flex gap-2">
          <input type="text" id="commentInput" class="flex-1 px-4 py-2 border rounded-xl" placeholder="ëŒ“ê¸€ ì…ë ¥...">
          <button onclick="addComment()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">ë“±ë¡</button>
        </div>
      </div>
    </div>
  </div>`;
}

// íˆ¬í‘œ ëª¨ë‹¬
function renderPollModal(){
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between items-center">
        <span class="font-bold">ğŸ—³ï¸ íˆ¬í‘œ ë§Œë“¤ê¸°</span>
        <button onclick="modal='';render()" class="text-gray-400">âœ•</button>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="text-sm text-gray-600">íˆ¬í‘œ ì œëª©</label>
          <input type="text" id="pollTitle" class="w-full px-4 py-2 border rounded-xl mt-1" placeholder="ì˜ˆ: ë³´ê°• í¬ë§ ìš”ì¼">
        </div>
        <div>
          <label class="text-sm text-gray-600">ì„ íƒì§€ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
          <textarea id="pollOptions" rows="4" class="w-full px-4 py-2 border rounded-xl mt-1" placeholder="ì›”ìš”ì¼\ní™”ìš”ì¼\nìˆ˜ìš”ì¼"></textarea>
        </div>
        <div>
          <label class="text-sm text-gray-600">ë§ˆê°ì¼</label>
          <input type="date" id="pollEndDate" class="w-full px-4 py-2 border rounded-xl mt-1">
        </div>
        <button onclick="savePoll()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">íˆ¬í‘œ ë§Œë“¤ê¸°</button>
      </div>
    </div>
  </div>`;
}

// ì¼ì • ëª¨ë‹¬
function renderEventModal(){
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between items-center">
        <span class="font-bold">ğŸ“… ì¼ì • ì¶”ê°€</span>
        <button onclick="modal='';render()" class="text-gray-400">âœ•</button>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="text-sm text-gray-600">ì¼ì • ì œëª©</label>
          <input type="text" id="eventTitle" class="w-full px-4 py-2 border rounded-xl mt-1" placeholder="ì˜ˆ: í•™ë¶€ëª¨ ìƒë‹´ ì£¼ê°„">
        </div>
        <div>
          <label class="text-sm text-gray-600">ì„¤ëª…</label>
          <textarea id="eventDesc" rows="2" class="w-full px-4 py-2 border rounded-xl mt-1" placeholder="ì¼ì •ì— ëŒ€í•œ ì„¤ëª…"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">ë‚ ì§œ</label>
            <input type="date" id="eventDate" class="w-full px-4 py-2 border rounded-xl mt-1">
          </div>
          <div>
            <label class="text-sm text-gray-600">ì‹œê°„</label>
            <input type="time" id="eventTime" class="w-full px-4 py-2 border rounded-xl mt-1">
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-600">ì¥ì†Œ</label>
          <input type="text" id="eventLocation" class="w-full px-4 py-2 border rounded-xl mt-1" placeholder="ì˜ˆ: í•™ì› 3ì¸µ ëŒ€ê°•ì˜ì‹¤">
        </div>
        <button onclick="saveEvent()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">ì¼ì • ì¶”ê°€</button>
      </div>
    </div>
  </div>`;
}

// ìë£Œ ëª¨ë‹¬
function renderMaterialModal(){
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between items-center">
        <span class="font-bold">ğŸ“š ìë£Œ ì—…ë¡œë“œ</span>
        <button onclick="modal='';render()" class="text-gray-400">âœ•</button>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="text-sm text-gray-600">ìë£Œ ì œëª©</label>
          <input type="text" id="matTitle" class="w-full px-4 py-2 border rounded-xl mt-1" placeholder="ì˜ˆ: í† ìµ ë¹ˆì¶œ ë‹¨ì–´ 500">
        </div>
        <div>
          <label class="text-sm text-gray-600">ì¹´í…Œê³ ë¦¬</label>
          <select id="matCategory" class="w-full px-4 py-2 border rounded-xl mt-1">
            <option value="ì´ˆë“±ì˜ì–´">ì´ˆë“±ì˜ì–´</option>
            <option value="ì¤‘ë“±ì˜ì–´">ì¤‘ë“±ì˜ì–´</option>
            <option value="í† ìµ">í† ìµ</option>
            <option value="í† í”Œ">í† í”Œ</option>
            <option value="ì˜ì–´íšŒí™”">ì˜ì–´íšŒí™”</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-600">íŒŒì¼</label>
          <input type="file" id="matFile" class="w-full px-4 py-2 border rounded-xl mt-1">
        </div>
        <button onclick="saveMaterial()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">ì—…ë¡œë“œ</button>
      </div>
    </div>
  </div>`;
}

// ì§ì› ëª¨ë‹¬
function renderStaffModal(){
  const s = editingStaffId ? staff.find(x=>x.id===editingStaffId) : null;
  if(s){
    staffFormData = {name:s.name,email:s.email,password:'',role:s.role,permissions:s.permissions||{}};
  }
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){closeStaffModal();}">
    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">${s?'ì§ì› ìˆ˜ì •':'ì§ì› ì¶”ê°€'}</span><button onclick="closeStaffModal()">âœ•</button></div>
      <div class="p-4 space-y-3">
        <input type="text" id="staffName" value="${staffFormData.name}" class="w-full px-4 py-2 border rounded-xl" placeholder="ì´ë¦„ *">
        <input type="email" id="staffEmail" value="${staffFormData.email}" class="w-full px-4 py-2 border rounded-xl" placeholder="ì´ë©”ì¼ (ë¡œê·¸ì¸ìš©) *">
        <input type="password" id="staffPw" class="w-full px-4 py-2 border rounded-xl" placeholder="${s?'ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ì‹œë§Œ)':'ë¹„ë°€ë²ˆí˜¸ *'}">
        <select id="staffRole" class="w-full px-4 py-2 border rounded-xl">
          <option value="staff" ${staffFormData.role==='staff'?'selected':''}>ì§ì›</option>
          <option value="manager" ${staffFormData.role==='manager'?'selected':''}>ë§¤ë‹ˆì €</option>
        </select>
        <div class="bg-gray-50 rounded-xl p-3">
          <div class="text-sm font-medium mb-2">ì ‘ê·¼ ê¶Œí•œ</div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label class="flex items-center gap-2"><input type="checkbox" id="perm_students" ${staffFormData.permissions?.students?'checked':''}> ì›ìƒê´€ë¦¬</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="perm_attendance" ${staffFormData.permissions?.attendance?'checked':''}> ì¶œê²°ê´€ë¦¬</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="perm_payments" ${staffFormData.permissions?.payments?'checked':''}> ìˆ˜ê°•ë£Œ</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="perm_notices" ${staffFormData.permissions?.notices?'checked':''}> ê³µì§€ì‚¬í•­</label>
          </div>
        </div>
        <div class="flex gap-2 pt-2">
          <button onclick="closeStaffModal()" class="flex-1 py-2 border rounded-xl">ì·¨ì†Œ</button>
          <button onclick="saveStaff()" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ê¸‰ì—¬ ëª¨ë‹¬
function renderSalaryModal(){
  const s = staff.find(x=>x.id===editingStaffId);
  const sal = salaries.find(x=>x.staff_id===editingStaffId) || {base_amount:0,bonus:0,deduction:0,paid:false};
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';editingStaffId=null;render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">${s?.name} ê¸‰ì—¬ ìˆ˜ì •</span><button onclick="modal='';editingStaffId=null;render()">âœ•</button></div>
      <div class="p-4 space-y-3">
        <div><label class="text-sm text-gray-600">ê¸°ë³¸ê¸‰</label><input type="number" id="salBase" value="${sal.base_amount||0}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">ìˆ˜ë‹¹</label><input type="number" id="salBonus" value="${sal.bonus||0}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">ê³µì œ</label><input type="number" id="salDeduct" value="${sal.deduction||0}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <label class="flex items-center gap-2"><input type="checkbox" id="salPaid" ${sal.paid?'checked':''}> ì§€ê¸‰ì™„ë£Œ</label>
        <div class="flex gap-2 pt-2">
          <button onclick="modal='';editingStaffId=null;render()" class="flex-1 py-2 border rounded-xl">ì·¨ì†Œ</button>
          <button onclick="saveSalary()" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ë¦¬í¬íŠ¸ ëª¨ë‹¬
function renderReportModal(){
  const s = students.find(x=>x.id===reportStudentId);
  const currentMonth = new Date().toLocaleDateString('ko-KR', {year:'numeric', month:'long'});
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';reportStudentId='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">ğŸ“ˆ ${s?.name||''} í•™ìŠµ ë¦¬í¬íŠ¸</span><button onclick="modal='';reportStudentId='';render()">âœ•</button></div>
      <div class="p-4 space-y-4">
        <div class="bg-blue-50 p-3 rounded-xl text-center">
          <div class="text-sm text-blue-600">${currentMonth}</div>
        </div>
        <div>
          <label class="text-sm font-medium">í•™ìŠµ ë‚´ìš© ë° í‰ê°€</label>
          <textarea id="reportContent" class="w-full p-3 border rounded-xl mt-1" rows="5" placeholder="ì´ë²ˆ ë‹¬ í•™ìŠµ ë‚´ìš©ê³¼ ì„±ì·¨ë„ë¥¼ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
        </div>
        <div>
          <label class="text-sm font-medium">ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</label>
          <textarea id="reportMemo" class="w-full p-3 border rounded-xl mt-1" rows="3" placeholder="í•™ë¶€ëª¨ë‹˜ê»˜ ì „ë‹¬í•  ë©”ì‹œì§€..."></textarea>
        </div>
        <div class="flex gap-2">
          <button onclick="modal='';reportStudentId='';render()" class="flex-1 py-3 border rounded-xl">ì·¨ì†Œ</button>
          <button onclick="saveReport()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ì›ìƒ ìƒì„¸
function renderStudentDetail(){
  const s = students.find(x=>x.id===viewStudentId);
  if(!s) return '<p>ì›ìƒ ì •ë³´ ì—†ìŒ</p>';
  const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d} ${t}`).join(', ') : (s.days||[]).join(' ')+' '+(s.time||'');
  
  let h = '<div class="max-w-2xl">';
  h += `<button onclick="viewStudentId=null;render()" class="mb-4 text-indigo-600">â† ëª©ë¡ìœ¼ë¡œ</button>`;
  
  h += `<div class="bg-white rounded-2xl border p-6 mb-4">
    <div class="flex items-center gap-4 mb-4">
      <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl font-bold">${s.name?.[0]||'?'}</div>
      <div><h2 class="text-xl font-bold">${s.name}</h2><p class="text-gray-500">${s.course||''} Â· ${s.level||''}</p></div>
      <button onclick="openEditStudent('${s.id}')" class="ml-auto px-4 py-2 border rounded-xl text-sm">ìˆ˜ì •</button>
    </div>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div><span class="text-gray-500">ì—°ë½ì²˜</span><div class="font-medium">${s.phone||'-'}</div></div>
      <div><span class="text-gray-500">í•™ë¶€ëª¨</span><div class="font-medium">${s.parent_phone||'-'}</div></div>
      <div><span class="text-gray-500">ìˆ˜ì—…ì¼ì •</span><div class="font-medium">${scheduleStr||'-'}</div></div>
      <div><span class="text-gray-500">ìˆ˜ê°•ë£Œ</span><div class="font-medium ${s.paid?'':'text-red-600'}">${fmt(s.fee||0)} (${s.paid?'ì™„ë£Œ':'ë¯¸ë‚©'})</div></div>
    </div>
  </div>`;

  // ë©”ëª¨
  h += `<div class="bg-white rounded-2xl border p-6 mb-4">
    <h3 class="font-bold mb-3">ğŸ“ ë©”ëª¨</h3>
    <textarea id="studentMemo" class="w-full p-3 border rounded-xl" rows="3" placeholder="ë©”ëª¨ ì…ë ¥...">${s.memo||''}</textarea>
    <button onclick="saveMemo('${s.id}')" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">ì €ì¥</button>
  </div>`;

  h += '</div>';
  return h;
}

// ì›ìƒ ëª¨ë‹¬
function renderStudentModal(){
  const s = editingId ? students.find(x=>x.id===editingId) : null;
  
  let h = `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){closeModal();}">
    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">${s?'ì›ìƒ ìˆ˜ì •':'ì›ìƒ ë“±ë¡'}</span><button onclick="closeModal()">âœ•</button></div>
      <div class="p-4 space-y-3">
        <input type="text" id="sName" value="${formData.name}" oninput="formData.name=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="ì´ë¦„ *">
        <input type="tel" id="sPhone" value="${formData.phone}" oninput="formData.phone=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="ì—°ë½ì²˜">
        <input type="tel" id="sPPhone" value="${formData.pPhone}" oninput="formData.pPhone=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="í•™ë¶€ëª¨ ì—°ë½ì²˜">
        <div class="grid grid-cols-2 gap-2">
          <input type="text" id="sCourse" value="${formData.course}" oninput="formData.course=this.value" class="px-4 py-2 border rounded-xl" placeholder="ê³¼ëª©">
          <input type="text" id="sLevel" value="${formData.level}" oninput="formData.level=this.value" class="px-4 py-2 border rounded-xl" placeholder="ë ˆë²¨">
        </div>
        <div class="bg-indigo-50 rounded-xl p-3">
          <div class="text-sm font-medium mb-2">ìˆ˜ì—… ì¼ì • (ìš”ì¼ë³„ ì‹œê°„)</div>
          <div class="space-y-2">`;
  ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].forEach(d=>{
    const hasDay = formData.schedule[d] !== undefined;
    const time = formData.schedule[d] || '16:00';
    h += `<div class="flex items-center gap-2">
      <button type="button" onclick="toggleDaySchedule('${d}')" class="w-10 h-10 rounded-lg text-sm font-bold ${hasDay?'bg-indigo-600 text-white':'bg-white border'}">${d}</button>
      ${hasDay ? `<input type="time" value="${time}" onchange="formData.schedule['${d}']=this.value" class="flex-1 px-3 py-2 border rounded-lg"><span class="text-xs text-gray-500">${d}ìš”ì¼</span>` : '<span class="text-gray-400 text-sm">ìˆ˜ì—… ì—†ìŒ</span>'}
    </div>`;
  });
  h += `</div></div>
        <input type="number" id="sFee" value="${formData.fee}" oninput="formData.fee=parseInt(this.value)||0" class="w-full px-4 py-2 border rounded-xl" placeholder="ìˆ˜ê°•ë£Œ">
        <label class="flex items-center gap-2"><input type="checkbox" id="sPaid" ${formData.paid?'checked':''} onchange="formData.paid=this.checked" class="w-5 h-5">ë‚©ë¶€ì™„ë£Œ</label>
        <div class="flex gap-2">
          <button onclick="closeModal()" class="flex-1 py-2 border rounded-xl">ì·¨ì†Œ</button>
          ${editingId ? `<button onclick="deleteStudent('${editingId}')" class="py-2 px-4 bg-red-500 text-white rounded-xl">ì‚­ì œ</button>` : ''}
          <button onclick="saveStudent()" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl">${s?'ìˆ˜ì •':'ë“±ë¡'}</button>
        </div>
      </div>
    </div>
  </div>`;
  return h;
}

// SMS ëª¨ë‹¬
function renderSmsModal(){
  const selIds = Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  const selStudents = selIds.map(id=>students.find(s=>s.id===id)).filter(Boolean);
  const defaultMsg = `[${academy.name}]\n\nì•ˆë…•í•˜ì„¸ìš”.\n\n${selStudents.map(s=>s.name).join(', ')} í•™ìƒ ì¶œì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.`;
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">ğŸ“± ë¬¸ì ë³´ë‚´ê¸°</span><button onclick="modal='';render()">âœ•</button></div>
      <div class="p-4">
        <div class="mb-3"><span class="text-sm text-gray-500">ë°›ëŠ” ì‚¬ëŒ</span>
          <div class="flex flex-wrap gap-1 mt-1">${selStudents.map(s=>`<span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">${s.name}</span>`).join('')}</div>
        </div>
        <div class="mb-3"><span class="text-sm text-gray-500">ë‚´ìš©</span><textarea id="smsContent" class="w-full p-3 border rounded-xl mt-1" rows="6">${defaultMsg}</textarea></div>
        <button onclick="sendSMS()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">ë³´ë‚´ê¸°</button>
      </div>
    </div>
  </div>`;
}

// ë¬¸ì„œ ëª¨ë‹¬
function renderDocModal(){
  const d = currentDoc;
  const s = docStudentId ? students.find(x=>x.id===docStudentId) : null;
  const content = getDocContent(d, s);
  
  return `<div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';currentDoc=null;render();}">
    <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[95vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <span class="font-bold">${d.icon} ${d.name}</span>
        <div class="flex gap-2">
          <button onclick="window.print()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">ğŸ–¨ï¸ ì¸ì‡„</button>
          <button onclick="modal='';currentDoc=null;render()" class="px-4 py-2 bg-gray-200 rounded-xl">âœ•</button>
        </div>
      </div>
      <div class="p-2 bg-amber-50 text-amber-800 text-sm text-center">ğŸ’¡ ë¬¸ì„œë¥¼ í´ë¦­í•˜ì—¬ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      <div class="flex-1 overflow-y-auto bg-gray-300 p-6 print-area">
        <div id="docContent" contenteditable="true" class="bg-white shadow-xl mx-auto cursor-text" style="width:210mm;min-height:297mm;padding:20mm;">${content}</div>
      </div>
    </div>
  </div>`;
}

function getDocContent(doc, stu){
  const s = stu || {name:'___________',course:'___________',level:'___',phone:'_______________',fee:0};
  const a = academy;
  const header = `<div style="border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:30px;text-align:center;"><div style="font-size:16pt;font-weight:bold;">${a.name}</div><div style="font-size:9pt;color:#666;">${a.address||''} | Tel: ${a.phone||''}</div></div>`;
  const footer = `<div style="margin-top:80px;text-align:center;"><p>${todayStr}</p><p style="font-size:14pt;font-weight:bold;margin-top:30px;">${a.name}</p><p>ì›ì¥ ${a.owner} (ì¸)</p></div>`;
  
  if(doc.name==='ì¬ì›ì¦ëª…ì„œ') return header+`<h1 style="text-align:center;font-size:24pt;letter-spacing:10px;margin:50px 0;">ì¬ ì› ì¦ ëª… ì„œ</h1><table style="width:100%;border-collapse:collapse;margin:30px 0;"><tr><td style="border:1px solid #333;padding:12px;width:25%;background:#f5f5f5;font-weight:bold;">ì„± ëª…</td><td style="border:1px solid #333;padding:12px;">${s.name}</td></tr><tr><td style="border:1px solid #333;padding:12px;background:#f5f5f5;font-weight:bold;">ìˆ˜ê°•ê³¼ëª©</td><td style="border:1px solid #333;padding:12px;">${s.course||''}</td></tr><tr><td style="border:1px solid #333;padding:12px;background:#f5f5f5;font-weight:bold;">ë ˆ ë²¨</td><td style="border:1px solid #333;padding:12px;">${s.level||''}</td></tr></table><div style="text-align:center;margin:60px 0;font-size:14pt;">ìœ„ í•™ìƒì€ ë³¸ í•™ì›ì— ì¬ì› ì¤‘ì„ì„ ì¦ëª…í•©ë‹ˆë‹¤.</div>`+footer;
  
  if(doc.name==='ìˆ˜ê°•ë£Œì˜ìˆ˜ì¦') return header+`<h1 style="text-align:center;font-size:24pt;letter-spacing:10px;margin:50px 0;">ì˜ ìˆ˜ ì¦</h1><div style="text-align:center;margin:40px 0;padding:30px;border:3px solid #333;"><p>ê¸ˆ ì•¡</p><p style="font-size:28pt;font-weight:bold;color:#c00;">${(s.fee||0).toLocaleString()}ì›</p></div><table style="width:100%;border-collapse:collapse;"><tr><td style="border:1px solid #333;padding:12px;width:25%;background:#f5f5f5;">ë‚´ ìš©</td><td style="border:1px solid #333;padding:12px;">${s.course||''} ìˆ˜ê°•ë£Œ</td></tr><tr><td style="border:1px solid #333;padding:12px;background:#f5f5f5;">ì› ìƒ</td><td style="border:1px solid #333;padding:12px;">${s.name}</td></tr></table><p style="text-align:center;margin:50px 0;">ìœ„ ê¸ˆì•¡ì„ ì •íˆ ì˜ìˆ˜í•¨.</p>`+footer;
  
  return header+`<h1 style="text-align:center;font-size:22pt;margin:50px 0;">${doc.name}</h1><p style="text-align:center;color:#666;margin:30px 0;">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>`+footer;
}

// í•¨ìˆ˜ë“¤
function openAddStudent(){
  editingId = null;
  formData = {name:'',phone:'',pPhone:'',course:'',level:'',fee:200000,paid:false,schedule:{},memo:''};
  modal = 'addStudent';
  render();
}

function openEditStudent(id){
  const s = students.find(x=>x.id===id);
  if(!s) return;
  editingId = id;
  formData = {
    name: s.name || '',
    phone: s.phone || '',
    pPhone: s.parent_phone || '',
    course: s.course || '',
    level: s.level || '',
    fee: s.fee || 200000,
    paid: s.paid || false,
    schedule: s.schedule || {},
    memo: s.memo || ''
  };
  if(!s.schedule && s.days && s.days.length){
    formData.schedule = {};
    s.days.forEach(d => { formData.schedule[d] = s.time || '16:00'; });
  }
  modal = 'addStudent';
  render();
}

function closeModal(){
  modal = '';
  editingId = null;
  render();
}

function toggleDaySchedule(d){
  if(formData.schedule[d] !== undefined){
    delete formData.schedule[d];
  } else {
    formData.schedule[d] = '16:00';
  }
  render();
}

async function saveStudent(){
  if(!formData.name){alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  const data = {
    academy_id: academy.id,
    name: formData.name,
    phone: formData.phone,
    parent_phone: formData.pPhone,
    course: formData.course,
    level: formData.level,
    fee: formData.fee,
    paid: formData.paid,
    schedule: formData.schedule,
    days: Object.keys(formData.schedule),
    time: Object.values(formData.schedule)[0] || '',
    memo: formData.memo
  };
  loading=true;render();
  if(editingId){
    await db.from('students').update(data).eq('id',editingId);
  } else {
    await db.from('students').insert(data);
  }
  await loadData();
  modal='';editingId=null;
  loading=false;render();
}

async function deleteStudent(id){
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  loading=true;render();
  await db.from('students').delete().eq('id',id);
  await loadData();
  modal='';editingId=null;viewStudentId=null;
  loading=false;render();
}

async function saveMemo(id){
  const memo = document.getElementById('studentMemo').value;
  await db.from('students').update({memo}).eq('id',id);
  const s = students.find(x=>x.id===id);
  if(s) s.memo = memo;
  alert('ì €ì¥ ì™„ë£Œ!');
}

async function toggleAtt(id){
  const exists = attendance[id];
  if(exists){
    await db.from('attendance').delete().eq('student_id',id).eq('date',todayISO);
    // í¬ì¸íŠ¸ ì°¨ê°
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: Math.max(0, (s.points || 0) - 10) }).eq('id', id);
    }
    delete attendance[id];
  } else {
    await db.from('attendance').insert({student_id:id,date:todayISO,status:'ì¶œì„'});
    // í¬ì¸íŠ¸ ì¶”ê°€
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: (s.points || 0) + 10 }).eq('id', id);
    }
    attendance[id]='ì¶œì„';
  }
  await loadData();
  render();
}

function toggleSelect(id){selectedStudents[id]=!selectedStudents[id];render();}

async function markPaid(id){
  await db.from('students').update({paid:true,paid_date:todayISO}).eq('id',id);
  await loadData();
  render();
}

async function addTodo(){
  const text=prompt('í•  ì¼:');
  if(!text)return;
  await db.from('todos').insert({academy_id:academy.id,text});
  await loadData();
  render();
}

async function toggleTodo(id){
  const t=todos.find(x=>x.id===id);
  if(t){
    await db.from('todos').update({done:!t.done}).eq('id',id);
    await loadData();
    render();
  }
}

async function deleteTodo(id){
  await db.from('todos').delete().eq('id',id);
  await loadData();
  render();
}

async function addNotice(){
  const title=prompt('ê³µì§€ ì œëª©:');
  if(!title)return;
  const content=prompt('ë‚´ìš©:')||'';
  await db.from('notices').insert({academy_id:academy.id,title,content});
  await loadData();
  render();
}

async function deleteNotice(id){
  if(confirm('ì‚­ì œ?')){
    await db.from('notices').delete().eq('id',id);
    await loadData();
    render();
  }
}

// ì‹œê°„ ê²½ê³¼ í‘œì‹œ
function getTimeAgo(dateStr){
  const now = new Date();
  const date = new Date(dateStr);
  const diff = Math.floor((now - date) / 1000);
  if(diff < 60) return 'ë°©ê¸ˆ ì „';
  if(diff < 3600) return Math.floor(diff/60) + 'ë¶„ ì „';
  if(diff < 86400) return Math.floor(diff/3600) + 'ì‹œê°„ ì „';
  if(diff < 604800) return Math.floor(diff/86400) + 'ì¼ ì „';
  return date.toLocaleDateString('ko-KR');
}

// ì»¤ë®¤ë‹ˆí‹° í•¨ìˆ˜ë“¤
function openPostModal(){
  modal = 'post';
  editingPostId = null;
  render();
}

async function savePost(){
  const content = document.getElementById('postContent').value;
  if(!content.trim()){alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  const visibility = document.querySelector('input[name="visibility"]:checked')?.value || 'all';
  const visibilityLabel = {all:'ì „ì²´',parent:'í•™ë¶€ëª¨ë§Œ',student:'í•™ìƒë§Œ',member:'ì„±ì¸íšŒì›ë§Œ'}[visibility];
  
  if(isDemo){
    posts.unshift({
      id:'post'+Date.now(),
      academy_id:'demo',
      author_type:'admin',
      author_name:academy.owner+' ì›ì¥',
      content,
      visibility,
      images:[],
      pinned:false,
      created_at:new Date().toISOString(),
      likes:0,
      comments:0
    });
    modal='';render();
    return;
  }
  
  await db.from('posts').insert({
    academy_id:academy.id,
    author_type:'admin',
    author_name:academy.owner+' ì›ì¥',
    content,
    visibility
  });
  modal='';
  await loadData();
  render();
}

async function deletePost(id){
  if(!confirm('ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(isDemo){
    posts = posts.filter(p=>p.id!==id);
    render();return;
  }
  await db.from('posts').delete().eq('id',id);
  await loadData();render();
}

async function togglePin(id){
  const p = posts.find(x=>x.id===id);
  if(!p)return;
  if(isDemo){
    p.pinned = !p.pinned;
    render();return;
  }
  await db.from('posts').update({pinned:!p.pinned}).eq('id',id);
  await loadData();render();
}

async function toggleLike(id){
  const p = posts.find(x=>x.id===id);
  if(!p)return;
  if(isDemo){
    p.likes = (p.likes||0) + 1;
    render();return;
  }
  // ì‹¤ì œë¡œëŠ” post_likes í…Œì´ë¸” í™•ì¸ í•„ìš”
  await db.from('posts').update({likes:(p.likes||0)+1}).eq('id',id);
  await loadData();render();
}

function viewPost(id){
  viewPostId = id;
  modal = 'viewPost';
  render();
}

// íˆ¬í‘œ í•¨ìˆ˜ë“¤
function openPollModal(){
  modal = 'poll';
  render();
}

async function savePoll(){
  const title = document.getElementById('pollTitle').value;
  const optionsText = document.getElementById('pollOptions').value;
  const endDate = document.getElementById('pollEndDate').value;
  if(!title||!optionsText){alert('ì œëª©ê³¼ ì˜µì…˜ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  const options = optionsText.split('\n').filter(x=>x.trim());
  if(options.length < 2){alert('ì˜µì…˜ì„ 2ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  if(isDemo){
    polls.unshift({
      id:'poll'+Date.now(),
      academy_id:'demo',
      title,
      options,
      end_date:endDate,
      created_at:new Date().toISOString(),
      votes:{}
    });
    modal='';render();
    return;
  }
  
  await db.from('polls').insert({academy_id:academy.id,title,options,end_date:endDate});
  modal='';await loadData();render();
}

async function deletePoll(id){
  if(!confirm('íˆ¬í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(isDemo){polls=polls.filter(p=>p.id!==id);render();return;}
  await db.from('polls').delete().eq('id',id);
  await loadData();render();
}

// ì¼ì • í•¨ìˆ˜ë“¤
function openEventModal(){
  modal = 'event';
  render();
}

async function saveEvent(){
  const title = document.getElementById('eventTitle').value;
  const description = document.getElementById('eventDesc').value;
  const eventDate = document.getElementById('eventDate').value;
  const eventTime = document.getElementById('eventTime').value;
  const location = document.getElementById('eventLocation').value;
  if(!title||!eventDate){alert('ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  if(isDemo){
    events.push({
      id:'ev'+Date.now(),
      academy_id:'demo',
      title,description,event_date:eventDate,event_time:eventTime,location,
      created_at:new Date().toISOString(),
      rsvp:{yes:0,no:0,maybe:0}
    });
    events.sort((a,b)=>new Date(a.event_date)-new Date(b.event_date));
    modal='';render();
    return;
  }
  
  await db.from('events').insert({academy_id:academy.id,title,description,event_date:eventDate,event_time:eventTime,location});
  modal='';await loadData();render();
}

async function deleteEvent(id){
  if(!confirm('ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(isDemo){events=events.filter(e=>e.id!==id);render();return;}
  await db.from('events').delete().eq('id',id);
  await loadData();render();
}

// ìë£Œì‹¤ í•¨ìˆ˜ë“¤
function openMaterialModal(){
  modal = 'material';
  render();
}

async function saveMaterial(){
  const title = document.getElementById('matTitle').value;
  const category = document.getElementById('matCategory').value;
  if(!title){alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  if(isDemo){
    materials.unshift({
      id:'mat'+Date.now(),
      academy_id:'demo',
      title,category,
      file_url:'#',file_type:'pdf',downloads:0,
      created_at:new Date().toISOString()
    });
    modal='';render();
    return;
  }
  
  // ì‹¤ì œë¡œëŠ” íŒŒì¼ ì—…ë¡œë“œ í•„ìš”
  await db.from('materials').insert({academy_id:academy.id,title,category,file_url:'#',file_type:'pdf'});
  modal='';await loadData();render();
}

async function deleteMaterial(id){
  if(!confirm('ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(isDemo){materials=materials.filter(m=>m.id!==id);render();return;}
  await db.from('materials').delete().eq('id',id);
  await loadData();render();
}

function downloadMaterial(id){
  const m = materials.find(x=>x.id===id);
  if(m){
    if(isDemo){m.downloads = (m.downloads||0)+1;render();}
    alert('ë‹¤ìš´ë¡œë“œ ì‹œì‘! (ì‹¤ì œ íŒŒì¼ ì—°ë™ í•„ìš”)');
  }
}

// ê±´ì˜í•¨ í•¨ìˆ˜ë“¤
async function replySuggestion(id){
  const el = document.getElementById('sugReply'+id);
  if(!el||!el.value.trim()){alert('ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  if(isDemo){
    const s = suggestions.find(x=>x.id===id);
    if(s) s.reply = el.value;
    render();return;
  }
  
  await db.from('suggestions').update({reply:el.value}).eq('id',id);
  await loadData();render();
}

// ìƒì¼ ì¶•í•˜
function sendBirthdayMsg(studentId){
  const s = students.find(x=>x.id===studentId);
  if(!s)return;
  alert(`ğŸ‚ ${s.name}ë‹˜ì—ê²Œ ìƒì¼ ì¶•í•˜ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!`);
}

async function sendReply(id){
  const el=document.getElementById('reply'+id);
  if(!el||!el.value)return;
  await db.from('consults').update({reply:el.value,status:'ì™„ë£Œ'}).eq('id',id);
  await loadData();
  render();
}

async function addHomework(studentId){
  const title=prompt('ê³¼ì œ:');
  if(!title)return;
  await db.from('homework').insert({student_id:studentId,title});
  await loadData();
  render();
}

async function toggleHomework(id){
  const hw=homework.find(x=>x.id===id);
  if(hw){
    await db.from('homework').update({done:!hw.done}).eq('id',id);
    await loadData();
    render();
  }
}

async function deleteHomework(id){
  await db.from('homework').delete().eq('id',id);
  await loadData();
  render();
}

function openDoc(id){
  currentDoc = docs.find(d=>d.id===id);
  modal = 'docPreview';
  render();
}

function openSmsModal(){
  const sel=Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  if(!sel.length){alert('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”');return;}
  modal='sms';render();
}

function openMsgModal(){
  const sel=Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  if(!sel.length){alert('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”');return;}
  modal='msg';render();
}

function sendSMS(){
  const content=document.getElementById('smsContent').value;
  alert('ë¬¸ì ë°œì†¡!\n(ì‹¤ì œ ë°œì†¡ì€ Aligo ì—°ë™ í•„ìš”)\n\n'+content);
  modal='';selectedStudents={};render();
}

async function sendMsg(){
  const content=document.getElementById('msgContent').value;
  if(!content.trim()){alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  const sel = Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  
  if(isDemo){
    alert(`ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ!\n\në°›ëŠ” ì‚¬ëŒ: ${sel.length}ëª…\në‚´ìš©: ${content}\n\n(ë°ëª¨ì—ì„œëŠ” ì‹¤ì œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)`);
    modal='';selectedStudents={};render();
    return;
  }
  
  // ì‹¤ì œë¡œëŠ” DBì— ì•Œë¦¼ ì €ì¥
  for(const studentId of sel){
    await db.from('notifications').insert({
      academy_id: academy.id,
      student_id: studentId,
      message: content,
      read: false
    });
  }
  
  alert(`ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ! (${sel.length}ëª…)`);
  modal='';selectedStudents={};render();
}

async function saveSettings(){
  const data = {
    name: document.getElementById('setName').value,
    owner: document.getElementById('setOwner').value,
    address: document.getElementById('setAddress').value,
    phone: document.getElementById('setPhone').value
  };
  await db.from('academies').update(data).eq('id',academy.id);
  academy = {...academy,...data};
  alert('ì €ì¥ ì™„ë£Œ!');
  render();
}

// URL ë³µì‚¬
function copyUrl(type){
  const url = `https://wonpro.pages.dev/${type}/${academy.code}`;
  navigator.clipboard.writeText(url).then(()=>{
    alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n'+url);
  }).catch(()=>{
    prompt('URLì„ ë³µì‚¬í•˜ì„¸ìš”:', url);
  });
}

// ì ‘ì† í—ˆìš© í† ê¸€
async function toggleAccess(type){
  const field = type === 'parent' ? 'allow_parent' : type === 'student' ? 'allow_student' : 'allow_member';
  const el = document.getElementById(type === 'parent' ? 'allowParent' : type === 'student' ? 'allowStudent' : 'allowMember');
  const value = el.checked;
  
  if(isDemo){
    academy[field] = value;
    render();
    return;
  }
  
  await db.from('academies').update({[field]: value}).eq('id', academy.id);
  academy[field] = value;
  
  const label = type === 'parent' ? 'í•™ë¶€ëª¨' : type === 'student' ? 'í•™ìƒ' : 'ì„±ì¸íšŒì›';
  alert(`${label} ì ‘ì†ì´ ${value ? 'í—ˆìš©' : 'ì°¨ë‹¨'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ì›ìƒ ì°¨ë‹¨/í•´ì œ
async function toggleBlock(studentId, block){
  const s = students.find(x => x.id === studentId);
  if(!s) return;
  
  if(!confirm(`${s.name}ë‹˜ì„ ${block ? 'ì°¨ë‹¨' : 'ì°¨ë‹¨ í•´ì œ'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  
  if(isDemo){
    s.blocked = block;
    render();
    return;
  }
  
  await db.from('students').update({blocked: block}).eq('id', studentId);
  s.blocked = block;
  render();
}

function downloadExcel(){
  const data=students.map(s=>{
    const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d}${t}`).join(' ') : '';
    return {ì´ë¦„:s.name,ì—°ë½ì²˜:s.phone,ê³¼ëª©:s.course,ë ˆë²¨:s.level,ìˆ˜ê°•ë£Œ:s.fee,ë‚©ë¶€:s.paid?'ì™„ë£Œ':'ë¯¸ë‚©',ìˆ˜ì—…ì¼ì •:scheduleStr};
  });
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'ì›ìƒ');
  XLSX.writeFile(wb,'ì›ìƒëª©ë¡.xlsx');
}

// ì‚¬ì§„ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜
function resizeImage(file, maxWidth = 1200) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob((blob) => {
          resolve(blob);
        }, 'image/jpeg', 0.8);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ì‚¬ì§„ ì—…ë¡œë“œ
async function uploadPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  
  // ì›” ì—…ë¡œë“œ ì œí•œ ì²´í¬
  const thisMonth = photos.filter(p => {
    const d = new Date(p.created_at);
    const now = new Date();
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
  
  if (thisMonth.length >= 50) {
    alert('ì›” 50ì¥ ì—…ë¡œë“œ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!photoStudentId) {
    alert('ì›ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  
  loading = true;
  render();
  
  try {
    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
    const resizedBlob = await resizeImage(file);
    
    // Supabase Storage ì—…ë¡œë“œ
    const fileName = `${academy.id}/${Date.now()}.jpg`;
    const { data: uploadData, error: uploadError } = await db.storage
      .from('photos')
      .upload(fileName, resizedBlob, { contentType: 'image/jpeg' });
    
    if (uploadError) {
      // Storage ë²„í‚·ì´ ì—†ìœ¼ë©´ Base64ë¡œ ì €ì¥ (ëŒ€ì•ˆ)
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64 = e.target.result;
        const caption = prompt('ì‚¬ì§„ ì„¤ëª… (ì„ íƒ):') || '';
        
        await db.from('photos').insert({
          academy_id: academy.id,
          student_id: photoStudentId,
          url: base64,
          caption
        });
        
        await loadData();
        loading = false;
        photoStudentId = '';
        render();
        alert('ì—…ë¡œë“œ ì™„ë£Œ!');
      };
      reader.readAsDataURL(resizedBlob);
      return;
    }
    
    // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
    const { data: urlData } = db.storage.from('photos').getPublicUrl(fileName);
    const caption = prompt('ì‚¬ì§„ ì„¤ëª… (ì„ íƒ):') || '';
    
    await db.from('photos').insert({
      academy_id: academy.id,
      student_id: photoStudentId,
      url: urlData.publicUrl,
      caption
    });
    
    await loadData();
    loading = false;
    photoStudentId = '';
    render();
    alert('ì—…ë¡œë“œ ì™„ë£Œ!');
    
  } catch (err) {
    console.error(err);
    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    loading = false;
    render();
  }
}

// ì‚¬ì§„ ì‚­ì œ
async function deletePhoto(id) {
  if (!confirm('ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  await db.from('photos').delete().eq('id', id);
  await loadData();
  render();
}

// í•™ìŠµ ë¦¬í¬íŠ¸ ëª¨ë‹¬
function openReportModal(studentId) {
  reportStudentId = studentId;
  modal = 'report';
  render();
}

// í•™ìŠµ ë¦¬í¬íŠ¸ ì €ì¥
async function saveReport() {
  const content = document.getElementById('reportContent').value;
  const memo = document.getElementById('reportMemo').value;
  const currentMonth = new Date().toISOString().slice(0,7);
  
  await db.from('reports').insert({
    student_id: reportStudentId,
    month: currentMonth,
    content,
    memo,
    attendance_rate: 90,
    homework_rate: 85
  });
  
  await loadData();
  modal = '';
  reportStudentId = '';
  render();
  alert('ë¦¬í¬íŠ¸ ì €ì¥ ì™„ë£Œ!');
}

// ë³´ê°• ì²˜ë¦¬
async function handleMakeup(id, status) {
  await db.from('makeups').update({ status }).eq('id', id);
  await loadData();
  render();
}

// ì±„íŒ… ì „ì†¡
async function sendChat() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message || !chatStudentId) return;
  
  await db.from('chats').insert({
    academy_id: academy.id,
    student_id: chatStudentId,
    sender: 'admin',
    message
  });
  
  input.value = '';
  await loadData();
  render();
  
  // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ
  setTimeout(() => {
    const chatDiv = document.getElementById('chatMessages');
    if (chatDiv) chatDiv.scrollTop = chatDiv.scrollHeight;
  }, 100);
}

// í¬ì¸íŠ¸ ì¡°ì •
async function adjustPoints(studentId) {
  const s = students.find(x => x.id === studentId);
  const current = s?.points || 0;
  const input = prompt(`${s.name}ì˜ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${current}ì )`, current);
  if (input === null) return;
  
  const newPoints = parseInt(input) || 0;
  await db.from('students').update({ points: newPoints }).eq('id', studentId);
  await loadData();
  render();
}

// ì¶œì„ ì‹œ í¬ì¸íŠ¸ ì¶”ê°€ (toggleAtt ìˆ˜ì •)
async function toggleAttWithPoints(id) {
  const exists = attendance[id];
  if (exists) {
    await db.from('attendance').delete().eq('student_id', id).eq('date', todayISO);
    // í¬ì¸íŠ¸ ì°¨ê°
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: Math.max(0, (s.points || 0) - 10) }).eq('id', id);
    }
    delete attendance[id];
  } else {
    await db.from('attendance').insert({ student_id: id, date: todayISO, status: 'ì¶œì„' });
    // í¬ì¸íŠ¸ ì¶”ê°€
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: (s.points || 0) + 10 }).eq('id', id);
    }
    attendance[id] = 'ì¶œì„';
  }
  await loadData();
  render();
}

// ========== Business ê¸°ëŠ¥ ==========

// ì§ì› ëª¨ë‹¬ ì—´ê¸°
function openStaffModal(){
  editingStaffId = null;
  staffFormData = {name:'',email:'',password:'',role:'staff',permissions:{}};
  modal = 'staff';
  render();
}

function closeStaffModal(){
  modal = '';
  editingStaffId = null;
  staffFormData = {name:'',email:'',password:'',role:'staff',permissions:{}};
  render();
}

function editStaff(id){
  editingStaffId = id;
  modal = 'staff';
  render();
}

// ì§ì› ì €ì¥
async function saveStaff(){
  const name = document.getElementById('staffName').value.trim();
  const email = document.getElementById('staffEmail').value.trim();
  const password = document.getElementById('staffPw').value;
  const role = document.getElementById('staffRole').value;
  const permissions = {
    students: document.getElementById('perm_students').checked,
    attendance: document.getElementById('perm_attendance').checked,
    payments: document.getElementById('perm_payments').checked,
    notices: document.getElementById('perm_notices').checked
  };
  
  if(!name || !email){alert('ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  if(!editingStaffId && !password){alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  if(editingStaffId){
    const updateData = {name, email, role, permissions};
    if(password) updateData.password = password;
    await db.from('staff').update(updateData).eq('id', editingStaffId);
  } else {
    await db.from('staff').insert({
      academy_id: academy.id,
      name, email, password, role, permissions
    });
  }
  
  closeStaffModal();
  await loadData();
  render();
}

// ì§ì› ì‚­ì œ
async function deleteStaff(id){
  if(!confirm('ì´ ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await db.from('staff').delete().eq('id', id);
  await loadData();
  render();
}

// ì§ì› ì¶œê·¼
async function staffCheckIn(staffId){
  const now = new Date().toTimeString().slice(0,5);
  await db.from('staff_attendance').insert({
    staff_id: staffId,
    date: todayISO,
    check_in: now,
    status: 'ì¶œê·¼'
  });
  await loadData();
  render();
}

// ì§ì› í‡´ê·¼
async function staffCheckOut(staffId){
  const now = new Date().toTimeString().slice(0,5);
  const att = staffAttendance.find(a => a.staff_id === staffId);
  if(att){
    await db.from('staff_attendance').update({check_out: now}).eq('id', att.id);
  }
  await loadData();
  render();
}

// ê¸‰ì—¬ ìˆ˜ì • ëª¨ë‹¬
function editSalary(staffId){
  editingStaffId = staffId;
  modal = 'salary';
  render();
}

// ê¸‰ì—¬ ì €ì¥
async function saveSalary(){
  const base = parseInt(document.getElementById('salBase').value) || 0;
  const bonus = parseInt(document.getElementById('salBonus').value) || 0;
  const deduction = parseInt(document.getElementById('salDeduct').value) || 0;
  const paid = document.getElementById('salPaid').checked;
  const currentMonth = new Date().toISOString().slice(0,7);
  
  const existing = salaries.find(s => s.staff_id === editingStaffId);
  
  if(existing){
    await db.from('salaries').update({
      base_amount: base,
      bonus,
      deduction,
      paid,
      paid_date: paid ? todayISO : null
    }).eq('id', existing.id);
  } else {
    await db.from('salaries').insert({
      staff_id: editingStaffId,
      month: currentMonth,
      base_amount: base,
      bonus,
      deduction,
      paid,
      paid_date: paid ? todayISO : null
    });
  }
  
  modal = '';
  editingStaffId = null;
  await loadData();
  render();
}

// ì§€ì  ì¶”ê°€ ëª¨ë‹¬
function openBranchModal(){
  const name = prompt('ì§€ì ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');
  if(!name) return;
  addBranch(name);
}

// ì§€ì  ì¶”ê°€
async function addBranch(branchName){
  await db.from('academies').insert({
    name: branchName,
    branch_name: branchName,
    parent_id: academy.id,
    owner: academy.owner
  });
  await loadData();
  render();
}

// ì§€ì  ì‚­ì œ
async function deleteBranch(id){
  if(!confirm('ì´ ì§€ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await db.from('academies').delete().eq('id', id);
  await loadData();
  render();
}

// ì§€ì  ì „í™˜
async function switchBranch(id){
  const branch = branches.find(b => b.id === id);
  if(branch){
    academy = branch;
    await loadData();
    render();
    alert(`${branch.branch_name || branch.name} ì§€ì ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }
}

render();
</script>
</body>
</html>
