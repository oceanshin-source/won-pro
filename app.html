<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì›ìƒê´€ë¦¬ Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{font-family:-apple-system,'Malgun Gothic',sans-serif;box-sizing:border-box}
    .sidebar-item.active{background:rgba(99,102,241,.15);color:#4f46e5;border-right:3px solid #4f46e5}
  </style>
</head>
<body class="bg-gray-100">
<div id="app"></div>
<script>
const SUPABASE_URL = 'https://sniabexwdgeepakkxxek.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuaWFiZXh3ZGdlZXBha2t4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MDMxNzIsImV4cCI6MjA4NTA3OTE3Mn0.RsDQDyawjFk5voFLVouXDlTIXvhPrsziCD37ne-1jMU';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let page = 'login';
let academy = null;
let admin = null;
let students = [];
let notices = [];
let consults = [];
let todos = [];
let attendance = {};
let tab = 'dashboard';
let modal = '';
let editingId = null;
let selectedStudents = {};
let attTab = 'today';
let viewStudentId = null;
let loading = false;

// ì›ìƒ ë“±ë¡ í¼ ìƒíƒœ (renderí•´ë„ ìœ ì§€)
let formData = {
  name: '', phone: '', pPhone: '', course: '', level: '', fee: 200000, paid: false,
  schedule: {} // {ì›”: '15:00', ìˆ˜: '17:00', ê¸ˆ: '15:00'}
};

const dayList = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
const today = dayList[new Date().getDay()];
const yesterday = dayList[(new Date().getDay()+6)%7];
const tomorrow = dayList[(new Date().getDay()+1)%7];
const todayStr = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
const todayISO = new Date().toISOString().split('T')[0];

function fmt(n){return n>=10000?(n/10000).toFixed(0)+'ë§Œ':n.toLocaleString();}
function getStudentsByDay(day){
  return students.filter(s=>{
    if(s.schedule && typeof s.schedule === 'object') return s.schedule[day];
    return s.days && s.days.includes(day);
  }).sort((a,b)=>{
    const tA = s.schedule?.[day] || s.time || '';
    const tB = s.schedule?.[day] || s.time || '';
    return tA.localeCompare(tB);
  });
}
function getStudentTime(s, day){
  if(s.schedule && typeof s.schedule === 'object') return s.schedule[day] || '';
  return s.time || '';
}

function render(){
  const app = document.getElementById('app');
  if(loading){app.innerHTML='<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-4xl mb-4">â³</div><p>ë¡œë”©ì¤‘...</p></div></div>';return;}
  if(page==='login') app.innerHTML = renderLogin();
  else if(page==='register') app.innerHTML = renderRegister();
  else if(page==='main') app.innerHTML = renderMain();
}

function renderLogin(){
  return `
  <div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-800 flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-4xl">ğŸ“š</div>
        <h1 class="text-3xl font-bold text-white">ì›ìƒê´€ë¦¬ Pro</h1>
        <p class="text-indigo-200 mt-2">í•™ì› ê´€ë¦¬ì˜ ìƒˆë¡œìš´ ì‹œì‘</p>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-bold mb-4">ë¡œê·¸ì¸</h2>
        <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 border rounded-xl mb-4">
        <button onclick="doLogin()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">ë¡œê·¸ì¸</button>
        <p class="text-center mt-4 text-gray-500">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button onclick="page='register';render()" class="text-indigo-600 font-medium">íšŒì›ê°€ì…</button></p>
      </div>
    </div>
  </div>`;
}

function renderRegister(){
  return `
  <div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-800 flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-4xl">ğŸ“š</div>
        <h1 class="text-3xl font-bold text-white">ì›ìƒê´€ë¦¬ Pro</h1>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-bold mb-4">íšŒì›ê°€ì…</h2>
        <input type="text" id="regAcademy" placeholder="í•™ì›ëª… *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="text" id="regOwner" placeholder="ì›ì¥ë‹˜ ì„±í•¨ *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="tel" id="regPhone" placeholder="ì—°ë½ì²˜" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="text" id="regAddress" placeholder="ì£¼ì†Œ" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="email" id="regEmail" placeholder="ì´ë©”ì¼ (ë¡œê·¸ì¸ìš©) *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="password" id="regPw" placeholder="ë¹„ë°€ë²ˆí˜¸ *" class="w-full px-4 py-3 border rounded-xl mb-4">
        <button onclick="doRegister()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">ê°€ì…í•˜ê¸°</button>
        <p class="text-center mt-4 text-gray-500">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="page='login';render()" class="text-indigo-600 font-medium">ë¡œê·¸ì¸</button></p>
      </div>
    </div>
  </div>`;
}

async function doRegister(){
  const name = document.getElementById('regAcademy').value;
  const owner = document.getElementById('regOwner').value;
  const phone = document.getElementById('regPhone').value;
  const address = document.getElementById('regAddress').value;
  const email = document.getElementById('regEmail').value;
  const pw = document.getElementById('regPw').value;
  if(!name||!owner||!email||!pw){alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  loading=true;render();
  const {data:academyData,error:err1} = await db.from('academies').insert({name,owner,phone,address}).select().single();
  if(err1){alert('í•™ì› ë“±ë¡ ì‹¤íŒ¨: '+err1.message);loading=false;render();return;}
  const {data:adminData,error:err2} = await db.from('admins').insert({academy_id:academyData.id,email,password:pw}).select().single();
  if(err2){alert('ê´€ë¦¬ì ë“±ë¡ ì‹¤íŒ¨: '+err2.message);loading=false;render();return;}
  alert('ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•˜ì„¸ìš”.');
  loading=false;page='login';render();
}

async function doLogin(){
  const email = document.getElementById('loginEmail').value;
  const pw = document.getElementById('loginPw').value;
  if(!email||!pw){alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  loading=true;render();
  const {data,error} = await db.from('admins').select('*,academies(*)').eq('email',email).eq('password',pw).single();
  if(error||!data){alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ í™•ì¸');loading=false;render();return;}
  admin = data;
  academy = data.academies;
  await loadData();
  loading=false;page='main';render();
}

async function loadData(){
  const {data:s} = await db.from('students').select('*').eq('academy_id',academy.id);
  students = s || [];
  const {data:n} = await db.from('notices').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  notices = n || [];
  const {data:t} = await db.from('todos').select('*').eq('academy_id',academy.id);
  todos = t || [];
  const {data:a} = await db.from('attendance').select('*').eq('date',todayISO);
  attendance = {};
  (a||[]).forEach(att=>{attendance[att.student_id]=att.status;});
}

function logout(){
  admin=null;academy=null;students=[];notices=[];todos=[];attendance={};
  page='login';render();
}

function renderMain(){
  const todayS = getStudentsByDay(today);
  const tomorrowS = getStudentsByDay(tomorrow);
  const unpaid = students.filter(s=>!s.paid);
  const revenue = students.filter(s=>s.paid).reduce((a,s)=>a+(s.fee||0),0);

  const menus = [
    {id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},
    {id:'students',icon:'ğŸ‘¥',label:'ì›ìƒê´€ë¦¬'},
    {id:'attendance',icon:'ğŸ“…',label:'ì¶œê²°ê´€ë¦¬'},
    {id:'payments',icon:'ğŸ’°',label:'ìˆ˜ê°•ë£Œ'},
    {id:'notices',icon:'ğŸ“¢',label:'ê³µì§€ì‚¬í•­'},
    {id:'settings',icon:'âš™ï¸',label:'ì„¤ì •'}
  ];

  let h = '<div class="flex min-h-screen">';
  
  h += `<aside class="hidden lg:flex w-64 bg-white border-r flex-col fixed h-full">
    <div class="p-4 border-b"><div class="flex items-center gap-3"><span class="text-2xl">ğŸ“š</span><div><div class="font-bold">${academy.name}</div><div class="text-xs text-gray-400">${academy.owner}</div></div></div></div>
    <nav class="flex-1 py-2">`;
  menus.forEach(m=>{
    const cls = tab===m.id ? 'active bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50';
    h += `<button onclick="tab='${m.id}';viewStudentId=null;render()" class="sidebar-item w-full px-4 py-3 flex items-center gap-3 text-left ${cls}">${m.icon} ${m.label}</button>`;
  });
  h += `</nav><div class="p-4 border-t"><button onclick="logout()" class="text-gray-500 text-sm">ë¡œê·¸ì•„ì›ƒ</button></div></aside>`;

  h += '<main class="flex-1 lg:ml-64">';
  
  h += `<header class="bg-white border-b sticky top-0 z-10">
    <div class="px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-2 lg:hidden"><span>ğŸ“š</span><span class="font-bold">${academy.name}</span></div>
      <div class="hidden lg:block font-bold">${menus.find(m=>m.id===tab)?.label||''}</div>
      <div class="flex gap-2">
        <button onclick="openAddStudent()" class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg">+ì›ìƒ</button>
        <button onclick="logout()" class="lg:hidden text-gray-500 text-sm">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
    <div class="lg:hidden flex border-t overflow-x-auto">`;
  menus.forEach(m=>{
    h += `<button onclick="tab='${m.id}';render()" class="px-4 py-2 text-sm whitespace-nowrap border-b-2 ${tab===m.id?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500'}">${m.icon}</button>`;
  });
  h += '</div></header>';

  h += '<div class="p-4 lg:p-6">';

  if(tab==='dashboard'){
    h += `<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white mb-6">
      <p class="text-indigo-100">${todayStr} ${today}ìš”ì¼</p>
      <h2 class="text-2xl font-bold mt-1">ì•ˆë…•í•˜ì„¸ìš”, ${academy.owner} ì›ì¥ë‹˜!</h2>
    </div>`;

    h += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì „ì²´ì›ìƒ</p><p class="text-3xl font-bold">${students.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì´ë²ˆë‹¬ ë§¤ì¶œ</p><p class="text-3xl font-bold text-emerald-600">${fmt(revenue)}</p></div>
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì˜¤ëŠ˜ìˆ˜ì—…</p><p class="text-3xl font-bold text-blue-600">${todayS.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
      <div class="bg-white rounded-2xl p-5 border cursor-pointer" onclick="tab='payments';render()"><p class="text-gray-500 text-sm">ë¯¸ë‚©</p><p class="text-3xl font-bold text-red-600">${unpaid.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
    </div>`;

    h += '<div class="grid lg:grid-cols-3 gap-6">';
    h += '<div class="lg:col-span-2 space-y-4">';
    
    // ì˜¤ëŠ˜ ìˆ˜ì—…
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-4"><h3 class="font-bold">ğŸ“… ì˜¤ëŠ˜ ìˆ˜ì—… (${today})</h3><span class="text-indigo-600 font-bold">${todayS.length}ëª…</span></div>`;
    if(todayS.length){
      h += '<div class="space-y-2">';
      todayS.forEach(s=>{
        const time = getStudentTime(s, today);
        const checked = attendance[s.id];
        h += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3"><span class="text-lg font-bold text-indigo-600">${time||'-'}</span><div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div></div>
          <span class="text-sm ${checked?'text-emerald-600':'text-gray-400'}">${checked?'âœ“ì¶œì„':'ëŒ€ê¸°'}</span>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-gray-400 text-center py-4">ì˜¤ëŠ˜ ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += `<button onclick="tab='attendance';render()" class="w-full mt-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg text-sm">ì¶œì„ì²´í¬ â†’</button></div>`;

    // ë‚´ì¼
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-4"><h3 class="font-bold">ğŸ“† ë‚´ì¼ ìˆ˜ì—… (${tomorrow})</h3><span class="text-purple-600 font-bold">${tomorrowS.length}ëª…</span></div>`;
    if(tomorrowS.length){
      h += '<div class="space-y-2">';
      tomorrowS.slice(0,4).forEach(s=>{
        const time = getStudentTime(s, tomorrow);
        h += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3"><span class="text-lg font-bold text-purple-600">${time||'-'}</span><div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div></div>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-gray-400 text-center py-4">ë‚´ì¼ ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += '</div></div>';

    // ì‚¬ì´ë“œ
    h += '<div class="space-y-4">';
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ“‹ ì˜¤ëŠ˜ í•  ì¼</h3><button onclick="addTodo()" class="text-indigo-600 text-sm">+ì¶”ê°€</button></div>
      <div class="space-y-2 text-sm">`;
    todos.forEach(t=>{
      h += `<div class="flex items-center gap-2 p-2 rounded-lg ${t.urgent&&!t.done?'bg-red-50':'bg-gray-50'}">
        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo('${t.id}')" class="w-4 h-4">
        <span class="flex-1 ${t.done?'line-through text-gray-400':''}">${t.text}</span>
        <button onclick="deleteTodo('${t.id}')" class="text-gray-400 hover:text-red-500">âœ•</button>
      </div>`;
    });
    if(!todos.length) h += '<p class="text-gray-400 text-center py-2">í•  ì¼ ì—†ìŒ</p>';
    h += '</div></div>';

    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ’¸ ë¯¸ë‚©</h3><span class="text-red-600 font-medium">${fmt(unpaid.reduce((a,s)=>a+(s.fee||0),0))}</span></div>`;
    unpaid.slice(0,3).forEach(s=>{
      h += `<div class="flex justify-between py-2 border-b last:border-0"><span>${s.name}</span><span class="text-red-600">${fmt(s.fee||0)}</span></div>`;
    });
    if(!unpaid.length) h += '<p class="text-gray-400 text-center py-2">ë¯¸ë‚© ì—†ìŒ ğŸ‰</p>';
    h += '</div></div></div>';
  }

  else if(tab==='students'){
    h += `<div class="flex justify-between items-center mb-4">
      <input type="text" placeholder="ê²€ìƒ‰..." class="px-4 py-2 border rounded-xl w-64">
      <button onclick="downloadExcel()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl text-sm">ğŸ“¥ ì—‘ì…€</button>
    </div>`;
    
    h += '<div class="bg-white rounded-2xl border overflow-hidden">';
    h += `<table class="w-full"><thead><tr class="bg-gray-50 border-b">
      <th class="text-left px-4 py-3 text-sm">ì›ìƒ</th>
      <th class="text-left px-4 py-3 text-sm">ê³¼ëª©</th>
      <th class="text-left px-4 py-3 text-sm hidden md:table-cell">ìˆ˜ì—…ì¼ì •</th>
      <th class="text-right px-4 py-3 text-sm">ìˆ˜ê°•ë£Œ</th>
    </tr></thead><tbody>`;
    students.forEach(s=>{
      const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d} ${t}`).join(', ') : (s.days||[]).join(' ')+' '+(s.time||'');
      h += `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="openEditStudent('${s.id}')">
        <td class="px-4 py-3"><div class="flex items-center gap-3">
          <div class="w-9 h-9 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
          <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.phone||''}</div></div>
        </div></td>
        <td class="px-4 py-3"><span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">${s.course||'-'}</span></td>
        <td class="px-4 py-3 text-sm hidden md:table-cell">${scheduleStr}</td>
        <td class="px-4 py-3 text-right"><div class="font-medium">${fmt(s.fee||0)}</div><div class="text-xs ${s.paid?'text-emerald-600':'text-red-500'}">${s.paid?'ì™„ë£Œ':'ë¯¸ë‚©'}</div></td>
      </tr>`;
    });
    if(!students.length) h += '<tr><td colspan="4" class="text-center py-8 text-gray-400">ì›ìƒì„ ë“±ë¡í•˜ì„¸ìš”</td></tr>';
    h += '</tbody></table></div>';
  }

  else if(tab==='attendance'){
    const list = attTab==='yesterday'?getStudentsByDay(yesterday):attTab==='tomorrow'?getStudentsByDay(tomorrow):getStudentsByDay(today);
    const dayLabel = attTab==='yesterday'?yesterday:attTab==='tomorrow'?tomorrow:today;
    const selCount = Object.keys(selectedStudents).filter(k=>selectedStudents[k]).length;

    h += `<div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center"><div><h3 class="text-xl font-bold">ğŸ“± ì¶œê²° ê´€ë¦¬</h3></div>
      <div class="text-right"><div class="text-3xl font-bold">${Object.keys(attendance).filter(k=>attendance[k]).length}/${getStudentsByDay(today).length}</div><div class="text-emerald-100">ì˜¤ëŠ˜ ì¶œì„</div></div></div></div>`;

    h += `<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
      <div class="flex gap-2">
        <button onclick="attTab='yesterday';render()" class="px-4 py-2 rounded-xl ${attTab==='yesterday'?'bg-indigo-600 text-white':'bg-white border'}">ì–´ì œ (${yesterday})</button>
        <button onclick="attTab='today';render()" class="px-4 py-2 rounded-xl ${attTab==='today'?'bg-indigo-600 text-white':'bg-white border'}">ì˜¤ëŠ˜ (${today})</button>
        <button onclick="attTab='tomorrow';render()" class="px-4 py-2 rounded-xl ${attTab==='tomorrow'?'bg-indigo-600 text-white':'bg-white border'}">ë‚´ì¼ (${tomorrow})</button>
      </div>
      <button onclick="openSmsModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl ${selCount===0?'opacity-50':''}">ğŸ“± ë¬¸ìë³´ë‚´ê¸° (${selCount})</button>
    </div>`;

    h += '<div class="bg-white rounded-2xl border p-4">';
    if(list.length){
      h += '<div class="space-y-2">';
      list.forEach(s=>{
        const time = getStudentTime(s, dayLabel);
        const checked = attTab==='today' && attendance[s.id];
        const selected = selectedStudents[s.id];
        h += `<div class="flex items-center gap-3 p-4 rounded-xl border-2 ${checked?'border-emerald-500 bg-emerald-50':'border-gray-200'}">
          <input type="checkbox" ${selected?'checked':''} onchange="toggleSelect('${s.id}')" class="w-5 h-5" title="ë¬¸ì ì„ íƒ">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold ${checked?'bg-emerald-500 text-white':'bg-gray-100'}">
            ${s.name?.[0]||'?'}
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-medium">${s.name}</span>
              ${attTab==='today' ? `<button onclick="toggleAtt('${s.id}')" class="px-3 py-1 text-xs rounded-lg ${checked?'bg-emerald-100 text-emerald-700':'bg-gray-200 text-gray-600'}">${checked?'âœ“ ì¶œì„ì™„ë£Œ':'ì¶œì„'}</button>` : ''}
            </div>
            <div class="text-sm text-gray-500">${s.course||''} Â· ${time}</div>
          </div>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-center text-gray-400 py-8">ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += '</div>';
  }

  else if(tab==='payments'){
    const total = students.reduce((a,s)=>a+(s.fee||0),0);
    const paidAmt = students.filter(s=>s.paid).reduce((a,s)=>a+(s.fee||0),0);
    const unpaidList = students.filter(s=>!s.paid);

    h += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ì˜ˆìƒë§¤ì¶œ</div><div class="text-2xl font-bold">${fmt(total)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ìˆ˜ë‚©ì™„ë£Œ</div><div class="text-2xl font-bold text-emerald-600">${fmt(paidAmt)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ë¯¸ìˆ˜ê¸ˆ</div><div class="text-2xl font-bold text-red-600">${fmt(total-paidAmt)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ìˆ˜ë‚©ë¥ </div><div class="text-2xl font-bold text-indigo-600">${total?Math.round(paidAmt/total*100):0}%</div></div>
    </div>`;

    h += '<div class="bg-white rounded-2xl border">';
    h += `<div class="px-4 py-3 border-b flex justify-between"><span class="font-bold">ë¯¸ë‚© ì›ìƒ</span><span class="text-red-600">${unpaidList.length}ëª…</span></div>`;
    unpaidList.forEach(s=>{
      h += `<div class="flex items-center justify-between px-4 py-3 border-b">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 bg-red-100 text-red-600 rounded-full flex items-center justify-center">${s.name?.[0]||'?'}</div>
          <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-bold">${fmt(s.fee||0)}</span>
          <button onclick="markPaid('${s.id}')" class="px-3 py-1 bg-emerald-600 text-white text-sm rounded-lg">ìˆ˜ë‚©</button>
        </div>
      </div>`;
    });
    if(!unpaidList.length) h += '<p class="text-center text-gray-400 py-8">ğŸ‰ ë¯¸ë‚© ì—†ìŒ</p>';
    h += '</div>';
  }

  else if(tab==='notices'){
    h += `<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">ğŸ“¢ ê³µì§€ì‚¬í•­</h2><button onclick="addNotice()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">+ ìƒˆ ê³µì§€</button></div>`;
    notices.forEach(n=>{
      h += `<div class="bg-white rounded-2xl border p-5 mb-3">
        <div class="flex justify-between"><h3 class="font-bold">${n.title}</h3><button onclick="deleteNotice('${n.id}')" class="text-gray-400">âœ•</button></div>
        <p class="text-sm text-gray-500 mt-1">${new Date(n.created_at).toLocaleDateString('ko-KR')}</p>
        <p class="mt-2">${n.content||''}</p>
      </div>`;
    });
    if(!notices.length) h += '<p class="text-gray-400 text-center py-8">ê³µì§€ì‚¬í•­ ì—†ìŒ</p>';
  }

  else if(tab==='settings'){
    h += `<div class="bg-white rounded-2xl border p-6 mb-4">
      <h2 class="font-bold mb-4">ğŸ« í•™ì› ì •ë³´</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div><label class="text-sm text-gray-600">í•™ì›ëª…</label><input type="text" id="setName" value="${academy.name||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">ì›ì¥ëª…</label><input type="text" id="setOwner" value="${academy.owner||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div class="md:col-span-2"><label class="text-sm text-gray-600">ì£¼ì†Œ</label><input type="text" id="setAddress" value="${academy.address||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">ì—°ë½ì²˜</label><input type="text" id="setPhone" value="${academy.phone||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
      </div>
      <button onclick="saveSettings()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-xl">ì €ì¥</button>
    </div>`;
  }

  h += '</div></main></div>';

  if(modal==='addStudent') h += renderStudentModal();
  if(modal==='sms') h += renderSmsModal();

  return h;
}

function renderStudentModal(){
  const s = editingId ? students.find(x=>x.id===editingId) : null;
  
  let h = `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){closeModal();}">
    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">${s?'ì›ìƒ ìˆ˜ì •':'ì›ìƒ ë“±ë¡'}</span><button onclick="closeModal()">âœ•</button></div>
      <div class="p-4 space-y-3">
        <input type="text" id="sName" value="${formData.name}" oninput="formData.name=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="ì´ë¦„ *">
        <input type="tel" id="sPhone" value="${formData.phone}" oninput="formData.phone=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="ì—°ë½ì²˜">
        <input type="tel" id="sPPhone" value="${formData.pPhone}" oninput="formData.pPhone=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="í•™ë¶€ëª¨ ì—°ë½ì²˜">
        <div class="grid grid-cols-2 gap-2">
          <input type="text" id="sCourse" value="${formData.course}" oninput="formData.course=this.value" class="px-4 py-2 border rounded-xl" placeholder="ê³¼ëª©">
          <input type="text" id="sLevel" value="${formData.level}" oninput="formData.level=this.value" class="px-4 py-2 border rounded-xl" placeholder="ë ˆë²¨">
        </div>
        
        <div class="bg-indigo-50 rounded-xl p-3">
          <div class="text-sm font-medium mb-2">ìˆ˜ì—… ì¼ì • (ìš”ì¼ë³„ ì‹œê°„)</div>
          <div class="space-y-2">`;
  
  ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].forEach(d=>{
    const hasDay = formData.schedule[d] !== undefined;
    const time = formData.schedule[d] || '16:00';
    h += `<div class="flex items-center gap-2">
      <button type="button" onclick="toggleDaySchedule('${d}')" class="w-10 h-10 rounded-lg text-sm font-bold ${hasDay?'bg-indigo-600 text-white':'bg-white border'}">${d}</button>
      ${hasDay ? `<input type="time" value="${time}" onchange="formData.schedule['${d}']=this.value" class="flex-1 px-3 py-2 border rounded-lg">
      <span class="text-xs text-gray-500">${d}ìš”ì¼</span>` : '<span class="text-gray-400 text-sm">ìˆ˜ì—… ì—†ìŒ</span>'}
    </div>`;
  });
  
  h += `</div>
        </div>
        
        <input type="number" id="sFee" value="${formData.fee}" oninput="formData.fee=parseInt(this.value)||0" class="w-full px-4 py-2 border rounded-xl" placeholder="ìˆ˜ê°•ë£Œ">
        <label class="flex items-center gap-2"><input type="checkbox" id="sPaid" ${formData.paid?'checked':''} onchange="formData.paid=this.checked" class="w-5 h-5">ë‚©ë¶€ì™„ë£Œ</label>
        <div class="flex gap-2">
          <button onclick="closeModal()" class="flex-1 py-2 border rounded-xl">ì·¨ì†Œ</button>
          ${editingId ? `<button onclick="deleteStudent('${editingId}')" class="py-2 px-4 bg-red-500 text-white rounded-xl">ì‚­ì œ</button>` : ''}
          <button onclick="saveStudent()" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl">${s?'ìˆ˜ì •':'ë“±ë¡'}</button>
        </div>
      </div>
    </div>
  </div>`;
  return h;
}

function renderSmsModal(){
  const selIds = Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  const selStudents = selIds.map(id=>students.find(s=>s.id===id)).filter(Boolean);
  const defaultMsg = `[${academy.name}]\n\nì•ˆë…•í•˜ì„¸ìš”.\n\n${selStudents.map(s=>s.name).join(', ')} í•™ìƒ ì¶œì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.`;
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">ğŸ“± ë¬¸ì ë³´ë‚´ê¸°</span><button onclick="modal='';render()">âœ•</button></div>
      <div class="p-4">
        <div class="mb-3"><span class="text-sm text-gray-500">ë°›ëŠ” ì‚¬ëŒ</span>
          <div class="flex flex-wrap gap-1 mt-1">${selStudents.map(s=>`<span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">${s.name}</span>`).join('')}</div>
        </div>
        <div class="mb-3"><span class="text-sm text-gray-500">ë‚´ìš©</span><textarea id="smsContent" class="w-full p-3 border rounded-xl mt-1" rows="6">${defaultMsg}</textarea></div>
        <button onclick="sendSMS()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">ë³´ë‚´ê¸°</button>
      </div>
    </div>
  </div>`;
}

function openAddStudent(){
  editingId = null;
  formData = {name:'',phone:'',pPhone:'',course:'',level:'',fee:200000,paid:false,schedule:{}};
  modal = 'addStudent';
  render();
}

function openEditStudent(id){
  const s = students.find(x=>x.id===id);
  if(!s) return;
  editingId = id;
  formData = {
    name: s.name || '',
    phone: s.phone || '',
    pPhone: s.parent_phone || '',
    course: s.course || '',
    level: s.level || '',
    fee: s.fee || 200000,
    paid: s.paid || false,
    schedule: s.schedule || {}
  };
  // ê¸°ì¡´ days/time í˜•ì‹ì´ë©´ ë³€í™˜
  if(!s.schedule && s.days && s.days.length){
    formData.schedule = {};
    s.days.forEach(d => { formData.schedule[d] = s.time || '16:00'; });
  }
  modal = 'addStudent';
  render();
}

function closeModal(){
  modal = '';
  editingId = null;
  render();
}

function toggleDaySchedule(d){
  if(formData.schedule[d] !== undefined){
    delete formData.schedule[d];
  } else {
    formData.schedule[d] = '16:00';
  }
  render();
}

async function saveStudent(){
  if(!formData.name){alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  
  const data = {
    academy_id: academy.id,
    name: formData.name,
    phone: formData.phone,
    parent_phone: formData.pPhone,
    course: formData.course,
    level: formData.level,
    fee: formData.fee,
    paid: formData.paid,
    schedule: formData.schedule,
    days: Object.keys(formData.schedule),
    time: Object.values(formData.schedule)[0] || ''
  };
  
  loading=true;render();
  
  if(editingId){
    await db.from('students').update(data).eq('id',editingId);
  } else {
    await db.from('students').insert(data);
  }
  
  await loadData();
  modal='';editingId=null;
  loading=false;render();
}

async function deleteStudent(id){
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  loading=true;render();
  await db.from('students').delete().eq('id',id);
  await loadData();
  modal='';editingId=null;
  loading=false;render();
}

async function toggleAtt(id){
  const exists = attendance[id];
  if(exists){
    await db.from('attendance').delete().eq('student_id',id).eq('date',todayISO);
    delete attendance[id];
  } else {
    await db.from('attendance').insert({student_id:id,date:todayISO,status:'ì¶œì„'});
    attendance[id]='ì¶œì„';
  }
  render();
}

function toggleSelect(id){selectedStudents[id]=!selectedStudents[id];render();}

async function markPaid(id){
  await db.from('students').update({paid:true,paid_date:todayISO}).eq('id',id);
  await loadData();
  render();
}

async function addTodo(){
  const text=prompt('í•  ì¼:');
  if(!text)return;
  await db.from('todos').insert({academy_id:academy.id,text});
  await loadData();
  render();
}

async function toggleTodo(id){
  const t=todos.find(x=>x.id===id);
  if(t){
    await db.from('todos').update({done:!t.done}).eq('id',id);
    await loadData();
    render();
  }
}

async function deleteTodo(id){
  await db.from('todos').delete().eq('id',id);
  await loadData();
  render();
}

async function addNotice(){
  const title=prompt('ê³µì§€ ì œëª©:');
  if(!title)return;
  const content=prompt('ë‚´ìš©:')||'';
  await db.from('notices').insert({academy_id:academy.id,title,content});
  await loadData();
  render();
}

async function deleteNotice(id){
  if(confirm('ì‚­ì œ?')){
    await db.from('notices').delete().eq('id',id);
    await loadData();
    render();
  }
}

function openSmsModal(){
  const sel=Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  if(!sel.length){alert('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”');return;}
  modal='sms';render();
}

function sendSMS(){
  const content=document.getElementById('smsContent').value;
  alert('ë¬¸ì ë°œì†¡!\n(ì‹¤ì œ ë°œì†¡ì€ Aligo ì—°ë™ í•„ìš”)\n\n'+content);
  modal='';selectedStudents={};render();
}

async function saveSettings(){
  const data = {
    name: document.getElementById('setName').value,
    owner: document.getElementById('setOwner').value,
    address: document.getElementById('setAddress').value,
    phone: document.getElementById('setPhone').value
  };
  await db.from('academies').update(data).eq('id',academy.id);
  academy = {...academy,...data};
  alert('ì €ì¥ ì™„ë£Œ!');
  render();
}

function downloadExcel(){
  const data=students.map(s=>{
    const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d}${t}`).join(' ') : '';
    return {ì´ë¦„:s.name,ì—°ë½ì²˜:s.phone,ê³¼ëª©:s.course,ë ˆë²¨:s.level,ìˆ˜ê°•ë£Œ:s.fee,ë‚©ë¶€:s.paid?'ì™„ë£Œ':'ë¯¸ë‚©',ìˆ˜ì—…ì¼ì •:scheduleStr};
  });
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'ì›ìƒ');
  XLSX.writeFile(wb,'ì›ìƒëª©ë¡.xlsx');
}

render();
</script>
</body>
</html>
