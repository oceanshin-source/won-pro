<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì›ìƒê´€ë¦¬ Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{font-family:-apple-system,'Malgun Gothic',sans-serif;box-sizing:border-box}
    .sidebar-item.active{background:rgba(99,102,241,.15);color:#4f46e5;border-right:3px solid #4f46e5}
    [contenteditable]:focus{outline:2px solid #6366f1;outline-offset:2px}
    @media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%}}
  </style>
</head>
<body class="bg-gray-100">
<div id="app"></div>
<script>
const SUPABASE_URL = 'https://sniabexwdgeepakkxxek.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuaWFiZXh3ZGdlZXBha2t4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MDMxNzIsImV4cCI6MjA4NTA3OTE3Mn0.RsDQDyawjFk5voFLVouXDlTIXvhPrsziCD37ne-1jMU';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let page = 'login';
let academy = null;
let admin = null;
let students = [];
let notices = [];
let consults = [];
let todos = [];
let homework = [];
let photos = [];
let reports = [];
let makeups = [];
let chats = [];
let attendance = {};
let tab = 'dashboard';
let modal = '';
let editingId = null;
let selectedStudents = {};
let attTab = 'today';
let viewStudentId = null;
let loading = false;
let docStudentId = '';
let currentDoc = null;
let photoStudentId = '';
let chatStudentId = '';
let reportStudentId = '';

let formData = {name:'',phone:'',pPhone:'',course:'',level:'',fee:200000,paid:false,schedule:{},memo:''};

const dayList = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
const today = dayList[new Date().getDay()];
const yesterday = dayList[(new Date().getDay()+6)%7];
const tomorrow = dayList[(new Date().getDay()+1)%7];
const todayStr = new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
const todayISO = new Date().toISOString().split('T')[0];

const docs = [
  {id:1,cat:'ì¦ëª…ì„œ',name:'ì¬ì›ì¦ëª…ì„œ',icon:'ğŸ“œ'},{id:2,cat:'ì¦ëª…ì„œ',name:'ìˆ˜ë£Œì¦',icon:'ğŸ“'},{id:3,cat:'ì¦ëª…ì„œ',name:'ì¶œì„í™•ì¸ì„œ',icon:'âœ…'},
  {id:4,cat:'ì¦ëª…ì„œ',name:'ì„±ì ì¦ëª…ì„œ',icon:'ğŸ“Š'},{id:5,cat:'ì¦ëª…ì„œ',name:'ë ˆë²¨í™•ì¸ì„œ',icon:'ğŸ“ˆ'},
  {id:6,cat:'ì•ˆë‚´ë¬¸',name:'ìˆ˜ê°•ë£Œì•ˆë‚´',icon:'ğŸ’°'},{id:7,cat:'ì•ˆë‚´ë¬¸',name:'íœ´ì›ì•ˆë‚´',icon:'ğŸ–ï¸'},{id:8,cat:'ì•ˆë‚´ë¬¸',name:'ìˆ˜ì—…ë³€ê²½',icon:'ğŸ“…'},
  {id:9,cat:'ì•ˆë‚´ë¬¸',name:'íŠ¹ê°•ì•ˆë‚´',icon:'â­'},{id:10,cat:'ì•ˆë‚´ë¬¸',name:'í•™ì›ì†Œê°œ',icon:'ğŸ«'},
  {id:11,cat:'ê³„ì•½ì„œ',name:'ìˆ˜ê°•ê³„ì•½ì„œ',icon:'ğŸ“'},{id:12,cat:'ê³„ì•½ì„œ',name:'í™˜ë¶ˆë™ì˜ì„œ',icon:'ğŸ’¸'},{id:13,cat:'ê³„ì•½ì„œ',name:'ê°œì¸ì •ë³´ë™ì˜ì„œ',icon:'ğŸ”’'},
  {id:14,cat:'ê³„ì•½ì„œ',name:'ì´ˆìƒê¶Œë™ì˜ì„œ',icon:'ğŸ“·'},{id:15,cat:'ê³„ì•½ì„œ',name:'í•™ì›ê·œì¹™ë™ì˜ì„œ',icon:'ğŸ“‹'},
  {id:16,cat:'ì˜ìˆ˜ì¦',name:'ìˆ˜ê°•ë£Œì˜ìˆ˜ì¦',icon:'ğŸ§¾'},{id:17,cat:'ì˜ìˆ˜ì¦',name:'êµì¬ë¹„ì˜ìˆ˜ì¦',icon:'ğŸ“š'},{id:18,cat:'ì˜ìˆ˜ì¦',name:'í™˜ë¶ˆì˜ìˆ˜ì¦',icon:'ğŸ’³'},
  {id:19,cat:'í•™ìŠµê´€ë¦¬',name:'í•™ìŠµí”Œëœ',icon:'ğŸ¯'},{id:20,cat:'í•™ìŠµê´€ë¦¬',name:'ìƒë‹´ì¼ì§€',icon:'ğŸ“'},{id:21,cat:'í•™ìŠµê´€ë¦¬',name:'ë ˆë²¨í…ŒìŠ¤íŠ¸',icon:'âœï¸'},
  {id:22,cat:'í•™ìŠµê´€ë¦¬',name:'ì„±ì í‘œ',icon:'ğŸ“‹'},{id:23,cat:'í•™ìŠµê´€ë¦¬',name:'ì¶œê²°í‘œ',icon:'ğŸ“†'}
];

function fmt(n){return n>=10000?(n/10000).toFixed(0)+'ë§Œ':n.toLocaleString();}
function getStudentsByDay(day){
  return students.filter(s=>{
    if(s.schedule && typeof s.schedule === 'object') return s.schedule[day];
    return s.days && s.days.includes(day);
  }).sort((a,b)=>{
    const tA = a.schedule?.[day] || a.time || '';
    const tB = b.schedule?.[day] || b.time || '';
    return tA.localeCompare(tB);
  });
}
function getStudentTime(s,day){
  if(s.schedule && typeof s.schedule === 'object') return s.schedule[day] || '';
  return s.time || '';
}

function render(){
  const app = document.getElementById('app');
  if(loading){app.innerHTML='<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="text-4xl mb-4">â³</div><p>ë¡œë”©ì¤‘...</p></div></div>';return;}
  if(page==='login') app.innerHTML = renderLogin();
  else if(page==='register') app.innerHTML = renderRegister();
  else if(page==='main') app.innerHTML = renderMain();
}

function renderLogin(){
  return `
  <div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-800 flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-4xl">ğŸ“š</div>
        <h1 class="text-3xl font-bold text-white">ì›ìƒê´€ë¦¬ Pro</h1>
        <p class="text-indigo-200 mt-2">í•™ì› ê´€ë¦¬ì˜ ìƒˆë¡œìš´ ì‹œì‘</p>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-bold mb-4">ë¡œê·¸ì¸</h2>
        <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 border rounded-xl mb-4">
        <button onclick="doLogin()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">ë¡œê·¸ì¸</button>
        <p class="text-center mt-4 text-gray-500">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button onclick="page='register';render()" class="text-indigo-600 font-medium">íšŒì›ê°€ì…</button></p>
      </div>
    </div>
  </div>`;
}

function renderRegister(){
  return `
  <div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-800 flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-4xl">ğŸ“š</div>
        <h1 class="text-3xl font-bold text-white">ì›ìƒê´€ë¦¬ Pro</h1>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-bold mb-4">íšŒì›ê°€ì…</h2>
        <input type="text" id="regAcademy" placeholder="í•™ì›ëª… *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="text" id="regOwner" placeholder="ì›ì¥ë‹˜ ì„±í•¨ *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="tel" id="regPhone" placeholder="ì—°ë½ì²˜" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="text" id="regAddress" placeholder="ì£¼ì†Œ" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="email" id="regEmail" placeholder="ì´ë©”ì¼ (ë¡œê·¸ì¸ìš©) *" class="w-full px-4 py-3 border rounded-xl mb-3">
        <input type="password" id="regPw" placeholder="ë¹„ë°€ë²ˆí˜¸ *" class="w-full px-4 py-3 border rounded-xl mb-4">
        <button onclick="doRegister()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">ê°€ì…í•˜ê¸°</button>
        <p class="text-center mt-4 text-gray-500">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="page='login';render()" class="text-indigo-600 font-medium">ë¡œê·¸ì¸</button></p>
      </div>
    </div>
  </div>`;
}

async function doRegister(){
  const name = document.getElementById('regAcademy').value;
  const owner = document.getElementById('regOwner').value;
  const phone = document.getElementById('regPhone').value;
  const address = document.getElementById('regAddress').value;
  const email = document.getElementById('regEmail').value;
  const pw = document.getElementById('regPw').value;
  if(!name||!owner||!email||!pw){alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  loading=true;render();
  const {data:academyData,error:err1} = await db.from('academies').insert({name,owner,phone,address}).select().single();
  if(err1){alert('í•™ì› ë“±ë¡ ì‹¤íŒ¨: '+err1.message);loading=false;render();return;}
  const {error:err2} = await db.from('admins').insert({academy_id:academyData.id,email,password:pw});
  if(err2){alert('ê´€ë¦¬ì ë“±ë¡ ì‹¤íŒ¨: '+err2.message);loading=false;render();return;}
  alert('ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•˜ì„¸ìš”.');
  loading=false;page='login';render();
}

async function doLogin(){
  const email = document.getElementById('loginEmail').value;
  const pw = document.getElementById('loginPw').value;
  if(!email||!pw){alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
  loading=true;render();
  const {data,error} = await db.from('admins').select('*,academies(*)').eq('email',email).eq('password',pw).single();
  if(error||!data){alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');loading=false;render();return;}
  admin = data;
  academy = data.academies;
  await loadData();
  loading=false;page='main';render();
}

async function loadData(){
  const {data:s} = await db.from('students').select('*').eq('academy_id',academy.id);
  students = s || [];
  const {data:n} = await db.from('notices').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  notices = n || [];
  const {data:t} = await db.from('todos').select('*').eq('academy_id',academy.id);
  todos = t || [];
  const {data:c} = await db.from('consults').select('*').order('created_at',{ascending:false});
  consults = (c || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:hw} = await db.from('homework').select('*').order('created_at',{ascending:false});
  homework = (hw || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:p} = await db.from('photos').select('*').eq('academy_id',academy.id).order('created_at',{ascending:false});
  photos = p || [];
  const {data:r} = await db.from('reports').select('*').order('created_at',{ascending:false});
  reports = (r || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:m} = await db.from('makeups').select('*').order('created_at',{ascending:false});
  makeups = (m || []).filter(x => students.some(st => st.id === x.student_id));
  const {data:ch} = await db.from('chats').select('*').eq('academy_id',academy.id).order('created_at',{ascending:true});
  chats = ch || [];
  const {data:a} = await db.from('attendance').select('*').eq('date',todayISO);
  attendance = {};
  (a||[]).forEach(att=>{attendance[att.student_id]=att.status;});
}

function logout(){
  admin=null;academy=null;students=[];notices=[];todos=[];consults=[];homework=[];attendance={};
  page='login';render();
}

function renderMain(){
  const todayS = getStudentsByDay(today);
  const tomorrowS = getStudentsByDay(tomorrow);
  const unpaid = students.filter(s=>!s.paid);
  const revenue = students.filter(s=>s.paid).reduce((a,s)=>a+(s.fee||0),0);
  const pendingConsults = consults.filter(c=>c.status==='ëŒ€ê¸°');
  const pendingMakeups = makeups.filter(m=>m.status==='ëŒ€ê¸°');

  const menus = [
    {id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},
    {id:'students',icon:'ğŸ‘¥',label:'ì›ìƒê´€ë¦¬'},
    {id:'attendance',icon:'ğŸ“…',label:'ì¶œê²°ê´€ë¦¬'},
    {id:'payments',icon:'ğŸ’°',label:'ìˆ˜ê°•ë£Œ'},
    {id:'photos',icon:'ğŸ“¸',label:'ìˆ˜ì—…ì‚¬ì§„',pro:true},
    {id:'reports',icon:'ğŸ“ˆ',label:'í•™ìŠµë¦¬í¬íŠ¸',pro:true},
    {id:'makeups',icon:'ğŸ”„',label:'ë³´ê°•ì‹ ì²­',pro:true,badge:pendingMakeups.length},
    {id:'chat',icon:'ğŸ’¬',label:'ì±„íŒ…',pro:true},
    {id:'points',icon:'ğŸ†',label:'ì¶œì„í¬ì¸íŠ¸',pro:true},
    {id:'notices',icon:'ğŸ“¢',label:'ê³µì§€ì‚¬í•­'},
    {id:'consult',icon:'ğŸ—£ï¸',label:'ìƒë‹´',badge:pendingConsults.length},
    {id:'homework',icon:'ğŸ“',label:'ê³¼ì œê´€ë¦¬'},
    {id:'documents',icon:'ğŸ“„',label:'ë¬¸ì„œí…œí”Œë¦¿'},
    {id:'settings',icon:'âš™ï¸',label:'ì„¤ì •'}
  ];

  let h = '<div class="flex min-h-screen">';
  
  // ì‚¬ì´ë“œë°”
  h += `<aside class="hidden lg:flex w-64 bg-white border-r flex-col fixed h-full">
    <div class="p-4 border-b"><div class="flex items-center gap-3"><span class="text-2xl">ğŸ“š</span><div><div class="font-bold">${academy.name}</div><div class="text-xs text-gray-400">${academy.owner}</div></div></div></div>
    <nav class="flex-1 py-2 overflow-y-auto">`;
  menus.forEach(m=>{
    const cls = tab===m.id ? 'active bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50';
    const badge = m.badge ? `<span class="ml-auto bg-red-500 text-white text-xs px-2 rounded-full">${m.badge}</span>` : '';
    h += `<button onclick="tab='${m.id}';viewStudentId=null;render()" class="sidebar-item w-full px-4 py-3 flex items-center gap-3 text-left ${cls}">${m.icon} ${m.label}${badge}</button>`;
  });
  h += `</nav><div class="p-4 border-t"><button onclick="logout()" class="text-gray-500 text-sm">ë¡œê·¸ì•„ì›ƒ</button></div></aside>`;

  h += '<main class="flex-1 lg:ml-64">';
  
  // í—¤ë”
  h += `<header class="bg-white border-b sticky top-0 z-10">
    <div class="px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-2 lg:hidden"><span>ğŸ“š</span><span class="font-bold">${academy.name}</span></div>
      <div class="hidden lg:block font-bold">${viewStudentId ? 'ì›ìƒ ìƒì„¸' : menus.find(m=>m.id===tab)?.label||''}</div>
      <div class="flex gap-2">
        <button onclick="openAddStudent()" class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg">+ì›ìƒ</button>
        <button onclick="logout()" class="lg:hidden text-gray-500 text-sm">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
    <div class="lg:hidden flex border-t overflow-x-auto">`;
  menus.slice(0,6).forEach(m=>{
    h += `<button onclick="tab='${m.id}';render()" class="px-4 py-2 text-sm whitespace-nowrap border-b-2 ${tab===m.id?'border-indigo-600 text-indigo-600':'border-transparent text-gray-500'}">${m.icon}</button>`;
  });
  h += '</div></header>';

  h += '<div class="p-4 lg:p-6">';

  // ì›ìƒ ìƒì„¸
  if(viewStudentId){
    h += renderStudentDetail();
  }
  // ëŒ€ì‹œë³´ë“œ
  else if(tab==='dashboard'){
    h += `<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white mb-6">
      <p class="text-indigo-100">${todayStr} ${today}ìš”ì¼</p>
      <h2 class="text-2xl font-bold mt-1">ì•ˆë…•í•˜ì„¸ìš”, ${academy.owner} ì›ì¥ë‹˜!</h2>
    </div>`;

    h += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì „ì²´ì›ìƒ</p><p class="text-3xl font-bold">${students.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì´ë²ˆë‹¬ ë§¤ì¶œ</p><p class="text-3xl font-bold text-emerald-600">${fmt(revenue)}</p></div>
      <div class="bg-white rounded-2xl p-5 border"><p class="text-gray-500 text-sm">ì˜¤ëŠ˜ìˆ˜ì—…</p><p class="text-3xl font-bold text-blue-600">${todayS.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
      <div class="bg-white rounded-2xl p-5 border cursor-pointer" onclick="tab='payments';render()"><p class="text-gray-500 text-sm">ë¯¸ë‚©</p><p class="text-3xl font-bold text-red-600">${unpaid.length}<span class="text-lg text-gray-400">ëª…</span></p></div>
    </div>`;

    h += '<div class="grid lg:grid-cols-3 gap-6">';
    h += '<div class="lg:col-span-2 space-y-4">';
    
    // ì˜¤ëŠ˜ ìˆ˜ì—…
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-4"><h3 class="font-bold">ğŸ“… ì˜¤ëŠ˜ ìˆ˜ì—… (${today})</h3><span class="text-indigo-600 font-bold">${todayS.length}ëª…</span></div>`;
    if(todayS.length){
      h += '<div class="space-y-2">';
      todayS.forEach(s=>{
        const time = getStudentTime(s, today);
        const checked = attendance[s.id];
        h += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3"><span class="text-lg font-bold text-indigo-600">${time||'-'}</span><div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div></div>
          <span class="text-sm ${checked?'text-emerald-600':'text-gray-400'}">${checked?'âœ“ì¶œì„':'ëŒ€ê¸°'}</span>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-gray-400 text-center py-4">ì˜¤ëŠ˜ ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += `<button onclick="tab='attendance';render()" class="w-full mt-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg text-sm">ì¶œì„ì²´í¬ â†’</button></div>`;

    // ë‚´ì¼
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-4"><h3 class="font-bold">ğŸ“† ë‚´ì¼ ìˆ˜ì—… (${tomorrow})</h3><span class="text-purple-600 font-bold">${tomorrowS.length}ëª…</span></div>`;
    if(tomorrowS.length){
      h += '<div class="space-y-2">';
      tomorrowS.slice(0,4).forEach(s=>{
        const time = getStudentTime(s, tomorrow);
        h += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3"><span class="text-lg font-bold text-purple-600">${time||'-'}</span><div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div></div>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-gray-400 text-center py-4">ë‚´ì¼ ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += '</div></div>';

    // ì‚¬ì´ë“œ
    h += '<div class="space-y-4">';
    // í• ì¼
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ“‹ ì˜¤ëŠ˜ í•  ì¼</h3><button onclick="addTodo()" class="text-indigo-600 text-sm">+ì¶”ê°€</button></div>
      <div class="space-y-2 text-sm">`;
    todos.forEach(t=>{
      h += `<div class="flex items-center gap-2 p-2 rounded-lg ${t.urgent&&!t.done?'bg-red-50':'bg-gray-50'}">
        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo('${t.id}')" class="w-4 h-4">
        <span class="flex-1 ${t.done?'line-through text-gray-400':''}">${t.text}</span>
        <button onclick="deleteTodo('${t.id}')" class="text-gray-400 hover:text-red-500">âœ•</button>
      </div>`;
    });
    if(!todos.length) h += '<p class="text-gray-400 text-center py-2">í•  ì¼ ì—†ìŒ</p>';
    h += '</div></div>';

    // ìƒë‹´ëŒ€ê¸°
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ’¬ ìƒë‹´ ëŒ€ê¸°</h3>${pendingConsults.length?`<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">${pendingConsults.length}</span>`:''}</div>`;
    if(pendingConsults.length){
      pendingConsults.slice(0,2).forEach(c=>{
        const stu = students.find(s=>s.id===c.student_id);
        h += `<div class="p-3 bg-red-50 rounded-xl mb-2"><div class="font-medium text-sm">${stu?.name||''}</div><p class="text-xs text-gray-600 truncate">${c.message||''}</p></div>`;
      });
      h += `<button onclick="tab='consult';render()" class="w-full py-2 text-indigo-600 text-sm">ë‹µë³€í•˜ê¸° â†’</button>`;
    } else {
      h += '<p class="text-gray-400 text-center py-4 text-sm">ëŒ€ê¸°ì¤‘ ìƒë‹´ ì—†ìŒ âœ¨</p>';
    }
    h += '</div>';

    // ë¯¸ë‚©
    h += `<div class="bg-white rounded-2xl border p-5">
      <div class="flex justify-between items-center mb-3"><h3 class="font-bold">ğŸ’¸ ë¯¸ë‚©</h3><span class="text-red-600 font-medium">${fmt(unpaid.reduce((a,s)=>a+(s.fee||0),0))}</span></div>`;
    unpaid.slice(0,3).forEach(s=>{
      h += `<div class="flex justify-between py-2 border-b last:border-0"><span>${s.name}</span><span class="text-red-600">${fmt(s.fee||0)}</span></div>`;
    });
    if(!unpaid.length) h += '<p class="text-gray-400 text-center py-2">ë¯¸ë‚© ì—†ìŒ ğŸ‰</p>';
    h += '</div></div></div>';
  }

  // ì›ìƒê´€ë¦¬
  else if(tab==='students'){
    h += `<div class="flex justify-between items-center mb-4">
      <input type="text" placeholder="ê²€ìƒ‰..." class="px-4 py-2 border rounded-xl w-64">
      <button onclick="downloadExcel()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl text-sm">ğŸ“¥ ì—‘ì…€</button>
    </div>`;
    h += '<div class="bg-white rounded-2xl border overflow-hidden">';
    h += `<table class="w-full"><thead><tr class="bg-gray-50 border-b">
      <th class="text-left px-4 py-3 text-sm">ì›ìƒ</th>
      <th class="text-left px-4 py-3 text-sm">ê³¼ëª©</th>
      <th class="text-left px-4 py-3 text-sm hidden md:table-cell">ìˆ˜ì—…ì¼ì •</th>
      <th class="text-right px-4 py-3 text-sm">ìˆ˜ê°•ë£Œ</th>
    </tr></thead><tbody>`;
    students.forEach(s=>{
      const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d} ${t}`).join(', ') : (s.days||[]).join(' ')+' '+(s.time||'');
      h += `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="viewStudentId='${s.id}';render()">
        <td class="px-4 py-3"><div class="flex items-center gap-3">
          <div class="w-9 h-9 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
          <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.phone||''}</div></div>
        </div></td>
        <td class="px-4 py-3"><span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">${s.course||'-'}</span></td>
        <td class="px-4 py-3 text-sm hidden md:table-cell">${scheduleStr}</td>
        <td class="px-4 py-3 text-right"><div class="font-medium">${fmt(s.fee||0)}</div><div class="text-xs ${s.paid?'text-emerald-600':'text-red-500'}">${s.paid?'ì™„ë£Œ':'ë¯¸ë‚©'}</div></td>
      </tr>`;
    });
    if(!students.length) h += '<tr><td colspan="4" class="text-center py-8 text-gray-400">ì›ìƒì„ ë“±ë¡í•˜ì„¸ìš”</td></tr>';
    h += '</tbody></table></div>';
  }

  // ì¶œê²°ê´€ë¦¬
  else if(tab==='attendance'){
    const list = attTab==='yesterday'?getStudentsByDay(yesterday):attTab==='tomorrow'?getStudentsByDay(tomorrow):getStudentsByDay(today);
    const dayLabel = attTab==='yesterday'?yesterday:attTab==='tomorrow'?tomorrow:today;
    const selCount = Object.keys(selectedStudents).filter(k=>selectedStudents[k]).length;

    h += `<div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center"><div><h3 class="text-xl font-bold">ğŸ“± ì¶œê²° ê´€ë¦¬</h3></div>
      <div class="text-right"><div class="text-3xl font-bold">${Object.keys(attendance).filter(k=>attendance[k]).length}/${getStudentsByDay(today).length}</div><div class="text-emerald-100">ì˜¤ëŠ˜ ì¶œì„</div></div></div></div>`;

    h += `<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
      <div class="flex gap-2">
        <button onclick="attTab='yesterday';render()" class="px-4 py-2 rounded-xl ${attTab==='yesterday'?'bg-indigo-600 text-white':'bg-white border'}">ì–´ì œ (${yesterday})</button>
        <button onclick="attTab='today';render()" class="px-4 py-2 rounded-xl ${attTab==='today'?'bg-indigo-600 text-white':'bg-white border'}">ì˜¤ëŠ˜ (${today})</button>
        <button onclick="attTab='tomorrow';render()" class="px-4 py-2 rounded-xl ${attTab==='tomorrow'?'bg-indigo-600 text-white':'bg-white border'}">ë‚´ì¼ (${tomorrow})</button>
      </div>
      <button onclick="openSmsModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl ${selCount===0?'opacity-50':''}">ğŸ“± ë¬¸ìë³´ë‚´ê¸° (${selCount})</button>
    </div>`;

    h += '<div class="bg-white rounded-2xl border p-4">';
    if(list.length){
      h += '<div class="space-y-2">';
      list.forEach(s=>{
        const time = getStudentTime(s, dayLabel);
        const checked = attTab==='today' && attendance[s.id];
        const selected = selectedStudents[s.id];
        h += `<div class="flex items-center gap-3 p-4 rounded-xl border-2 ${checked?'border-emerald-500 bg-emerald-50':'border-gray-200'}">
          <input type="checkbox" ${selected?'checked':''} onchange="toggleSelect('${s.id}')" class="w-5 h-5" title="ë¬¸ì ì„ íƒ">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold ${checked?'bg-emerald-500 text-white':'bg-gray-100'}">
            ${s.name?.[0]||'?'}
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-medium">${s.name}</span>
              ${attTab==='today' ? `<button onclick="toggleAtt('${s.id}')" class="px-3 py-1 text-xs rounded-lg ${checked?'bg-emerald-100 text-emerald-700':'bg-gray-200 text-gray-600'}">${checked?'âœ“ ì¶œì„ì™„ë£Œ':'ì¶œì„'}</button>` : ''}
            </div>
            <div class="text-sm text-gray-500">${s.course||''} Â· ${time}</div>
          </div>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<p class="text-center text-gray-400 py-8">ìˆ˜ì—… ì—†ìŒ</p>';
    }
    h += '</div>';
  }

  // ìˆ˜ê°•ë£Œ
  else if(tab==='payments'){
    const total = students.reduce((a,s)=>a+(s.fee||0),0);
    const paidAmt = students.filter(s=>s.paid).reduce((a,s)=>a+(s.fee||0),0);
    const unpaidList = students.filter(s=>!s.paid);

    h += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ì˜ˆìƒë§¤ì¶œ</div><div class="text-2xl font-bold">${fmt(total)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ìˆ˜ë‚©ì™„ë£Œ</div><div class="text-2xl font-bold text-emerald-600">${fmt(paidAmt)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ë¯¸ìˆ˜ê¸ˆ</div><div class="text-2xl font-bold text-red-600">${fmt(total-paidAmt)}</div></div>
      <div class="bg-white rounded-2xl p-5 border"><div class="text-sm text-gray-500">ìˆ˜ë‚©ë¥ </div><div class="text-2xl font-bold text-indigo-600">${total?Math.round(paidAmt/total*100):0}%</div></div>
    </div>`;

    h += '<div class="bg-white rounded-2xl border">';
    h += `<div class="px-4 py-3 border-b flex justify-between"><span class="font-bold">ë¯¸ë‚© ì›ìƒ</span><span class="text-red-600">${unpaidList.length}ëª…</span></div>`;
    unpaidList.forEach(s=>{
      h += `<div class="flex items-center justify-between px-4 py-3 border-b">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 bg-red-100 text-red-600 rounded-full flex items-center justify-center">${s.name?.[0]||'?'}</div>
          <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-bold">${fmt(s.fee||0)}</span>
          <button onclick="markPaid('${s.id}')" class="px-3 py-1 bg-emerald-600 text-white text-sm rounded-lg">ìˆ˜ë‚©</button>
        </div>
      </div>`;
    });
    if(!unpaidList.length) h += '<p class="text-center text-gray-400 py-8">ğŸ‰ ë¯¸ë‚© ì—†ìŒ</p>';
    h += '</div>';
  }

  // ê³µì§€ì‚¬í•­
  else if(tab==='notices'){
    h += `<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">ğŸ“¢ ê³µì§€ì‚¬í•­</h2><button onclick="addNotice()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">+ ìƒˆ ê³µì§€</button></div>`;
    notices.forEach(n=>{
      h += `<div class="bg-white rounded-2xl border p-5 mb-3">
        <div class="flex justify-between"><h3 class="font-bold">${n.title}</h3><button onclick="deleteNotice('${n.id}')" class="text-gray-400">âœ•</button></div>
        <p class="text-sm text-gray-500 mt-1">${new Date(n.created_at).toLocaleDateString('ko-KR')}</p>
        <p class="mt-2">${n.content||''}</p>
      </div>`;
    });
    if(!notices.length) h += '<p class="text-gray-400 text-center py-8">ê³µì§€ì‚¬í•­ ì—†ìŒ</p>';
  }

  // ìƒë‹´
  else if(tab==='consult'){
    h += '<h2 class="text-xl font-bold mb-4">ğŸ’¬ ìƒë‹´ ê´€ë¦¬</h2>';
    if(consults.length){
      consults.forEach(c=>{
        const stu = students.find(s=>s.id===c.student_id);
        h += `<div class="bg-white rounded-2xl border p-5 mb-3 ${c.status==='ëŒ€ê¸°'?'border-l-4 border-l-red-500':''}">
          <div class="flex justify-between mb-2"><span class="font-medium">${stu?.name||'ì•Œìˆ˜ì—†ìŒ'}</span><span class="text-xs px-2 py-1 rounded-full ${c.status==='ëŒ€ê¸°'?'bg-red-100 text-red-600':'bg-emerald-100 text-emerald-600'}">${c.status}</span></div>
          <div class="p-3 bg-gray-50 rounded-xl mb-3">${c.message||''}</div>
          ${c.reply?`<div class="p-3 bg-indigo-50 rounded-xl"><span class="text-xs text-indigo-600">ë‹µë³€</span><p class="mt-1">${c.reply}</p></div>`:`<textarea id="reply${c.id}" class="w-full p-3 border rounded-xl mb-2" placeholder="ë‹µë³€ ì…ë ¥"></textarea><button onclick="sendReply('${c.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">ë‹µë³€</button>`}
        </div>`;
      });
    } else {
      h += '<p class="text-gray-400 text-center py-8">ìƒë‹´ ë‚´ì—­ ì—†ìŒ</p>';
    }
  }

  // ê³¼ì œê´€ë¦¬
  else if(tab==='homework'){
    h += '<h2 class="text-xl font-bold mb-4">ğŸ“ ê³¼ì œ ê´€ë¦¬</h2>';
    h += '<div class="grid md:grid-cols-2 gap-4">';
    students.forEach(s=>{
      const sHw = homework.filter(hw=>hw.student_id===s.id);
      h += `<div class="bg-white rounded-2xl border p-5">
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
            <div><div class="font-medium">${s.name}</div><div class="text-xs text-gray-500">${s.course||''}</div></div>
          </div>
          <button onclick="addHomework('${s.id}')" class="text-indigo-600 text-sm">+ê³¼ì œ</button>
        </div>`;
      if(sHw.length){
        sHw.forEach(hw=>{
          h += `<div class="p-2 bg-gray-50 rounded-lg text-sm flex items-center gap-2 mb-1">
            <input type="checkbox" ${hw.done?'checked':''} onchange="toggleHomework('${hw.id}')" class="w-4 h-4">
            <span class="${hw.done?'line-through text-gray-400':''}">${hw.title}</span>
            <button onclick="deleteHomework('${hw.id}')" class="ml-auto text-gray-400 hover:text-red-500">âœ•</button>
          </div>`;
        });
      } else {
        h += '<p class="text-gray-400 text-sm text-center py-2">ê³¼ì œ ì—†ìŒ</p>';
      }
      h += '</div>';
    });
    h += '</div>';
  }

  // ë¬¸ì„œí…œí”Œë¦¿
  else if(tab==='documents'){
    const cats = [...new Set(docs.map(d=>d.cat))];
    h += `<div class="bg-gradient-to-r from-violet-500 to-purple-600 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ“„ ë¬¸ì„œ í…œí”Œë¦¿ (23ì¢…)</h3>
      <p class="text-violet-100">ì›ìƒ ì •ë³´ ìë™ ì…ë ¥ + ì§ì ‘ í¸ì§‘ ê°€ëŠ¥</p>
    </div>`;
    h += '<div class="bg-white rounded-2xl border p-5">';
    h += `<div class="mb-4"><label class="text-sm font-medium">ì›ìƒ ì„ íƒ</label>
      <select id="docStudent" onchange="docStudentId=this.value" class="ml-2 px-3 py-2 border rounded-xl">
        <option value="">ì„ íƒì•ˆí•¨</option>`;
    students.forEach(s=>{h+=`<option value="${s.id}">${s.name}</option>`;});
    h += '</select></div>';
    cats.forEach(cat=>{
      h += `<div class="mb-4"><h4 class="text-sm font-bold text-gray-500 mb-2">${cat}</h4><div class="grid grid-cols-3 sm:grid-cols-5 gap-2">`;
      docs.filter(d=>d.cat===cat).forEach(d=>{
        h += `<button onclick="openDoc(${d.id})" class="p-3 bg-gray-50 rounded-xl hover:bg-indigo-50 text-center"><span class="text-2xl">${d.icon}</span><div class="text-xs mt-1">${d.name}</div></button>`;
      });
      h += '</div></div>';
    });
    h += '</div>';
  }

  // ìˆ˜ì—…ì‚¬ì§„ (Pro)
  else if(tab==='photos'){
    const thisMonth = photos.filter(p => {
      const d = new Date(p.created_at);
      const now = new Date();
      return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    
    h += `<div class="bg-gradient-to-r from-pink-500 to-rose-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">ğŸ“¸ ìˆ˜ì—… ì‚¬ì§„</h3><p class="text-pink-100">í•™ë¶€ëª¨ì—ê²Œ ìˆ˜ì—… ëª¨ìŠµì„ ê³µìœ í•˜ì„¸ìš”</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${thisMonth.length}/50</div><div class="text-pink-100">ì´ë²ˆë‹¬ ì—…ë¡œë“œ</div></div>
      </div>
    </div>`;
    
    h += `<div class="bg-white rounded-2xl border p-5 mb-4">
      <div class="flex flex-wrap gap-3 items-center mb-4">
        <select id="photoStudent" onchange="photoStudentId=this.value" class="px-4 py-2 border rounded-xl">
          <option value="">ì›ìƒ ì„ íƒ</option>`;
    students.forEach(s => { h += `<option value="${s.id}">${s.name}</option>`; });
    h += `</select>
        <label class="flex-1 min-w-[200px]">
          <div class="px-4 py-3 bg-indigo-600 text-white rounded-xl text-center cursor-pointer hover:bg-indigo-700">
            ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ
          </div>
          <input type="file" accept="image/*" onchange="uploadPhoto(this)" class="hidden">
        </label>
      </div>
      <p class="text-sm text-gray-500">ğŸ’¡ ì‚¬ì§„ì€ ìë™ìœ¼ë¡œ 1200pxë¡œ ë¦¬ì‚¬ì´ì¦ˆë˜ë©°, ì›” 50ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    </div>`;
    
    // ì‚¬ì§„ ê°¤ëŸ¬ë¦¬
    if(photos.length){
      h += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">';
      photos.forEach(p => {
        const stu = students.find(s => s.id === p.student_id);
        const date = new Date(p.created_at).toLocaleDateString('ko-KR');
        h += `<div class="bg-white rounded-xl border overflow-hidden group relative">
          <img src="${p.url}" class="w-full h-40 object-cover">
          <div class="p-3">
            <div class="font-medium text-sm">${stu?.name || 'ì „ì²´'}</div>
            <div class="text-xs text-gray-500">${date}</div>
            ${p.caption ? `<div class="text-xs text-gray-600 mt-1">${p.caption}</div>` : ''}
          </div>
          <button onclick="deletePhoto('${p.id}')" class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">âœ•</button>
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<div class="text-center py-12 text-gray-400"><div class="text-4xl mb-3">ğŸ“·</div><p>ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  }

  // í•™ìŠµ ë¦¬í¬íŠ¸ (Pro)
  else if(tab==='reports'){
    const currentMonth = new Date().toISOString().slice(0,7);
    
    h += `<div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ“ˆ í•™ìŠµ ë¦¬í¬íŠ¸</h3>
      <p class="text-blue-100">ì›”ë³„ í•™ìŠµ í˜„í™©ì„ í•™ë¶€ëª¨ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”</p>
    </div>`;
    
    h += '<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">';
    students.forEach(s => {
      const sReports = reports.filter(r => r.student_id === s.id);
      const hasThisMonth = sReports.some(r => r.month === currentMonth);
      const attCount = Object.keys(attendance).filter(k => attendance[k] && k === s.id).length;
      
      h += `<div class="bg-white rounded-2xl border p-5">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-xl font-bold">${s.name?.[0]||'?'}</div>
          <div><div class="font-bold">${s.name}</div><div class="text-sm text-gray-500">${s.course||''}</div></div>
        </div>
        <div class="flex items-center justify-between text-sm mb-3">
          <span>ì¶œì„ í¬ì¸íŠ¸</span><span class="font-bold text-blue-600">${s.points||0}ì </span>
        </div>
        <div class="flex gap-2">
          ${hasThisMonth 
            ? `<span class="flex-1 py-2 bg-emerald-100 text-emerald-700 rounded-xl text-center text-sm">âœ“ ì´ë²ˆë‹¬ ì‘ì„±ì™„ë£Œ</span>`
            : `<button onclick="openReportModal('${s.id}')" class="flex-1 py-2 bg-blue-600 text-white rounded-xl text-sm">ë¦¬í¬íŠ¸ ì‘ì„±</button>`
          }
        </div>
      </div>`;
    });
    h += '</div>';
  }

  // ë³´ê°• ì‹ ì²­ (Pro)
  else if(tab==='makeups'){
    h += `<div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl p-6 text-white mb-6">
      <div class="flex justify-between items-center">
        <div><h3 class="text-xl font-bold">ğŸ”„ ë³´ê°• ì‹ ì²­</h3><p class="text-amber-100">í•™ë¶€ëª¨ê°€ ì‹ ì²­í•œ ë³´ê°•ì„ ê´€ë¦¬í•˜ì„¸ìš”</p></div>
        <div class="text-right"><div class="text-3xl font-bold">${pendingMakeups.length}</div><div class="text-amber-100">ëŒ€ê¸°ì¤‘</div></div>
      </div>
    </div>`;
    
    if(makeups.length){
      h += '<div class="space-y-3">';
      makeups.forEach(m => {
        const stu = students.find(s => s.id === m.student_id);
        const statusColor = m.status === 'ëŒ€ê¸°' ? 'bg-amber-100 text-amber-700' : m.status === 'ìŠ¹ì¸' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700';
        h += `<div class="bg-white rounded-2xl border p-5 ${m.status==='ëŒ€ê¸°'?'border-l-4 border-l-amber-500':''}">
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="font-bold">${stu?.name||'ì•Œìˆ˜ì—†ìŒ'}</div>
              <div class="text-sm text-gray-500">${m.original_date} ìˆ˜ì—… â†’ ${m.request_date||'ë¯¸ì •'}</div>
            </div>
            <span class="px-3 py-1 rounded-full text-sm ${statusColor}">${m.status}</span>
          </div>
          ${m.reason ? `<p class="text-sm text-gray-600 mb-3">ì‚¬ìœ : ${m.reason}</p>` : ''}
          ${m.status === 'ëŒ€ê¸°' ? `
            <div class="flex gap-2">
              <button onclick="handleMakeup('${m.id}','ìŠ¹ì¸')" class="flex-1 py-2 bg-emerald-600 text-white rounded-xl text-sm">ìŠ¹ì¸</button>
              <button onclick="handleMakeup('${m.id}','ê±°ì ˆ')" class="flex-1 py-2 bg-red-500 text-white rounded-xl text-sm">ê±°ì ˆ</button>
            </div>
          ` : ''}
        </div>`;
      });
      h += '</div>';
    } else {
      h += '<div class="text-center py-12 text-gray-400"><div class="text-4xl mb-3">ğŸ”„</div><p>ë³´ê°• ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }
  }

  // ì±„íŒ… (Pro)
  else if(tab==='chat'){
    h += `<div class="bg-gradient-to-r from-violet-500 to-purple-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h3>
      <p class="text-violet-100">í•™ë¶€ëª¨ì™€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì†Œí†µí•˜ì„¸ìš”</p>
    </div>`;
    
    h += `<div class="flex gap-4" style="height: calc(100vh - 350px);">
      <div class="w-64 bg-white rounded-2xl border overflow-hidden flex flex-col">
        <div class="p-3 border-b font-bold text-sm">ì›ìƒ ì„ íƒ</div>
        <div class="flex-1 overflow-y-auto">`;
    students.forEach(s => {
      const unread = chats.filter(c => c.student_id === s.id && c.sender === 'parent').length;
      h += `<button onclick="chatStudentId='${s.id}';render()" class="w-full p-3 text-left hover:bg-gray-50 border-b flex items-center gap-2 ${chatStudentId===s.id?'bg-indigo-50':''}">
        <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">${s.name?.[0]||'?'}</div>
        <div class="flex-1"><div class="font-medium text-sm">${s.name}</div></div>
        ${unread ? `<span class="w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">${unread}</span>` : ''}
      </button>`;
    });
    h += `</div></div>
      <div class="flex-1 bg-white rounded-2xl border flex flex-col overflow-hidden">`;
    
    if(chatStudentId){
      const stu = students.find(s => s.id === chatStudentId);
      const studentChats = chats.filter(c => c.student_id === chatStudentId);
      h += `<div class="p-4 border-b font-bold">${stu?.name||''} ì±„íŒ…</div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="chatMessages">`;
      studentChats.forEach(c => {
        const isMe = c.sender === 'admin';
        h += `<div class="flex ${isMe?'justify-end':'justify-start'}">
          <div class="max-w-[70%] p-3 rounded-2xl ${isMe?'bg-indigo-600 text-white':'bg-gray-100'}">${c.message}</div>
        </div>`;
      });
      h += `</div>
        <div class="p-4 border-t flex gap-2">
          <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." class="flex-1 px-4 py-2 border rounded-xl" onkeypress="if(event.key==='Enter')sendChat()">
          <button onclick="sendChat()" class="px-6 py-2 bg-indigo-600 text-white rounded-xl">ì „ì†¡</button>
        </div>`;
    } else {
      h += '<div class="flex-1 flex items-center justify-center text-gray-400">ì›ìƒì„ ì„ íƒí•˜ì„¸ìš”</div>';
    }
    h += '</div></div>';
  }

  // ì¶œì„ í¬ì¸íŠ¸ (Pro)
  else if(tab==='points'){
    const sortedStudents = [...students].sort((a,b) => (b.points||0) - (a.points||0));
    
    h += `<div class="bg-gradient-to-r from-yellow-500 to-amber-500 rounded-2xl p-6 text-white mb-6">
      <h3 class="text-xl font-bold">ğŸ† ì¶œì„ í¬ì¸íŠ¸ & ë­í‚¹</h3>
      <p class="text-yellow-100">ì¶œì„í•  ë•Œë§ˆë‹¤ í¬ì¸íŠ¸ ì ë¦½! í•™ìƒë“¤ì˜ ë™ê¸° ë¶€ì—¬</p>
    </div>`;
    
    h += `<div class="bg-white rounded-2xl border p-5 mb-4">
      <h4 class="font-bold mb-3">í¬ì¸íŠ¸ ì„¤ì •</h4>
      <div class="flex gap-4 text-sm">
        <div class="flex items-center gap-2"><span>ì¶œì„:</span><span class="font-bold text-indigo-600">+10ì </span></div>
        <div class="flex items-center gap-2"><span>ì§€ê°:</span><span class="font-bold text-amber-600">+5ì </span></div>
        <div class="flex items-center gap-2"><span>ê²°ì„:</span><span class="font-bold text-red-600">0ì </span></div>
      </div>
    </div>`;
    
    h += '<div class="bg-white rounded-2xl border overflow-hidden">';
    h += '<div class="p-4 border-b font-bold">ğŸ† ë­í‚¹</div>';
    sortedStudents.forEach((s, i) => {
      const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}`;
      const bgColor = i < 3 ? 'bg-amber-50' : '';
      h += `<div class="flex items-center gap-4 p-4 border-b ${bgColor}">
        <div class="w-8 text-center font-bold ${i<3?'text-2xl':''}">${medal}</div>
        <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold">${s.name?.[0]||'?'}</div>
        <div class="flex-1"><div class="font-medium">${s.name}</div><div class="text-sm text-gray-500">${s.course||''}</div></div>
        <div class="text-right">
          <div class="text-xl font-bold text-indigo-600">${s.points||0}</div>
          <div class="text-xs text-gray-500">í¬ì¸íŠ¸</div>
        </div>
        <button onclick="adjustPoints('${s.id}')" class="px-3 py-1 border rounded-lg text-sm">ì¡°ì •</button>
      </div>`;
    });
    h += '</div>';
  }

  // ì„¤ì •
  else if(tab==='settings'){
    h += `<div class="bg-white rounded-2xl border p-6 mb-4">
      <h2 class="font-bold mb-4">ğŸ« í•™ì› ì •ë³´</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div><label class="text-sm text-gray-600">í•™ì›ëª…</label><input type="text" id="setName" value="${academy.name||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">ì›ì¥ëª…</label><input type="text" id="setOwner" value="${academy.owner||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div class="md:col-span-2"><label class="text-sm text-gray-600">ì£¼ì†Œ</label><input type="text" id="setAddress" value="${academy.address||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
        <div><label class="text-sm text-gray-600">ì—°ë½ì²˜</label><input type="text" id="setPhone" value="${academy.phone||''}" class="w-full px-4 py-2 border rounded-xl mt-1"></div>
      </div>
      <button onclick="saveSettings()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-xl">ì €ì¥</button>
    </div>`;
  }

  h += '</div></main></div>';

  // ëª¨ë‹¬
  if(modal==='addStudent') h += renderStudentModal();
  if(modal==='sms') h += renderSmsModal();
  if(modal==='docPreview' && currentDoc) h += renderDocModal();
  if(modal==='report') h += renderReportModal();

  return h;
}

// ë¦¬í¬íŠ¸ ëª¨ë‹¬
function renderReportModal(){
  const s = students.find(x=>x.id===reportStudentId);
  const currentMonth = new Date().toLocaleDateString('ko-KR', {year:'numeric', month:'long'});
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';reportStudentId='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">ğŸ“ˆ ${s?.name||''} í•™ìŠµ ë¦¬í¬íŠ¸</span><button onclick="modal='';reportStudentId='';render()">âœ•</button></div>
      <div class="p-4 space-y-4">
        <div class="bg-blue-50 p-3 rounded-xl text-center">
          <div class="text-sm text-blue-600">${currentMonth}</div>
        </div>
        <div>
          <label class="text-sm font-medium">í•™ìŠµ ë‚´ìš© ë° í‰ê°€</label>
          <textarea id="reportContent" class="w-full p-3 border rounded-xl mt-1" rows="5" placeholder="ì´ë²ˆ ë‹¬ í•™ìŠµ ë‚´ìš©ê³¼ ì„±ì·¨ë„ë¥¼ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
        </div>
        <div>
          <label class="text-sm font-medium">ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</label>
          <textarea id="reportMemo" class="w-full p-3 border rounded-xl mt-1" rows="3" placeholder="í•™ë¶€ëª¨ë‹˜ê»˜ ì „ë‹¬í•  ë©”ì‹œì§€..."></textarea>
        </div>
        <div class="flex gap-2">
          <button onclick="modal='';reportStudentId='';render()" class="flex-1 py-3 border rounded-xl">ì·¨ì†Œ</button>
          <button onclick="saveReport()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ì›ìƒ ìƒì„¸
function renderStudentDetail(){
  const s = students.find(x=>x.id===viewStudentId);
  if(!s) return '<p>ì›ìƒ ì •ë³´ ì—†ìŒ</p>';
  const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d} ${t}`).join(', ') : (s.days||[]).join(' ')+' '+(s.time||'');
  
  let h = '<div class="max-w-2xl">';
  h += `<button onclick="viewStudentId=null;render()" class="mb-4 text-indigo-600">â† ëª©ë¡ìœ¼ë¡œ</button>`;
  
  h += `<div class="bg-white rounded-2xl border p-6 mb-4">
    <div class="flex items-center gap-4 mb-4">
      <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl font-bold">${s.name?.[0]||'?'}</div>
      <div><h2 class="text-xl font-bold">${s.name}</h2><p class="text-gray-500">${s.course||''} Â· ${s.level||''}</p></div>
      <button onclick="openEditStudent('${s.id}')" class="ml-auto px-4 py-2 border rounded-xl text-sm">ìˆ˜ì •</button>
    </div>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div><span class="text-gray-500">ì—°ë½ì²˜</span><div class="font-medium">${s.phone||'-'}</div></div>
      <div><span class="text-gray-500">í•™ë¶€ëª¨</span><div class="font-medium">${s.parent_phone||'-'}</div></div>
      <div><span class="text-gray-500">ìˆ˜ì—…ì¼ì •</span><div class="font-medium">${scheduleStr||'-'}</div></div>
      <div><span class="text-gray-500">ìˆ˜ê°•ë£Œ</span><div class="font-medium ${s.paid?'':'text-red-600'}">${fmt(s.fee||0)} (${s.paid?'ì™„ë£Œ':'ë¯¸ë‚©'})</div></div>
    </div>
  </div>`;

  // ë©”ëª¨
  h += `<div class="bg-white rounded-2xl border p-6 mb-4">
    <h3 class="font-bold mb-3">ğŸ“ ë©”ëª¨</h3>
    <textarea id="studentMemo" class="w-full p-3 border rounded-xl" rows="3" placeholder="ë©”ëª¨ ì…ë ¥...">${s.memo||''}</textarea>
    <button onclick="saveMemo('${s.id}')" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">ì €ì¥</button>
  </div>`;

  h += '</div>';
  return h;
}

// ì›ìƒ ëª¨ë‹¬
function renderStudentModal(){
  const s = editingId ? students.find(x=>x.id===editingId) : null;
  
  let h = `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){closeModal();}">
    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">${s?'ì›ìƒ ìˆ˜ì •':'ì›ìƒ ë“±ë¡'}</span><button onclick="closeModal()">âœ•</button></div>
      <div class="p-4 space-y-3">
        <input type="text" id="sName" value="${formData.name}" oninput="formData.name=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="ì´ë¦„ *">
        <input type="tel" id="sPhone" value="${formData.phone}" oninput="formData.phone=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="ì—°ë½ì²˜">
        <input type="tel" id="sPPhone" value="${formData.pPhone}" oninput="formData.pPhone=this.value" class="w-full px-4 py-2 border rounded-xl" placeholder="í•™ë¶€ëª¨ ì—°ë½ì²˜">
        <div class="grid grid-cols-2 gap-2">
          <input type="text" id="sCourse" value="${formData.course}" oninput="formData.course=this.value" class="px-4 py-2 border rounded-xl" placeholder="ê³¼ëª©">
          <input type="text" id="sLevel" value="${formData.level}" oninput="formData.level=this.value" class="px-4 py-2 border rounded-xl" placeholder="ë ˆë²¨">
        </div>
        <div class="bg-indigo-50 rounded-xl p-3">
          <div class="text-sm font-medium mb-2">ìˆ˜ì—… ì¼ì • (ìš”ì¼ë³„ ì‹œê°„)</div>
          <div class="space-y-2">`;
  ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].forEach(d=>{
    const hasDay = formData.schedule[d] !== undefined;
    const time = formData.schedule[d] || '16:00';
    h += `<div class="flex items-center gap-2">
      <button type="button" onclick="toggleDaySchedule('${d}')" class="w-10 h-10 rounded-lg text-sm font-bold ${hasDay?'bg-indigo-600 text-white':'bg-white border'}">${d}</button>
      ${hasDay ? `<input type="time" value="${time}" onchange="formData.schedule['${d}']=this.value" class="flex-1 px-3 py-2 border rounded-lg"><span class="text-xs text-gray-500">${d}ìš”ì¼</span>` : '<span class="text-gray-400 text-sm">ìˆ˜ì—… ì—†ìŒ</span>'}
    </div>`;
  });
  h += `</div></div>
        <input type="number" id="sFee" value="${formData.fee}" oninput="formData.fee=parseInt(this.value)||0" class="w-full px-4 py-2 border rounded-xl" placeholder="ìˆ˜ê°•ë£Œ">
        <label class="flex items-center gap-2"><input type="checkbox" id="sPaid" ${formData.paid?'checked':''} onchange="formData.paid=this.checked" class="w-5 h-5">ë‚©ë¶€ì™„ë£Œ</label>
        <div class="flex gap-2">
          <button onclick="closeModal()" class="flex-1 py-2 border rounded-xl">ì·¨ì†Œ</button>
          ${editingId ? `<button onclick="deleteStudent('${editingId}')" class="py-2 px-4 bg-red-500 text-white rounded-xl">ì‚­ì œ</button>` : ''}
          <button onclick="saveStudent()" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl">${s?'ìˆ˜ì •':'ë“±ë¡'}</button>
        </div>
      </div>
    </div>
  </div>`;
  return h;
}

// SMS ëª¨ë‹¬
function renderSmsModal(){
  const selIds = Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  const selStudents = selIds.map(id=>students.find(s=>s.id===id)).filter(Boolean);
  const defaultMsg = `[${academy.name}]\n\nì•ˆë…•í•˜ì„¸ìš”.\n\n${selStudents.map(s=>s.name).join(', ')} í•™ìƒ ì¶œì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.`;
  
  return `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';render();}">
    <div class="bg-white rounded-2xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between"><span class="font-bold">ğŸ“± ë¬¸ì ë³´ë‚´ê¸°</span><button onclick="modal='';render()">âœ•</button></div>
      <div class="p-4">
        <div class="mb-3"><span class="text-sm text-gray-500">ë°›ëŠ” ì‚¬ëŒ</span>
          <div class="flex flex-wrap gap-1 mt-1">${selStudents.map(s=>`<span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">${s.name}</span>`).join('')}</div>
        </div>
        <div class="mb-3"><span class="text-sm text-gray-500">ë‚´ìš©</span><textarea id="smsContent" class="w-full p-3 border rounded-xl mt-1" rows="6">${defaultMsg}</textarea></div>
        <button onclick="sendSMS()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">ë³´ë‚´ê¸°</button>
      </div>
    </div>
  </div>`;
}

// ë¬¸ì„œ ëª¨ë‹¬
function renderDocModal(){
  const d = currentDoc;
  const s = docStudentId ? students.find(x=>x.id===docStudentId) : null;
  const content = getDocContent(d, s);
  
  return `<div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){modal='';currentDoc=null;render();}">
    <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[95vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <span class="font-bold">${d.icon} ${d.name}</span>
        <div class="flex gap-2">
          <button onclick="window.print()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm">ğŸ–¨ï¸ ì¸ì‡„</button>
          <button onclick="modal='';currentDoc=null;render()" class="px-4 py-2 bg-gray-200 rounded-xl">âœ•</button>
        </div>
      </div>
      <div class="p-2 bg-amber-50 text-amber-800 text-sm text-center">ğŸ’¡ ë¬¸ì„œë¥¼ í´ë¦­í•˜ì—¬ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      <div class="flex-1 overflow-y-auto bg-gray-300 p-6 print-area">
        <div id="docContent" contenteditable="true" class="bg-white shadow-xl mx-auto cursor-text" style="width:210mm;min-height:297mm;padding:20mm;">${content}</div>
      </div>
    </div>
  </div>`;
}

function getDocContent(doc, stu){
  const s = stu || {name:'___________',course:'___________',level:'___',phone:'_______________',fee:0};
  const a = academy;
  const header = `<div style="border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:30px;text-align:center;"><div style="font-size:16pt;font-weight:bold;">${a.name}</div><div style="font-size:9pt;color:#666;">${a.address||''} | Tel: ${a.phone||''}</div></div>`;
  const footer = `<div style="margin-top:80px;text-align:center;"><p>${todayStr}</p><p style="font-size:14pt;font-weight:bold;margin-top:30px;">${a.name}</p><p>ì›ì¥ ${a.owner} (ì¸)</p></div>`;
  
  if(doc.name==='ì¬ì›ì¦ëª…ì„œ') return header+`<h1 style="text-align:center;font-size:24pt;letter-spacing:10px;margin:50px 0;">ì¬ ì› ì¦ ëª… ì„œ</h1><table style="width:100%;border-collapse:collapse;margin:30px 0;"><tr><td style="border:1px solid #333;padding:12px;width:25%;background:#f5f5f5;font-weight:bold;">ì„± ëª…</td><td style="border:1px solid #333;padding:12px;">${s.name}</td></tr><tr><td style="border:1px solid #333;padding:12px;background:#f5f5f5;font-weight:bold;">ìˆ˜ê°•ê³¼ëª©</td><td style="border:1px solid #333;padding:12px;">${s.course||''}</td></tr><tr><td style="border:1px solid #333;padding:12px;background:#f5f5f5;font-weight:bold;">ë ˆ ë²¨</td><td style="border:1px solid #333;padding:12px;">${s.level||''}</td></tr></table><div style="text-align:center;margin:60px 0;font-size:14pt;">ìœ„ í•™ìƒì€ ë³¸ í•™ì›ì— ì¬ì› ì¤‘ì„ì„ ì¦ëª…í•©ë‹ˆë‹¤.</div>`+footer;
  
  if(doc.name==='ìˆ˜ê°•ë£Œì˜ìˆ˜ì¦') return header+`<h1 style="text-align:center;font-size:24pt;letter-spacing:10px;margin:50px 0;">ì˜ ìˆ˜ ì¦</h1><div style="text-align:center;margin:40px 0;padding:30px;border:3px solid #333;"><p>ê¸ˆ ì•¡</p><p style="font-size:28pt;font-weight:bold;color:#c00;">${(s.fee||0).toLocaleString()}ì›</p></div><table style="width:100%;border-collapse:collapse;"><tr><td style="border:1px solid #333;padding:12px;width:25%;background:#f5f5f5;">ë‚´ ìš©</td><td style="border:1px solid #333;padding:12px;">${s.course||''} ìˆ˜ê°•ë£Œ</td></tr><tr><td style="border:1px solid #333;padding:12px;background:#f5f5f5;">ì› ìƒ</td><td style="border:1px solid #333;padding:12px;">${s.name}</td></tr></table><p style="text-align:center;margin:50px 0;">ìœ„ ê¸ˆì•¡ì„ ì •íˆ ì˜ìˆ˜í•¨.</p>`+footer;
  
  return header+`<h1 style="text-align:center;font-size:22pt;margin:50px 0;">${doc.name}</h1><p style="text-align:center;color:#666;margin:30px 0;">ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>`+footer;
}

// í•¨ìˆ˜ë“¤
function openAddStudent(){
  editingId = null;
  formData = {name:'',phone:'',pPhone:'',course:'',level:'',fee:200000,paid:false,schedule:{},memo:''};
  modal = 'addStudent';
  render();
}

function openEditStudent(id){
  const s = students.find(x=>x.id===id);
  if(!s) return;
  editingId = id;
  formData = {
    name: s.name || '',
    phone: s.phone || '',
    pPhone: s.parent_phone || '',
    course: s.course || '',
    level: s.level || '',
    fee: s.fee || 200000,
    paid: s.paid || false,
    schedule: s.schedule || {},
    memo: s.memo || ''
  };
  if(!s.schedule && s.days && s.days.length){
    formData.schedule = {};
    s.days.forEach(d => { formData.schedule[d] = s.time || '16:00'; });
  }
  modal = 'addStudent';
  render();
}

function closeModal(){
  modal = '';
  editingId = null;
  render();
}

function toggleDaySchedule(d){
  if(formData.schedule[d] !== undefined){
    delete formData.schedule[d];
  } else {
    formData.schedule[d] = '16:00';
  }
  render();
}

async function saveStudent(){
  if(!formData.name){alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  const data = {
    academy_id: academy.id,
    name: formData.name,
    phone: formData.phone,
    parent_phone: formData.pPhone,
    course: formData.course,
    level: formData.level,
    fee: formData.fee,
    paid: formData.paid,
    schedule: formData.schedule,
    days: Object.keys(formData.schedule),
    time: Object.values(formData.schedule)[0] || '',
    memo: formData.memo
  };
  loading=true;render();
  if(editingId){
    await db.from('students').update(data).eq('id',editingId);
  } else {
    await db.from('students').insert(data);
  }
  await loadData();
  modal='';editingId=null;
  loading=false;render();
}

async function deleteStudent(id){
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  loading=true;render();
  await db.from('students').delete().eq('id',id);
  await loadData();
  modal='';editingId=null;viewStudentId=null;
  loading=false;render();
}

async function saveMemo(id){
  const memo = document.getElementById('studentMemo').value;
  await db.from('students').update({memo}).eq('id',id);
  const s = students.find(x=>x.id===id);
  if(s) s.memo = memo;
  alert('ì €ì¥ ì™„ë£Œ!');
}

async function toggleAtt(id){
  const exists = attendance[id];
  if(exists){
    await db.from('attendance').delete().eq('student_id',id).eq('date',todayISO);
    // í¬ì¸íŠ¸ ì°¨ê°
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: Math.max(0, (s.points || 0) - 10) }).eq('id', id);
    }
    delete attendance[id];
  } else {
    await db.from('attendance').insert({student_id:id,date:todayISO,status:'ì¶œì„'});
    // í¬ì¸íŠ¸ ì¶”ê°€
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: (s.points || 0) + 10 }).eq('id', id);
    }
    attendance[id]='ì¶œì„';
  }
  await loadData();
  render();
}

function toggleSelect(id){selectedStudents[id]=!selectedStudents[id];render();}

async function markPaid(id){
  await db.from('students').update({paid:true,paid_date:todayISO}).eq('id',id);
  await loadData();
  render();
}

async function addTodo(){
  const text=prompt('í•  ì¼:');
  if(!text)return;
  await db.from('todos').insert({academy_id:academy.id,text});
  await loadData();
  render();
}

async function toggleTodo(id){
  const t=todos.find(x=>x.id===id);
  if(t){
    await db.from('todos').update({done:!t.done}).eq('id',id);
    await loadData();
    render();
  }
}

async function deleteTodo(id){
  await db.from('todos').delete().eq('id',id);
  await loadData();
  render();
}

async function addNotice(){
  const title=prompt('ê³µì§€ ì œëª©:');
  if(!title)return;
  const content=prompt('ë‚´ìš©:')||'';
  await db.from('notices').insert({academy_id:academy.id,title,content});
  await loadData();
  render();
}

async function deleteNotice(id){
  if(confirm('ì‚­ì œ?')){
    await db.from('notices').delete().eq('id',id);
    await loadData();
    render();
  }
}

async function sendReply(id){
  const el=document.getElementById('reply'+id);
  if(!el||!el.value)return;
  await db.from('consults').update({reply:el.value,status:'ì™„ë£Œ'}).eq('id',id);
  await loadData();
  render();
}

async function addHomework(studentId){
  const title=prompt('ê³¼ì œ:');
  if(!title)return;
  await db.from('homework').insert({student_id:studentId,title});
  await loadData();
  render();
}

async function toggleHomework(id){
  const hw=homework.find(x=>x.id===id);
  if(hw){
    await db.from('homework').update({done:!hw.done}).eq('id',id);
    await loadData();
    render();
  }
}

async function deleteHomework(id){
  await db.from('homework').delete().eq('id',id);
  await loadData();
  render();
}

function openDoc(id){
  currentDoc = docs.find(d=>d.id===id);
  modal = 'docPreview';
  render();
}

function openSmsModal(){
  const sel=Object.keys(selectedStudents).filter(k=>selectedStudents[k]);
  if(!sel.length){alert('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”');return;}
  modal='sms';render();
}

function sendSMS(){
  const content=document.getElementById('smsContent').value;
  alert('ë¬¸ì ë°œì†¡!\n(ì‹¤ì œ ë°œì†¡ì€ Aligo ì—°ë™ í•„ìš”)\n\n'+content);
  modal='';selectedStudents={};render();
}

async function saveSettings(){
  const data = {
    name: document.getElementById('setName').value,
    owner: document.getElementById('setOwner').value,
    address: document.getElementById('setAddress').value,
    phone: document.getElementById('setPhone').value
  };
  await db.from('academies').update(data).eq('id',academy.id);
  academy = {...academy,...data};
  alert('ì €ì¥ ì™„ë£Œ!');
  render();
}

function downloadExcel(){
  const data=students.map(s=>{
    const scheduleStr = s.schedule ? Object.entries(s.schedule).map(([d,t])=>`${d}${t}`).join(' ') : '';
    return {ì´ë¦„:s.name,ì—°ë½ì²˜:s.phone,ê³¼ëª©:s.course,ë ˆë²¨:s.level,ìˆ˜ê°•ë£Œ:s.fee,ë‚©ë¶€:s.paid?'ì™„ë£Œ':'ë¯¸ë‚©',ìˆ˜ì—…ì¼ì •:scheduleStr};
  });
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'ì›ìƒ');
  XLSX.writeFile(wb,'ì›ìƒëª©ë¡.xlsx');
}

// ì‚¬ì§„ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜
function resizeImage(file, maxWidth = 1200) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob((blob) => {
          resolve(blob);
        }, 'image/jpeg', 0.8);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ì‚¬ì§„ ì—…ë¡œë“œ
async function uploadPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  
  // ì›” ì—…ë¡œë“œ ì œí•œ ì²´í¬
  const thisMonth = photos.filter(p => {
    const d = new Date(p.created_at);
    const now = new Date();
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
  
  if (thisMonth.length >= 50) {
    alert('ì›” 50ì¥ ì—…ë¡œë“œ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!photoStudentId) {
    alert('ì›ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    return;
  }
  
  loading = true;
  render();
  
  try {
    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
    const resizedBlob = await resizeImage(file);
    
    // Supabase Storage ì—…ë¡œë“œ
    const fileName = `${academy.id}/${Date.now()}.jpg`;
    const { data: uploadData, error: uploadError } = await db.storage
      .from('photos')
      .upload(fileName, resizedBlob, { contentType: 'image/jpeg' });
    
    if (uploadError) {
      // Storage ë²„í‚·ì´ ì—†ìœ¼ë©´ Base64ë¡œ ì €ì¥ (ëŒ€ì•ˆ)
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64 = e.target.result;
        const caption = prompt('ì‚¬ì§„ ì„¤ëª… (ì„ íƒ):') || '';
        
        await db.from('photos').insert({
          academy_id: academy.id,
          student_id: photoStudentId,
          url: base64,
          caption
        });
        
        await loadData();
        loading = false;
        photoStudentId = '';
        render();
        alert('ì—…ë¡œë“œ ì™„ë£Œ!');
      };
      reader.readAsDataURL(resizedBlob);
      return;
    }
    
    // ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
    const { data: urlData } = db.storage.from('photos').getPublicUrl(fileName);
    const caption = prompt('ì‚¬ì§„ ì„¤ëª… (ì„ íƒ):') || '';
    
    await db.from('photos').insert({
      academy_id: academy.id,
      student_id: photoStudentId,
      url: urlData.publicUrl,
      caption
    });
    
    await loadData();
    loading = false;
    photoStudentId = '';
    render();
    alert('ì—…ë¡œë“œ ì™„ë£Œ!');
    
  } catch (err) {
    console.error(err);
    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
    loading = false;
    render();
  }
}

// ì‚¬ì§„ ì‚­ì œ
async function deletePhoto(id) {
  if (!confirm('ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  await db.from('photos').delete().eq('id', id);
  await loadData();
  render();
}

// í•™ìŠµ ë¦¬í¬íŠ¸ ëª¨ë‹¬
function openReportModal(studentId) {
  reportStudentId = studentId;
  modal = 'report';
  render();
}

// í•™ìŠµ ë¦¬í¬íŠ¸ ì €ì¥
async function saveReport() {
  const content = document.getElementById('reportContent').value;
  const memo = document.getElementById('reportMemo').value;
  const currentMonth = new Date().toISOString().slice(0,7);
  
  await db.from('reports').insert({
    student_id: reportStudentId,
    month: currentMonth,
    content,
    memo,
    attendance_rate: 90,
    homework_rate: 85
  });
  
  await loadData();
  modal = '';
  reportStudentId = '';
  render();
  alert('ë¦¬í¬íŠ¸ ì €ì¥ ì™„ë£Œ!');
}

// ë³´ê°• ì²˜ë¦¬
async function handleMakeup(id, status) {
  await db.from('makeups').update({ status }).eq('id', id);
  await loadData();
  render();
}

// ì±„íŒ… ì „ì†¡
async function sendChat() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message || !chatStudentId) return;
  
  await db.from('chats').insert({
    academy_id: academy.id,
    student_id: chatStudentId,
    sender: 'admin',
    message
  });
  
  input.value = '';
  await loadData();
  render();
  
  // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ
  setTimeout(() => {
    const chatDiv = document.getElementById('chatMessages');
    if (chatDiv) chatDiv.scrollTop = chatDiv.scrollHeight;
  }, 100);
}

// í¬ì¸íŠ¸ ì¡°ì •
async function adjustPoints(studentId) {
  const s = students.find(x => x.id === studentId);
  const current = s?.points || 0;
  const input = prompt(`${s.name}ì˜ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${current}ì )`, current);
  if (input === null) return;
  
  const newPoints = parseInt(input) || 0;
  await db.from('students').update({ points: newPoints }).eq('id', studentId);
  await loadData();
  render();
}

// ì¶œì„ ì‹œ í¬ì¸íŠ¸ ì¶”ê°€ (toggleAtt ìˆ˜ì •)
async function toggleAttWithPoints(id) {
  const exists = attendance[id];
  if (exists) {
    await db.from('attendance').delete().eq('student_id', id).eq('date', todayISO);
    // í¬ì¸íŠ¸ ì°¨ê°
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: Math.max(0, (s.points || 0) - 10) }).eq('id', id);
    }
    delete attendance[id];
  } else {
    await db.from('attendance').insert({ student_id: id, date: todayISO, status: 'ì¶œì„' });
    // í¬ì¸íŠ¸ ì¶”ê°€
    const s = students.find(x => x.id === id);
    if (s) {
      await db.from('students').update({ points: (s.points || 0) + 10 }).eq('id', id);
    }
    attendance[id] = 'ì¶œì„';
  }
  await loadData();
  render();
}

render();
</script>
</body>
</html>
